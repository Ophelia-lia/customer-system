<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC-æµ‹è¯•æœ</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #555;
            line-height: 1.6;
            padding-top: 60px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* å¤´éƒ¨æ ·å¼ - ä¿®æ”¹ä¸ºå›ºå®šå®šä½ */
        header {
            background: #ffffff; /* é›ªç™½è‰² */
            color: #333; /* æ–‡å­—é¢œè‰²æ”¹ä¸ºæ·±è‰² */
            padding: 20px 0;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 20px;
            font-weight: bold;
            color: #555;
            margin: 0;
        }
        
        /* å¯¼èˆªæ ·å¼ - ä¿®æ”¹ä¸ºå›ºå®šå®šä½ */
        .nav-tabs {
            display: none !important;
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            position: fixed;
            top: 90px;
            left: 0;
            right: 0;
            z-index: 999;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab.active {
            background-color: #f6f2f1;
            color: #787785;
            border-bottom: 3px solid #787785;
        }
        
        .nav-tab:hover:not(.active) {
            background-color: #f8f9fa;
        }
        
        /* é¡µé¢å†…å®¹æ ·å¼ */
        .page {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 10px 20px 20px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .page.active {
            display: block;
        }
        
        /* è¡¨æ ¼æ ·å¼ - è¡¨å¤´å–æ¶ˆåŠ ç²— */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: normal; /* å–æ¶ˆåŠ ç²— */
            color: #495057;
        }
        
        tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }

        /* æ·»åŠ é€‰ä¸­è¡Œçš„æ ·å¼ */
        tr.selected {
            background-color: #e9ecef;
            border-left: 3px solid #787785;
        }
        
        /* æŒ‰é’®æ ·å¼ - å¤´éƒ¨æŒ‰é’®ä½¿ç”¨å†·ç°ç²‰è‰²ç³» */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: #787785; /* å†·ç°ç²‰ */
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #6a6a78;
        }
        
        .btn-secondary {
            background-color: #DEB7B8; /* å†·ç°ç²‰ */
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #d1a9aa;
        }
        
        .btn-success {
            background-color: #F2D5D7; /* å†·ç°ç²‰ */
            color: #333;
        }
        
        .btn-success:hover {
            background-color: #e8c8ca;
        }
        
        .btn-danger {
            background-color: #FDEBEB; /* å†·ç°ç²‰ */
            color: #333;
        }
        
        .btn-danger:hover {
            background-color: #f5dddd;
        }
        
        .btn-warning {
            background-color: #F6F2F1; /* å†·ç°ç²‰ */
            color: #333;
        }
        
        .btn-warning:hover {
            background-color: #ede9e8;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* æ·»åŠ è®°å½•æŒ‰é’®æ ·å¼ - æµ…è“è‰²èƒŒæ™¯ï¼Œé»‘è‰²å­—ä½“ï¼Œä¸åŠ ç²— */
        .add-record-btn {
            background-color: #ECCEDF; /* æµ…ç«ç‘°ç²‰ */
            color: #333; /* é»‘è‰²å­—ä½“ */
            font-weight: normal; /* ä¸åŠ ç²— */
            border: 1px solid #ECCEDF;
        }
        
        .add-record-btn:hover {
            background-color: #009F73; /* æ£®æ—ç»¿ */

        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #787785;
            outline: none;
            box-shadow: 0 0 0 2px rgba(120, 119, 133, 0.25);
        }
        
        input[readonly] {
            background-color: #e9ecef;
            opacity: 1;
        }
        
        /* æ—¥æœŸå’Œæ•°å­—ä½¿ç”¨è“ç´«è‰²å­—ä½“ */
        input[type="date"], input[type="number"] {
            color: #0077be;
        }
        
        /* æœç´¢å’Œç­›é€‰åŒºåŸŸ */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .search-box, .filter-box {
            flex: 1;
            min-width: 150px; /* ç¼©çŸ­æœç´¢æ¡†å®½åº¦ */
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-btn.active {
            background-color: #787785;
            color: white;
            border-color: #787785;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            margin-top: 0px;
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
            position: sticky;
            top: 85px; /* å›ºå®šåœ¨é¡µé¢é¡¶éƒ¨ */
            background: white;
            z-index: 998;
            padding: 0;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
           font-size: 16px; 
            font-weight: 600; 
            color: #666;
        }
        
        .tab.active {
           border-bottom: 3px solid #492D22;
            color: #492D22;
            font-weight: bold;
            background-color: #f0f7ff;
        }
        
        .tab-content {
            padding: 20px 0;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* å³ä¸Šè§’å›¾æ ‡å®¹å™¨ */
        .header-icons {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px; /* å›¾æ ‡ä¹‹é—´çš„é—´è· */
            z-index: 1001;
        }

        /* é€šç”¨å›¾æ ‡æ ·å¼ */
        .header-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .header-icon:hover {
            background-color: #f1f1f1;
            color: #333;
        }

        /* ä¿å­˜å›¾æ ‡ç‰¹æœ‰æ ·å¼ (é¼ æ ‡æ‚¬åœå˜è“) */
        .header-icon.save-action:hover {
            color: #203F9A; 
            background-color: #eef2ff;
        }

        /* å…³é—­å›¾æ ‡ç‰¹æœ‰æ ·å¼ (é¼ æ ‡æ‚¬åœå˜çº¢) */
        .header-icon.close-action:hover {
            color: #dc3545;
            background-color: #fff5f5;
        }
        
        /* è´¢åŠ¡å›¾è¡¨æ ·å¼ */
        .finance-chart {
            height: 40px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
            cursor: pointer;
            position: relative;
        }
        
        .chart-segment {
            height: 100%;
            display: inline-block;
            float: left;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px; /* ä¿®æ”¹ï¼šå¢å¤§æ¨¡æ€æ¡†æœ€å¤§å®½åº¦ */
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        /* ä¿å­˜æç¤ºæ ·å¼ */
        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
        }
        
        .save-notification.show {
            opacity: 1;
        }
        
        /* æŒ‰é’®ç»„æ ·å¼ */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }
        
        .finance-button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }
        
        /* ä¸‰åˆ—å¸ƒå±€æ ·å¼ */
        .three-column-form {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }
        
        /* æŒ‡æ ‡å¯¹æ¯”è¡¨æ ¼æ ·å¼ */
        .indicators-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .indicators-table th, .indicators-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .indicators-table th {
            background-color: #f8f9fa;
            font-weight: normal; /* å–æ¶ˆåŠ ç²— */
        }
        
        /* è´¢åŠ¡ç»Ÿè®¡é¡µé¢æ ·å¼ */
        .finance-summary {
            margin-bottom: 20px;
        }
        
        .finance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .finance-table th, .finance-table td {
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        
        .finance-table th {
            background-color: #f8f9fa;
            font-weight: normal; /* å–æ¶ˆåŠ ç²— */
        }
        
        .finance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        /* å¥åº·å­—æ®µå¸ƒå±€ */
        .health-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .health-select {
            flex: 1;
        }
        
        .health-input {
            flex: 2;
        }
        
        /* æŠ˜å é¢æ¿æ ·å¼ */
        .collapse-panel {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .collapse-header {
            padding: 12px 15px;
            background-color: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        
        .collapse-content {
            padding: 15px;
            display: none;
        }
        
        .collapse-content.active {
            display: block;
        }
        
        .collapse-icon {
            transition: transform 0.3s ease;
        }
        
        .collapse-panel.active .collapse-icon {
            transform: rotate(180deg);
        }
        
        /* å›è®¿è®°å½•è¡¨æ ¼æ ·å¼ */
        .followup-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .followup-table th, .followup-table td {
            padding: 8px 10px;
            border: 1px solid #dee2e6;
        }
        
        .followup-table th {
            background-color: #f8f9fa;
            font-weight: normal; /* å–æ¶ˆåŠ ç²— */
        }
        
        /* è´¦æœŸé€‰æ‹©å™¨æ ·å¼ */
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .period-selector select {
            flex: 1;
            max-width: 300px;
        }
        
        /* ç‰¹å®šæ ‡é¢˜é¢œè‰² */
        #allergyHistoryContainer label,
        #medicationHistoryContainer label,
        #pastMedicalHistoryContainer label,
        #surgeryHospitalizationHistoryContainer label,
        #vaccinationHistoryContainer label,
        #familyHistoryContainer label,
        #dietaryHabitsContainer label,
        #physicalActivityContainer label,
        #sleepPatternContainer label,
        #abnormalIndicatorsContainer label,
        #communicationRecordsContainer label,
        #followUpRecordsContainer label {
            color: #2F2F2F;
            font-weight: 500;
        }
        
        /* åŠ å·å›¾æ ‡æ ·å¼ - ä¿®æ”¹ä¸ºç®€å•åŠ å·ï¼Œå»æ‰åœ†å½¢èƒŒæ™¯ */
        .add-icon {
            display: inline-block;
            color: #CC79A8; /* ç«ç‘°è‰² */
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            transition: color 0.2s ease;
            line-height: 1;
        }
        
        .add-icon:hover {
            color: #6a6a78;
        }
        
        /* æ ‡é¢˜å®¹å™¨æ ·å¼ */
        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        /* æŒ‡æ ‡å¯¹æ¯”æœç´¢æ ·å¼ */
        .indicators-search {
            margin-bottom: 20px;
        }
        
        /* å¯ç‚¹å‡»å•å…ƒæ ¼æ ·å¼ */
        .clickable-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .clickable-cell:hover {
            background-color: #e9ecef;
        }
        
        /* ä¿å­˜å›¾æ ‡æ ·å¼ */
        .save-icon {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #28a745;
            margin-left: 10px;
        }
        
        /* æ­£å¸¸å€¼æ ·å¼ - æ£®æ—ç»¿ */
        .normal-value {
            color: #009F73;
        }
        
        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            border: none;
            background: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dropdown-content button:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        /* æ‹–æ‹½åŒºåŸŸæ ·å¼ */
        .drop-zone {
            border: 2px dashed #ced4da;
            border-radius: 4px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drop-zone.active {
            border-color: #787785;
            background-color: rgba(120, 119, 133, 0.05);
        }
        
        .drop-zone p {
            margin-bottom: 10px;
            color: #6c757d;
        }
        
        /* å¤šé€‰åˆ—è¡¨æ ·å¼ */
        .customer-checkboxes {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
        }
        
        .customer-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .customer-checkbox-item:last-child {
            border-bottom: none;
        }
        
        .customer-checkbox-item input {
            width: auto;
            margin-right: 10px;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨èƒŒæ™¯å·²æ”¹ä¸ºé›ªç™½è‰²ï¼Œå¹¶å›ºå®šå®šä½ -->
        <header>
            <div class="header-content">
                <h1>TCå®¢æˆ·ç®¡ç†</h1>
                <div class="header-actions">
                    <!-- æŒ‰é’®å·²ä½¿ç”¨å†·ç°ç²‰è‰²ç³» -->
                    <button id="exportDataBtn" class="btn btn-primary">å¯¼å‡ºæ•°æ®</button>
                    <button id="exportWordBtn" class="btn btn-secondary">å¯¼å‡ºWordæ–‡æ¡£</button>
                    <!-- ä¿®æ”¹ï¼šå°†å¯¼å‡ºè´¢åŠ¡ExcelæŒ‰é’®æ”¹ä¸ºå¯¼å‡ºExcelä¸‹æ‹‰èœå• -->
                    <div class="dropdown">
                        <button id="exportExcelBtn" class="btn btn-success">å¯¼å‡ºExcel</button>
                        <div class="dropdown-content">
                            <button id="exportFinanceExcelBtn">å¯¼å‡ºè´¢åŠ¡Excel</button>
                            <button id="exportIndicatorsExcelBtn">å¯¼å‡ºæŒ‡æ ‡å¯¹æ¯”Excel</button>
                            <!-- æ–°å¢ï¼šå¯¼å‡ºå®¢æˆ·åˆ—è¡¨ExcelæŒ‰é’® -->
                            <button id="exportCustomerListExcelBtn">å¯¼å‡ºå®¢æˆ·åˆ—è¡¨Excel</button>
                            <!-- æ–°å¢ï¼šå¯¼å‡ºæœåŠ¡è´¦æœŸåˆ—è¡¨ExcelæŒ‰é’® -->
                            <button id="exportPeriodListExcelBtn">å¯¼å‡ºæœåŠ¡è´¦æœŸåˆ—è¡¨Excel</button>
                        </div>
                    </div>
                    <button id="importBtn" class="btn btn-danger">å¯¼å…¥æ•°æ®</button>
                    <button id="resetBtn" class="btn btn-warning">é‡ç½®æ•°æ®</button>
                </div>
            </div>
        </header>
        
        <!-- å¯¼èˆªæ ‡ç­¾æ å›ºå®šå®šä½ -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-page="customer-list">å®¢æˆ·åˆ—è¡¨</div>
            <div class="nav-tab" data-page="customer-detail">å®¢æˆ·è¯¦æƒ…</div>
        </div>
        
        <!-- å®¢æˆ·åˆ—è¡¨é¡µé¢ -->
        <div id="customer-list" class="page active">
            <div class="search-filter">
                <!-- ä¿®æ”¹ï¼šæœç´¢æ¡†æ ‡ç­¾æ”¹ä¸º"å®¢æˆ·å§“å"å’Œ"é¡¾é—®" -->
                <div class="search-box">
                    <label for="searchInput">å®¢æˆ·å§“å</label>
                    <input type="text" id="searchInput" placeholder="è¾“å…¥å®¢æˆ·å§“å...">
                </div>
                <div class="search-box">
                    <label for="customerServiceSearch">é¡¾é—®</label>
                    <input type="text" id="customerServiceSearch" placeholder="è¾“å…¥é¡¾é—®å§“å...">
                </div>
                <div class="filter-box">
                    <label for="startPeriod">äº¤ä»˜èµ·å§‹æ—¥æœŸ</label>
                    <input type="date" id="startPeriod">
                </div>
                <div class="filter-box">
                    <label for="endPeriod">äº¤ä»˜ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endPeriod">
                </div>
                <button id="searchConfirmBtn" class="btn btn-primary">ç¡®å®š</button>
                <button id="addCustomerBtn" class="btn btn-success">æ·»åŠ æ–°å®¢æˆ·</button>
                <button id="deleteCustomerBtn" class="btn btn-danger">åˆ é™¤å®¢æˆ·</button>
            </div>
            
            <table id="customersTable">
                <thead>
                    <tr>
                        <!-- åˆ é™¤å®¢æˆ·ç¼–å·åˆ— -->
                        <th>å®¢æˆ·å§“å</th>
                        <th>æ€§åˆ«</th>
                        <th>å¹´é¾„</th>
                        <th>æœåŠ¡è¿›åº¦</th>
                        <th>é”€å”®</th>
                        <th>é¡¾é—®</th>
                        <th>ä¸‹æ¬¡äº¤ä»˜æ—¶é—´</th>
                        <th>å‰©ä½™æœŸæ•°</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- å®¢æˆ·æ•°æ®å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
            
            <div class="pagination" id="pagination">
                <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- å®¢æˆ·è¯¦æƒ…é¡µé¢ -->
        <div id="customer-detail" class="page">
            <!-- åˆ é™¤å®¢æˆ·è¯¦æƒ…æ ‡é¢˜ -->
            
            <div class="tab-container">
                <div class="tab-header">
                    <div class="tab active" data-tab="personal-info">ä¸ªäººä¿¡æ¯</div>
                    <div class="tab" data-tab="period-info">è´¦æœŸä¿¡æ¯</div>
                    <div class="tab" data-tab="health-dashboard">æ£€æµ‹ä»ªè¡¨</div>
                    <div class="tab" data-tab="indicators-compare">æŒ‡æ ‡å¯¹æ¯”</div>
                    
                    <div class="header-icons">
                        <div id="globalSaveBtn" class="header-icon save-action" title="ä¿å­˜å½“å‰é¡µé¢">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                        </div>
                        <div id="closeDetailBtn" class="header-icon close-action" title="è¿”å›åˆ—è¡¨">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- ä¸ªäººä¿¡æ¯æ ‡ç­¾é¡µ -->
                <div id="personal-info" class="tab-content active">
                    <form id="personalInfoForm" class="three-column-form">
                        <!-- è¡¨å•å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </form>
                </div>
                
                <!-- è´¦æœŸä¿¡æ¯æ ‡ç­¾é¡µ -->
                <div id="period-info" class="tab-content">
                    <div class="period-selector">
                        <select id="periodSelect">
                            <!-- è´¦æœŸé€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                        </select>
                        <button id="refreshPeriodBtn" class="btn btn-primary">åˆ·æ–°</button>
                        <button id="addPeriodBtn" class="btn btn-success">æ·»åŠ æ–°è´¦æœŸ</button>
                        <button id="editPeriodBtn" class="btn btn-warning">ä¿®æ”¹è´¦æœŸ</button>
                    </div>
                    
                    <div id="periodFormContainer">
                        <!-- è´¦æœŸè¡¨å•å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æ£€æµ‹ä»ªè¡¨æ ‡ç­¾é¡µ -->
                <div id="health-dashboard" class="tab-content">
    <div class="dashboard-charts-area" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div style="background: #f8f9fa; height: 200px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #999;">
            ğŸ“Š è¶‹åŠ¿å›¾è¡¨ä½ 1 (å¾…å¼€å‘)
        </div>
        <div style="background: #f8f9fa; height: 200px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #999;">
            ğŸ“ˆ è¶‹åŠ¿å›¾è¡¨ä½ 2 (å¾…å¼€å‘)
        </div>
        <div style="background: #f8f9fa; height: 200px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #999;">
            ğŸ“‰ è¶‹åŠ¿å›¾è¡¨ä½ 3 (å¾…å¼€å‘)
        </div>
        <div style="background: #f8f9fa; height: 200px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #999;">
            ğŸ©º è¶‹åŠ¿å›¾è¡¨ä½ 4 (å¾…å¼€å‘)
        </div>
    </div>

    <div class="ai-entry-section" style="background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden;">
        <div class="section-header" style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa;">
            <h3 style="margin: 0; font-size: 16px; color: #333;">ğŸ¤– æ™ºèƒ½æŠ¥å‘Šå½•å…¥</h3>
            <div class="actions">
                <input type="file" id="reportUploadInput" accept="image/*" style="display: none;">
                <button id="uploadReportBtn" class="btn btn-primary" style="background: #203F9A;">ğŸ“¸ ä¸Šä¼ ä½“æ£€å• (AIè§£æ)</button>
            </div>
        </div>

        <div id="aiWorkspace" style="display: none; padding: 20px; display: flex; gap: 20px; height: 600px;">
            <div class="preview-pane" style="flex: 1; background: #333; border-radius: 8px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;">
                <img id="reportPreviewImg" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
            </div>

            <div class="audit-pane" style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>æ£€æµ‹æ—¥æœŸ</label>
                        <input type="date" id="ai_reportDate">
                    </div>
                    <div class="form-group">
                        <label>æ£€æµ‹æœºæ„</label>
                        <input type="text" id="ai_hospital">
                    </div>
                    <div class="form-group full-width">
                        <label>æ£€æµ‹é¡¹ç›®/ç±»åˆ«</label>
                        <input type="text" id="ai_category">
                    </div>
                </div>

                <div class="form-group">
                    <label style="color: #d9534f; font-weight: bold;">âš ï¸ ç»“è®ºæ‘˜è¦ & é£é™©æç¤º</label>
                    <textarea id="ai_summary" rows="3" style="background: #fff5f5; border-color: #d9534f;"></textarea>
                </div>

                <div class="items-list" style="flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;">
                    <table id="aiItemsTable" style="width: 100%; font-size: 13px;">
                        <thead style="position: sticky; top: 0; background: #eee;">
                            <tr>
                                <th>æŒ‡æ ‡åç§°</th>
                                <th>æ•°å€¼</th>
                                <th>å•ä½</th>
                                <th>å‚è€ƒ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div style="padding-top: 10px; border-top: 1px solid #eee; text-align: right;">
                    <button id="cancelAiBtn" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button id="confirmAiBtn" class="btn btn-success" style="font-weight: bold;">âœ… ç¡®è®¤å…¥åº“</button>
                </div>
            </div>
        </div>
        
        <div id="aiEmptyState" style="padding: 50px; text-align: center; color: #999;">
            <p>è¯·ç‚¹å‡»å³ä¸Šè§’â€œä¸Šä¼ ä½“æ£€å•â€å¼€å§‹å·¥ä½œ</p>
        </div>
    </div>
</div>
                
                <!-- æŒ‡æ ‡å¯¹æ¯”æ ‡ç­¾é¡µ -->
                <div id="indicators-compare" class="tab-content">
                    <div class="indicators-search">
                        <label for="indicatorSearch">æœç´¢æŒ‡æ ‡åç§°</label>
                        <input type="text" id="indicatorSearch" placeholder="è¾“å…¥æŒ‡æ ‡åç§°...">
                    </div>
                    <div id="indicatorsTableContainer">
                        <!-- æŒ‡æ ‡å¯¹æ¯”è¡¨æ ¼å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¯¼å…¥å¼‚å¸¸æŒ‡æ ‡æ¨¡æ€æ¡† -->
        <div id="importIndicatorsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>å¯¼å…¥å¼‚å¸¸æ£€æµ‹æŒ‡æ ‡</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="importIndicatorsForm">
                        <div class="form-group">
                            <label for="measurementDate">æ£€æµ‹æ—¥æœŸ</label>
                            <input type="date" id="measurementDate">
                        </div>
                        <div class="form-group">
                            <label for="testingInstitution">æ£€æµ‹æœºæ„</label>
                            <input type="text" id="testingInstitution">
                        </div>
                        <!-- ä¿®æ”¹ï¼šæ·»åŠ ä¸‹è½½æ¨¡æ¿æŒ‰é’®å’Œç²˜è´´æ–‡æœ¬åŒºåŸŸ -->
                        <div class="form-group">
                            <label>Excelå¯¼å…¥æ–¹å¼</label>
                            <button type="button" id="downloadTemplateBtn" class="btn btn-primary" style="margin-bottom: 10px;">ä¸‹è½½Excelæ¨¡æ¿</button>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                è¯·ä¸‹è½½æ¨¡æ¿ï¼Œåœ¨Excelä¸­å¡«å†™æ•°æ®åï¼Œå¤åˆ¶å†…å®¹ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†
                            </p>
                            <textarea id="pastedExcelData" rows="8" placeholder="è¯·å°†Excelä¸­çš„æ•°æ®å¤åˆ¶ç²˜è´´åˆ°æ­¤è™•..."></textarea>
                        </div>
                        <!-- æ–°å¢ï¼šJSONå¯¼å…¥æ–¹å¼ -->
                        <div class="form-group">
                            <label>JSONå¯¼å…¥æ–¹å¼</label>
                            <input type="file" id="jsonFileInput" accept=".json" style="margin-bottom: 10px;">
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                è¯·é€‰æ‹©JSONæ ¼å¼çš„æŒ‡æ ‡æ•°æ®æ–‡ä»¶
                            </p>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary">å¯¼å…¥</button>
                            <button type="button" class="btn btn-secondary" id="cancelImportIndicatorsBtn">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- å¯¼å‡ºWordæ¨¡æ€æ¡† -->
        <div id="exportWordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>å¯¼å‡ºWordæ–‡æ¡£</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>é€‰æ‹©è¦å¯¼å‡ºçš„è´¦æœŸ:</label>
                        <div id="periodsCheckboxes">
                            <!-- è´¦æœŸå¤é€‰æ¡†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <button id="confirmExportWordBtn" class="btn btn-primary">ç¡®è®¤å¯¼å‡º</button>
                </div>
            </div>
        </div>
        
        <!-- é‡ç½®ç¡®è®¤æ¨¡æ€æ¡† -->
        <div id="resetConfirmModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¡®è®¤é‡ç½®æ•°æ®</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰å®¢æˆ·æ•°æ®ã€è´¦æœŸä¿¡æ¯å’Œè´¢åŠ¡è®°å½•ï¼Œä¸”æ— æ³•æ¢å¤ã€‚å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½æ•°æ®ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</p>
                    <div class="button-group">
                        <button id="confirmResetBtn" class="btn btn-danger">ç¡®è®¤é‡ç½®</button>
                        <button id="cancelResetBtn" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
        <div id="deleteConfirmModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¡®è®¤åˆ é™¤</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage">ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¢åŠ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
                    <div class="button-group">
                        <button id="confirmDeleteBtn" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
                        <button id="cancelDeleteBtn" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æŒ‡æ ‡ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="indicatorEditModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¼–è¾‘æŒ‡æ ‡è®°å½•</h3>
                    <div>
                        <button class="save-icon" title="ä¿å­˜">âœ“</button>
                        <button class="close-modal">&times;</button>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="indicatorEditForm">
                        <div class="form-group">
                            <label for="editIndicatorName">æŒ‡æ ‡åç§°</label>
                            <input type="text" id="editIndicatorName" required>
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorValue">æ•°å€¼</label>
                            <input type="text" id="editIndicatorValue" required>
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorUnit">å•ä½</label>
                            <input type="text" id="editIndicatorUnit">
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorReference">å‚è€ƒèŒƒå›´</label>
                            <input type="text" id="editIndicatorReference">
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorDate">æµ‹é‡æ—¶é—´</label>
                            <input type="date" id="editIndicatorDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorInstitution">æ£€æµ‹æœºæ„</label>
                            <input type="text" id="editIndicatorInstitution">
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-danger" id="deleteIndicatorBtn">åˆ é™¤è®°å½•</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- å¯¼å‡ºæ•°æ®æ¨¡æ€æ¡† - ä¿®æ”¹ï¼šæ”¯æŒå¤šé€‰å’Œæ‰¹é‡å¯¼å‡º -->
        <div id="exportDataModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>å¯¼å‡ºæ•°æ®</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="customerSearchInput">æœç´¢å®¢æˆ·</label>
                        <input type="text" id="customerSearchInput" placeholder="è¾“å…¥å®¢æˆ·å§“åæœç´¢...">
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©å®¢æˆ·ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div class="customer-checkboxes" id="customerCheckboxes">
                            <!-- å®¢æˆ·å¤é€‰æ¡†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="exportSelectedDataBtn" class="btn btn-primary">å¯¼å‡ºé€‰ä¸­å®¢æˆ·æ•°æ®</button>
                        <button id="exportCurrentListDataBtn" class="btn btn-secondary">å¯¼å‡ºå½“å‰åˆ—è¡¨æ•°æ®</button>
                        <button id="exportAllDataInModalBtn" class="btn btn-warning">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åˆ é™¤å®¢æˆ·ç¡®è®¤æ¨¡æ€æ¡† -->
        <div id="deleteCustomerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¡®è®¤åˆ é™¤å®¢æˆ·</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="deleteCustomerMessage">æ˜¯å¦ç¡®è®¤åˆ é™¤å®¢æˆ·ç¼–å·[ç¼–å·][å§“å]çš„æ‰€æœ‰ä¿¡æ¯ï¼Ÿ</p>
                    <div class="button-group">
                        <button id="confirmDeleteCustomerBtn" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
                        <button id="cancelDeleteCustomerBtn" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¯¼å…¥æ•°æ®æ¨¡æ€æ¡† - æ–°å¢ï¼šæ”¯æŒæ‹–æ‹½å¯¼å…¥ -->
        <div id="importDataModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>å¯¼å…¥æ•°æ®</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="drop-zone" id="dropZone">
                        <p>æ‹–æ‹½JSONæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                        <p style="font-size: 12px; color: #666;">æ”¯æŒæ‰¹é‡å¯¼å…¥å¤šä¸ªJSONæ–‡ä»¶</p>
                        <input type="file" id="importFileInput" multiple accept=".json" style="display: none;">
                        <button type="button" id="selectFilesBtn" class="btn btn-primary">é€‰æ‹©æ–‡ä»¶</button>
                    </div>
                    <div id="importFileList" style="margin-top: 15px;">
                        <!-- å¯¼å…¥æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="button-group">
                        <button id="confirmImportBtn" class="btn btn-primary">ç¡®è®¤å¯¼å…¥</button>
                        <button id="cancelImportBtn" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ–‡ä»¶è¾“å…¥ï¼ˆç”¨äºå¯¼å…¥æ•°æ®ï¼‰ -->
        <input type="file" id="fileInput" style="display: none;" accept=".json">
        
        <!-- ä¿å­˜æç¤º -->
        <div id="saveNotification" class="save-notification">æ•°æ®å·²ä¿å­˜</div>
    </div>

    <script>
// === AI æ™ºèƒ½è§£æé€»è¾‘ ===

// 1. ç»‘å®šä¸Šä¼ æŒ‰é’®
document.getElementById('uploadReportBtn').addEventListener('click', () => {
    document.getElementById('reportUploadInput').click();
});

// 2. å¤„ç†æ–‡ä»¶é€‰æ‹©
document.getElementById('reportUploadInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // æ˜¾ç¤ºåŠ è½½ä¸­...
    const btn = document.getElementById('uploadReportBtn');
    const originText = btn.innerText;
    btn.innerText = "â³ AI æ­£åœ¨è¯»å–ä¸­...";
    btn.disabled = true;

    try {
        // è½¬ Base64
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const base64Img = reader.result;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            document.getElementById('reportPreviewImg').src = base64Img;
            document.getElementById('aiWorkspace').style.display = 'flex'; // è¿™é‡Œä¿®æ­£ä¸ºflexå¸ƒå±€
            document.getElementById('aiEmptyState').style.display = 'none';

            // è°ƒç”¨åç«¯ API
            const token = localStorage.getItem('crm_token');
            const response = await fetch(`${API_BASE_URL}/api/analyze_report`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ image: base64Img })
            });

            if (!response.ok) throw new Error("AI è§£æå¤±è´¥");
            
            const result = await response.json();
            
            // å¡«å……è¡¨å•
            document.getElementById('ai_reportDate').value = result.report_date || '';
            document.getElementById('ai_hospital').value = result.hospital || '';
            document.getElementById('ai_category').value = result.category || '';
            document.getElementById('ai_summary').value = result.summary || '';

            // å¡«å……è¡¨æ ¼
            const tbody = document.querySelector('#aiItemsTable tbody');
            tbody.innerHTML = '';
            (result.items || []).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${item.name}" style="width:100%; border:none;"></td>
                    <td><input type="text" value="${item.value}" style="width:100%; border:none; font-weight:bold; color:#203F9A;"></td>
                    <td><input type="text" value="${item.unit}" style="width:100%; border:none;"></td>
                    <td><input type="text" value="${item.reference}" style="width:100%; border:none; color:#999;"></td>
                    <td><span style="cursor:pointer; color:red;" onclick="this.closest('tr').remove()">Ã—</span></td>
                `;
                tbody.appendChild(tr);
            });
        };

    } catch (error) {
        alert("è§£æå‡ºé”™: " + error.message);
        console.error(error);
    } finally {
        btn.innerText = originText;
        btn.disabled = false;
    }
});

// 3. ç¡®è®¤å…¥åº“é€»è¾‘
document.getElementById('confirmAiBtn').addEventListener('click', async () => {
    // æ”¶é›†æ ¡å¯¹åçš„æ•°æ®
    const items = [];
    document.querySelectorAll('#aiItemsTable tbody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        items.push({
            name: inputs[0].value,
            value: inputs[1].value,
            unit: inputs[2].value,
            reference: inputs[3].value,
            measurementDate: document.getElementById('ai_reportDate').value,
            testingInstitution: document.getElementById('ai_hospital').value
        });
    });

    // æ„é€ è¦ä¿å­˜çš„æ•°æ®ç»“æ„ (è¿½åŠ åˆ° abnormalIndicators)
    if (!ViewController.currentPeriod.abnormalIndicators) {
        ViewController.currentPeriod.abnormalIndicators = [];
    }
    
    // ã€æ ¸å¿ƒã€‘åˆå¹¶æ•°æ®
    ViewController.currentPeriod.abnormalIndicators.push(...items);
    
    // å¦‚æœæœ‰æ‘˜è¦ï¼Œè¿½åŠ åˆ°å¤‡æ³¨
    if(document.getElementById('ai_summary').value) {
        const summary = `ã€${document.getElementById('ai_reportDate').value} ä½“æ£€æ‘˜è¦ã€‘\n` + document.getElementById('ai_summary').value;
        ViewController.currentPeriod.subjectiveHealth = (ViewController.currentPeriod.subjectiveHealth || '') + '\n\n' + summary;
    }

    // 1. ç«‹å³ä¿å­˜åˆ°åç«¯
    await ViewController.savePeriodInfo(); 
    
    // 2. æ¸…ç†ç•Œé¢ (é˜²æ­¢é‡å¤ç‚¹å‡»å…¥åº“)
    document.getElementById('aiWorkspace').style.display = 'none';
    document.getElementById('aiEmptyState').style.display = 'block';
    
    // 3. å¼ºåˆ¶åˆ‡æ¢åˆ°æŒ‡æ ‡å¯¹æ¯”é¡µï¼Œè®©ç”¨æˆ·çœ‹åˆ°æœ€ç»ˆç»“æœï¼Œè€Œä¸æ˜¯ç•™åœ¨ç¡®è®¤é¡µ
    ViewController.switchTab('indicators-compare'); 
    
    // 4. é€šçŸ¥ç”¨æˆ·å¹¶æ¸…ç©ºå½“å‰å®¢æˆ·çš„é™„ä»¶åˆ—è¡¨ï¼ˆé˜²æ­¢ä¸‹æ¬¡è¯¯ç”¨ï¼‰
    ViewController.showSaveNotification();
    ViewController.currentPeriod.attachments = []; 
    // é‡ç»˜è´¦æœŸè¡¨å•ï¼Œæ¸…é™¤é™„ä»¶æ˜¾ç¤º
    ViewController.renderPeriodForm(ViewController.currentPeriod); 
});

        // ==========================================
// ğŸŒ 1. ç½‘ç»œä¸å®‰å…¨é…ç½®
// ==========================================

// âš ï¸ å¿…é¡»ä¿®æ”¹ï¼šä½ çš„ Render æµ‹è¯•æœåœ°å€ (ä¸è¦å¸¦æœ€åçš„æ–œæ )
// ä¾‹å¦‚: "https://crm-test-se2k.onrender.com"
const API_BASE_URL = "https://crm-test-se2k.onrender.com"; 

// ğŸ”’ å®‰å…¨æ£€æŸ¥
const token = localStorage.getItem('crm_token');
// if (!token) window.location.href = 'login.html'; // è°ƒè¯•æœŸå…ˆæ³¨é‡Š

        // æ•°æ®æ¨¡å‹ - ä¿®æ”¹ä¸ºä½¿ç”¨Dexie.js
        const CustomerModel = {
    // API åŸºç¡€è·¯å¾„
    baseUrl: '/api',

    async loadData() {
        try {
            const token = localStorage.getItem('crm_token'); // æ‹¿é’¥åŒ™
            const response = await fetch(`${this.baseUrl}/load_data`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`, //é€’é’¥åŒ™
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    alert("ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                    window.location.href = 'login.html';
                    return;
                }
                throw new Error('ç½‘ç»œå“åº”å¼‚å¸¸');
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            return { customers: [], nextCustomerId: 1, settings: { pageSize: 10 } };
        }
    },
    
    async saveData(data) {
        try {
            const token = localStorage.getItem('crm_token'); // æ‹¿é’¥åŒ™
            const response = await fetch(`${this.baseUrl}/save_data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // âœ… é€’é’¥åŒ™
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) throw new Error('ä¿å­˜å¤±è´¥');
            return true;
        } catch (error) {
            console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
            alert('è­¦å‘Šï¼šæ•°æ®ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼');
            return false;
        }
    },
      
            // ç”Ÿæˆå®¢æˆ·ID
            generateCustomerId(data) {
        const id = `C${data.nextCustomerId.toString().padStart(5, '0')}`;
        data.nextCustomerId++;
        return id;
    },
    
    calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    },
    
    calculateBMI(height, weight) {
        if (!height || !weight) return 0;
        const heightInMeters = height / 100;
        return (weight / (heightInMeters * heightInMeters)).toFixed(2);
    },
    
    getAllPeriods(data) {
        const periods = new Set();
        data.customers.forEach(customer => {
            if(customer.periods) {
                customer.periods.forEach(period => {
                    periods.add(period.periodName);
                });
            }
        });
        return Array.from(periods).sort();
    },
    
    getLatestPeriod(customer) {
        if (!customer.periods || customer.periods.length === 0) return null;
        return customer.periods.sort((a, b) => {
            return b.periodName.localeCompare(a.periodName);
        })[0];
    },
    
    generatePeriodName(date, customer) {
        const dateObj = new Date(date);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const dateStr = `${year}${month}${day}`;
        const existingPeriods = customer.periods || [];
        let maxNumber = 0;
        existingPeriods.forEach(period => {
            const match = period.periodName.match(/^(\d{2})-\d{8}$/);
            if (match) {
                const num = parseInt(match[1]);
                if (num > maxNumber) maxNumber = num;
            }
        });
        const nextNumber = maxNumber + 1;
        const numberStr = String(nextNumber).padStart(2, '0');
        return `${numberStr}-${dateStr}`;
    },
    
    getAllIndicatorNames(customer) {
        const indicatorNames = new Set();
        if (customer.periods) {
            customer.periods.forEach(period => {
                if (period.abnormalIndicators) {
                    period.abnormalIndicators.forEach(indicator => {
                        indicatorNames.add(indicator.name);
                    });
                }
            });
        }
        return Array.from(indicatorNames);
    },
    
    getNextDeliveryDate(customer) {
        const remainingPeriods = this.getRemainingPeriods(customer);
        if (remainingPeriods <= 0) return '';
        if (!customer.periods || customer.periods.length === 0) return '';
        const dates = customer.periods
            .map(p => p.periodDate)
            .filter(d => d)
            .sort((a, b) => new Date(b) - new Date(a));
        if (dates.length === 0) return '';
        const lastDate = new Date(dates[0]);
        lastDate.setDate(lastDate.getDate() + 70);
        return lastDate.toISOString().split('T')[0];
    },
    
    getOrderTotal(customer) {
        let total = 0;
        if (customer.periods) {
            customer.periods.forEach(period => {
                if (period.financialStats) {
                    period.financialStats.forEach(record => {
                        if (record.mainCategory === 'è®¢å•è®°å½•') {
                            total += record.amount;
                        }
                    });
                }
            });
        }
        return total;
    },
    
    getRemainingPeriods(customer) {
        const totalServicePeriods = customer.personalInfo.totalServicePeriods || 0;
        const usedPeriods = customer.periods ? customer.periods.length : 0;
        const remaining = totalServicePeriods - usedPeriods;
        return Math.max(0, remaining);
    }
};

        // è§†å›¾æ§åˆ¶å™¨
        const ViewController = {
            currentPage: 'customer-list',
            currentCustomer: null,
            currentPeriod: null,
            currentPageIndex: 0,
            autoSaveTimeout: null,
            editingFinanceRecord: null,
            recordToDelete: null,
            editingIndicator: null,
            indicatorSearchTerm: '',
            selectedCustomerId: null, // æ–°å¢ï¼šé€‰ä¸­çš„å®¢æˆ·ID
            selectedCustomerIds: [], // æ–°å¢ï¼šå¤šé€‰å®¢æˆ·IDæ•°ç»„
            importFiles: [], // æ–°å¢ï¼šå¯¼å…¥æ–‡ä»¶åˆ—è¡¨
            
            async init() {
                this.bindEvents();
                this.showPage('customer-list');
                this.renderCustomerList();
                // ç§»é™¤é»˜è®¤æ—¥æœŸè®¾ç½®
                this.setDefaultPeriodDates();
            },
            
            // è®¾ç½®é»˜è®¤äº¤ä»˜æ—¥æœŸåŒºé—´ - ä¿®æ”¹ï¼šç§»é™¤é»˜è®¤æ—¥æœŸè®¾ç½®
            setDefaultPeriodDates() {
                // ç§»é™¤é»˜è®¤æ—¥æœŸè®¾ç½®ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
                // ä¿æŒæ—¥æœŸè¾“å…¥æ¡†ä¸ºç©ºï¼Œè¿™æ ·æ–°å®¢æˆ·å°±èƒ½æ˜¾ç¤º
                document.getElementById('startPeriod').value = '';
                document.getElementById('endPeriod').value = '';
            },
            
            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                // å¯¼èˆªæ ‡ç­¾ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const page = tab.getAttribute('data-page');
                        this.showPage(page);
                    });
                });
                
                // === é¡¶éƒ¨å›¾æ ‡é€»è¾‘ ===
                
                // 1. å…³é—­æŒ‰é’®ï¼šè¿”å›åˆ—è¡¨
                const closeBtn = document.getElementById('closeDetailBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.showPage('customer-list');
                    });
                }

                // 2. å…¨å±€ä¿å­˜æŒ‰é’®ï¼šæ™ºèƒ½åˆ¤æ–­å½“å‰Tab
                const saveBtn = document.getElementById('globalSaveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        // è·å–å½“å‰æ¿€æ´»çš„ tab ID
                        const activeTab = document.querySelector('.tab-content.active').id;
                        
                        switch(activeTab) {
                            case 'personal-info':
                                this.savePersonalInfo();
                                break;
                            case 'period-info':
                                this.savePeriodInfo();
                                break;
                            case 'finance-info':
                            case 'indicators-compare':
                                // è¿™ä¸¤ä¸ªé¡µé¢é€šå¸¸æ˜¯å³æ—¶ä¿å­˜æˆ–æ— éœ€ä¿å­˜ï¼Œç»™ä¸ªæç¤ºå³å¯
                                this.showSaveNotification(); 
                                break;
                        }
                    });
                }

                // å®¢æˆ·åˆ—è¡¨ç›¸å…³äº‹ä»¶
                document.getElementById('searchConfirmBtn').addEventListener('click', () => {
                    this.renderCustomerList();
                });
                
                document.getElementById('addCustomerBtn').addEventListener('click', () => {
                    this.addNewCustomer();
                });
                
                // æ–°å¢ï¼šåˆ é™¤å®¢æˆ·æŒ‰é’®äº‹ä»¶
                document.getElementById('deleteCustomerBtn').addEventListener('click', () => {
                    this.showDeleteCustomerModal();
                });
                
                // å¯¼å…¥å¯¼å‡ºäº‹ä»¶
                document.getElementById('exportDataBtn').addEventListener('click', () => {
                    this.showExportDataModal();
                });
                
                document.getElementById('exportWordBtn').addEventListener('click', () => {
                    this.showExportWordModal();
                });
                
                // æ–°å¢ï¼šå¯¼å‡ºå®¢æˆ·åˆ—è¡¨Exceläº‹ä»¶
                document.getElementById('exportCustomerListExcelBtn').addEventListener('click', () => {
                    this.exportCustomerListExcel();
                });
                
                // æ–°å¢ï¼šå¯¼å‡ºæœåŠ¡è´¦æœŸåˆ—è¡¨Exceläº‹ä»¶
                document.getElementById('exportPeriodListExcelBtn').addEventListener('click', () => {
                    this.exportPeriodListExcel();
                });
                
                // ä¿®æ”¹ï¼šå¯¼å…¥æ•°æ®äº‹ä»¶ - æ”¹ä¸ºæ˜¾ç¤ºå¯¼å…¥æ•°æ®æ¨¡æ€æ¡†
                document.getElementById('importBtn').addEventListener('click', () => {
                    this.showImportDataModal();
                });
                
                // æ–°å¢ï¼šå¯¼å…¥æ•°æ®æ¨¡æ€æ¡†äº‹ä»¶
                document.getElementById('selectFilesBtn').addEventListener('click', () => {
                    document.getElementById('importFileInput').click();
                });
                
                document.getElementById('importFileInput').addEventListener('change', (e) => {
                    this.handleImportFiles(e.target.files);
                });
                
                document.getElementById('confirmImportBtn').addEventListener('click', () => {
                    this.importSelectedFiles();
                });
                
                document.getElementById('cancelImportBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('importDataModal'));
                });
                
                // æ‹–æ‹½åŒºåŸŸäº‹ä»¶
                const dropZone = document.getElementById('dropZone');
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('active');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('active');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('active');
                    this.handleImportFiles(e.dataTransfer.files);
                });
                
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.showResetConfirmModal();
                });
                
                // æ·»åŠ è´¦æœŸè¡¨å•æäº¤äº‹ä»¶
                document.getElementById('addPeriodForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addPeriod();
                });
                
                // ä¿®æ”¹è´¦æœŸè¡¨å•æäº¤äº‹ä»¶
                document.getElementById('editPeriodForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.editPeriod();
                });

                // å¯¼å…¥æŒ‡æ ‡è¡¨å•æäº¤äº‹ä»¶
                document.getElementById('importIndicatorsForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.importIndicators();
                });
                
                // æ–°å¢ï¼šå–æ¶ˆå¯¼å…¥æŒ‡æ ‡äº‹ä»¶
                document.getElementById('cancelImportIndicatorsBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('importIndicatorsModal'));
                });
                
                // æ–°å¢ï¼šä¸‹è½½æ¨¡æ¿äº‹ä»¶
                document.getElementById('downloadTemplateBtn').addEventListener('click', () => {
                    this.downloadExcelTemplate();
                });
                
                // æ–°å¢ï¼šJSONæ–‡ä»¶å¯¼å…¥äº‹ä»¶
                document.getElementById('jsonFileInput').addEventListener('change', (e) => {
                    this.importIndicatorsFromJSON(e.target.files[0]);
                });
                
                // ç¡®è®¤å¯¼å‡ºWordäº‹ä»¶
                document.getElementById('confirmExportWordBtn').addEventListener('click', () => {
                    this.exportWord();
                });
                
                // é‡ç½®ç¡®è®¤äº‹ä»¶
                document.getElementById('confirmResetBtn').addEventListener('click', () => {
                    this.resetAllData();
                });
                
                document.getElementById('cancelResetBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('resetConfirmModal'));
                });
                
                // åˆ é™¤ç¡®è®¤äº‹ä»¶
                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    this.deleteFinanceRecord();
                });
                
                document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('deleteConfirmModal'));
                });

                // æŠ˜å é¢æ¿äº‹ä»¶
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('collapse-header')) {
                        const panel = e.target.closest('.collapse-panel');
                        panel.classList.toggle('active');
                    }
                });

                // ä¸ªäººä¿¡æ¯è¡¨æ ¼äº‹ä»¶ç»‘å®š
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-allergy-icon')) {
                        this.addAllergyHistoryRecord();
                    } else if (e.target.classList.contains('add-medication-icon')) {
                        this.addMedicationHistoryRecord();
                    } else if (e.target.classList.contains('add-past-medical-icon')) {
                        this.addPastMedicalHistoryRecord();
                    } else if (e.target.classList.contains('add-surgery-icon')) {
                        this.addSurgeryHospitalizationHistoryRecord();
                    } else if (e.target.classList.contains('add-vaccination-icon')) {
                        this.addVaccinationHistoryRecord();
                    } else if (e.target.classList.contains('add-family-icon')) {
                        this.addFamilyHistoryRecord();
                    }
                });

                // è´¦æœŸä¿¡æ¯è¡¨æ ¼äº‹ä»¶ç»‘å®š
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-dietary-icon')) {
                        this.addDietaryHabitsRecord();
                    } else if (e.target.classList.contains('add-physical-icon')) {
                        this.addPhysicalActivityRecord();
                    } else if (e.target.classList.contains('add-sleep-icon')) {
                        this.addSleepPatternRecord();
                    } else if (e.target.classList.contains('add-communication-icon')) {
                        this.addCommunicationRecord();
                    } else if (e.target.classList.contains('add-followup-icon')) {
                        this.addFollowUpRecord();
                    }
                });
                
                // æŒ‡æ ‡æœç´¢äº‹ä»¶
                document.getElementById('indicatorSearch').addEventListener('input', (e) => {
                    this.indicatorSearchTerm = e.target.value.toLowerCase();
                    this.renderIndicatorsCompare();
                });
                
                // æŒ‡æ ‡ç¼–è¾‘æ¨¡æ€æ¡†äº‹ä»¶
                document.querySelector('#indicatorEditModal .save-icon').addEventListener('click', () => {
                    this.saveIndicatorRecord();
                });
                
                document.getElementById('deleteIndicatorBtn').addEventListener('click', () => {
                    this.deleteIndicatorRecord();
                });
                
                // å¯¼å‡ºæ•°æ®æ¨¡æ€æ¡†äº‹ä»¶
                document.getElementById('customerSearchInput').addEventListener('input', (e) => {
                    this.filterExportCustomers(e.target.value);
                });
                
                // ä¿®æ”¹ï¼šå¯¼å‡ºé€‰ä¸­å®¢æˆ·æ•°æ®äº‹ä»¶
                document.getElementById('exportSelectedDataBtn').addEventListener('click', () => {
                    this.exportSelectedData();
                });
                
                // æ–°å¢ï¼šå¯¼å‡ºå½“å‰åˆ—è¡¨æ•°æ®äº‹ä»¶
                document.getElementById('exportCurrentListDataBtn').addEventListener('click', () => {
                    this.exportCurrentListData();
                });
                
                document.getElementById('exportAllDataInModalBtn').addEventListener('click', () => {
                    this.exportAllData();
                });
                
                // æ–°å¢ï¼šåˆ é™¤å®¢æˆ·ç¡®è®¤äº‹ä»¶
                document.getElementById('confirmDeleteCustomerBtn').addEventListener('click', () => {
                    this.deleteCustomer();
                });
                
                document.getElementById('cancelDeleteCustomerBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('deleteCustomerModal'));
                });
            },
            
            // æ˜¾ç¤ºé¡µé¢ - ä¿®æ”¹ï¼šåœ¨åˆ‡æ¢åˆ°å®¢æˆ·åˆ—è¡¨æ—¶å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®
            showPage(pageName) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.getElementById(pageName).classList.add('active');
                document.querySelector(`.nav-tab[data-page="${pageName}"]`).classList.add('active');
                
                this.currentPage = pageName;
                
                if (pageName === 'customer-list') {
                    // å¼ºåˆ¶é‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°å®¢æˆ·åˆ—è¡¨
                    this.currentPageIndex = 0;
                    this.renderCustomerList();
                }
            },
            
            // æ¸²æŸ“å®¢æˆ·åˆ—è¡¨ - ä¿®æ”¹ï¼šä¿®å¤è¿‡æ»¤é€»è¾‘ï¼Œç¡®ä¿æ–°å®¢æˆ·èƒ½æ­£ç¡®æ˜¾ç¤º
            async renderCustomerList() {
                const data = await CustomerModel.loadData();
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const customerServiceSearch = document.getElementById('customerServiceSearch').value.toLowerCase();
                const startPeriod = document.getElementById('startPeriod').value;
                const endPeriod = document.getElementById('endPeriod').value;
                
                // è¿‡æ»¤å®¢æˆ· - ä¿®æ”¹ï¼šä¿®å¤äº¤ä»˜æ—¥æœŸåŒºé—´è¿‡æ»¤é€»è¾‘
                let filteredCustomers = data.customers.filter(customer => {
                    const matchesSearch = customer.personalInfo.name.toLowerCase().includes(searchTerm);
                    
                    // ä¿®å¤é¡¾é—®è¿‡æ»¤æ¡ä»¶ï¼šå½“é¡¾é—®æœç´¢æ¡†ä¸ºç©ºæ—¶ï¼Œä¸è¿‡æ»¤ä»»ä½•å®¢æˆ·
                    const matchesCustomerService = !customerServiceSearch || 
                        (customer.personalInfo.customerService && 
                         customer.personalInfo.customerService.toLowerCase().includes(customerServiceSearch));
                    
                    // æ£€æŸ¥ä¸‹æ¬¡äº¤ä»˜æ—¶é—´åŒºé—´ - ä¿®æ”¹ï¼šåªæœ‰å½“ä¸¤ä¸ªæ—¥æœŸéƒ½æœ‰å€¼æ—¶æ‰è¿›è¡Œè¿‡æ»¤
                    let matchesPeriod = true;
                    if (startPeriod && endPeriod) {
                        const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                        if (!nextDeliveryDate) {
                            // å¦‚æœæ²¡æœ‰ä¸‹æ¬¡äº¤ä»˜æ—¶é—´ï¼Œä¸”è®¾ç½®äº†æ—¥æœŸåŒºé—´ï¼Œåˆ™ä¸æ˜¾ç¤º
                            matchesPeriod = false;
                        } else {
                            matchesPeriod = nextDeliveryDate >= startPeriod && nextDeliveryDate <= endPeriod;
                        }
                    }
                    // å¦‚æœåªæœ‰ä¸€ä¸ªæ—¥æœŸæœ‰å€¼ï¼Œæˆ–è€…ä¸¤ä¸ªéƒ½æ²¡æœ‰å€¼ï¼Œåˆ™æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·
                    
                    return matchesSearch && matchesCustomerService && matchesPeriod;
                });
                
                // åˆ†é¡µ
                const pageSize = data.settings.pageSize;
                const startIndex = this.currentPageIndex * pageSize;
                const endIndex = startIndex + pageSize;
                const paginatedCustomers = filteredCustomers.slice(startIndex, endIndex);
                
                // æ¸²æŸ“è¡¨æ ¼ - ä¿®æ”¹ï¼šåˆ é™¤å®¢æˆ·ç¼–å·åˆ—ï¼Œæ”¹ä¸ºä¸‹æ¬¡äº¤ä»˜æ—¶é—´
                const tbody = document.querySelector('#customersTable tbody');
                tbody.innerHTML = '';
                
                paginatedCustomers.forEach(customer => {
                    // æ›´æ–°æœåŠ¡è¿›åº¦ä¸ºæœ€æ–°è´¦æœŸ
                    const latestPeriod = CustomerModel.getLatestPeriod(customer);
                    const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                    
                    // è·å–ä¸‹æ¬¡äº¤ä»˜æ—¶é—´
                    const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                    
                    // è®¡ç®—å‰©ä½™æœŸæ•°
                    const remainingPeriods = CustomerModel.getRemainingPeriods(customer);
                    
                    const row = document.createElement('tr');
                    // ä¿®æ”¹ï¼šåˆ é™¤å®¢æˆ·ç¼–å·åˆ—ï¼Œæ”¹ä¸ºä¸‹æ¬¡äº¤ä»˜æ—¶é—´
                    row.innerHTML = `
                        <td>${customer.personalInfo.name}</td>
                        <td>${customer.personalInfo.gender}</td>
                        <td>${customer.personalInfo.age}</td>
                        <td>${serviceProgress}</td>
                        <td>${customer.personalInfo.sales}</td>
                        <td>${customer.personalInfo.customerService}</td>
                        <td>${nextDeliveryDate}</td>
                        <td>${remainingPeriods}</td>
                    `;
                    
                    // æ–°å¢ï¼šæ·»åŠ å•å‡»é€‰ä¸­äº‹ä»¶
                    row.addEventListener('click', (e) => {
                        // ç§»é™¤æ‰€æœ‰è¡Œçš„é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('#customersTable tbody tr').forEach(r => {
                            r.classList.remove('selected');
                        });
                        // æ·»åŠ å½“å‰è¡Œçš„é€‰ä¸­çŠ¶æ€
                        row.classList.add('selected');
                        // è®°å½•é€‰ä¸­çš„å®¢æˆ·ID
                        this.selectedCustomerId = customer.id;
                    });
                    
                    // ä¿æŒåŸæœ‰çš„åŒå‡»äº‹ä»¶
                    row.addEventListener('dblclick', () => {
                        this.showCustomerDetail(customer.id);
                    });
                    
                    tbody.appendChild(row);
                });
                
                // æ¸²æŸ“åˆ†é¡µ
                this.renderPagination(filteredCustomers.length, pageSize);
            },
            
            // æ¸²æŸ“åˆ†é¡µ
            renderPagination(totalCustomers, pageSize) {
                const totalPages = Math.ceil(totalCustomers / pageSize);
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                
                for (let i = 0; i < totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-btn ${i === this.currentPageIndex ? 'active' : ''}`;
                    pageBtn.textContent = i + 1;
                    pageBtn.addEventListener('click', () => {
                        this.currentPageIndex = i;
                        this.renderCustomerList();
                    });
                    pagination.appendChild(pageBtn);
                }
            },
            
            // æ˜¾ç¤ºå®¢æˆ·è¯¦æƒ… - ä¿®æ”¹ï¼šæ€»æ˜¯ä»æ•°æ®åº“é‡æ–°åŠ è½½å®¢æˆ·æ•°æ®
            async showCustomerDetail(customerId) {
                // æ€»æ˜¯ä»æ•°æ®åº“é‡æ–°åŠ è½½å®¢æˆ·æ•°æ®ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                const data = await CustomerModel.loadData();
                const customer = data.customers.find(c => c.id === customerId);
                
                if (!customer) return;
                
                this.currentCustomer = customer;
                // åˆ é™¤å®¢æˆ·è¯¦æƒ…æ ‡é¢˜
                
                // æ¸²æŸ“ä¸ªäººä¿¡æ¯è¡¨å•
                this.renderPersonalInfoForm(customer);
                
                
                // æ¸²æŸ“æŒ‡æ ‡å¯¹æ¯”
                this.renderIndicatorsCompare();
                
                this.showPage('customer-detail');
                this.switchTab('personal-info');
            },
            
            // æ–°å¢ï¼šæ˜¾ç¤ºåˆ é™¤å®¢æˆ·ç¡®è®¤æ¨¡æ€æ¡†
            async showDeleteCustomerModal() {
                if (!this.selectedCustomerId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¢æˆ·');
                    return;
                }
                
                const data = await CustomerModel.loadData();
                const customer = data.customers.find(c => c.id === this.selectedCustomerId);
                
                if (!customer) {
                    alert('æœªæ‰¾åˆ°é€‰ä¸­çš„å®¢æˆ·');
                    return;
                }
                
                document.getElementById('deleteCustomerMessage').textContent = 
                    `æ˜¯å¦ç¡®è®¤åˆ é™¤å®¢æˆ·ç¼–å·${customer.id}${customer.personalInfo.name}çš„æ‰€æœ‰ä¿¡æ¯ï¼Ÿ`;
                
                document.getElementById('deleteCustomerModal').classList.add('active');
            },
            
            // æ–°å¢ï¼šåˆ é™¤å®¢æˆ·
            async deleteCustomer() {
                if (!this.selectedCustomerId) return;
                
                const data = await CustomerModel.loadData();
                const customerIndex = data.customers.findIndex(c => c.id === this.selectedCustomerId);
                
                if (customerIndex === -1) {
                    alert('æœªæ‰¾åˆ°é€‰ä¸­çš„å®¢æˆ·');
                    return;
                }
                
                // ä»æ•°ç»„ä¸­åˆ é™¤å®¢æˆ·
                data.customers.splice(customerIndex, 1);
                
                // ä¿å­˜æ•°æ®
                await CustomerModel.saveData(data);
                
                // å…³é—­æ¨¡æ€æ¡†
                this.closeModal(document.getElementById('deleteCustomerModal'));
                
                // é‡ç½®é€‰ä¸­çŠ¶æ€
                this.selectedCustomerId = null;
                
                // é‡æ–°æ¸²æŸ“å®¢æˆ·åˆ—è¡¨
                this.renderCustomerList();
                
                // æ˜¾ç¤ºä¿å­˜é€šçŸ¥
                this.showSaveNotification();
            },
            
            // æ¸²æŸ“ä¸ªäººä¿¡æ¯è¡¨å•
            renderPersonalInfoForm(customer) {
                const form = document.getElementById('personalInfoForm');
                const personalInfo = customer.personalInfo;
                
                // æ›´æ–°æœåŠ¡è¿›åº¦ä¸ºæœ€æ–°è´¦æœŸ
                const latestPeriod = CustomerModel.getLatestPeriod(customer);
                const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                
                // è·å–ä¸‹æ¬¡äº¤ä»˜æ—¶é—´
                const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                
                form.innerHTML = `
                    <div class="form-group">
                        <label for="customerName">å§“å</label>
                        <input type="text" id="customerName" value="${personalInfo.name || ''}">
                    </div>
                    <div class="form-group">
                        <label for="customerGender">æ€§åˆ«</label>
                        <select id="customerGender">
                            <option value="ç”·" ${personalInfo.gender === 'ç”·' ? 'selected' : ''}>ç”·</option>
                            <option value="å¥³" ${personalInfo.gender === 'å¥³' ? 'selected' : ''}>å¥³</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="birthDate" value="${personalInfo.birthDate || ''}">
                    </div>
                    <div class="form-group">
                        <label for="age">å¹´é¾„</label>
                        <input type="number" id="age" value="${personalInfo.age || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="residence">å¸¸å±…åœ°</label>
                        <input type="text" id="residence" value="${personalInfo.residence || ''}">
                    </div>
                    <div class="form-group">
                        <label for="maritalStatus">å©šå§»çŠ¶å†µ</label>
                        <select id="maritalStatus">
                            <option value="æœªå©š" ${personalInfo.maritalStatus === 'æœªå©š' ? 'selected' : ''}>æœªå©š</option>
                            <option value="å·²å©š" ${personalInfo.maritalStatus === 'å·²å©š' ? 'selected' : ''}>å·²å©š</option>
                            <option value="ç¦»å¼‚" ${personalInfo.maritalStatus === 'ç¦»å¼‚' ? 'selected' : ''}>ç¦»å¼‚</option>
                            <option value="ä¸§å¶" ${personalInfo.maritalStatus === 'ä¸§å¶' ? 'selected' : ''}>ä¸§å¶</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="height">èº«é«˜ (cm)</label>
                        <input type="number" id="height" value="${personalInfo.height || ''}">
                    </div>
                    <div class="form-group">
                        <label for="weight">ä½“é‡ (kg)</label>
                        <input type="number" id="weight" value="${personalInfo.weight || ''}">
                    </div>
                    <div class="form-group">
                        <label for="bmi">BMI</label>
                        <input type="number" id="bmi" value="${personalInfo.bmi || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="serviceProgress">æœåŠ¡è¿›åº¦</label>
                        <input type="text" id="serviceProgress" value="${serviceProgress}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="sales">é”€å”®</label>
                        <input type="text" id="sales" value="${personalInfo.sales || ''}">
                    </div>
                    <div class="form-group">
                        <label for="customerService">é¡¾é—®</label>
                        <input type="text" id="customerService" value="${personalInfo.customerService || ''}">
                    </div>
                    <div class="form-group">
                        <label for="nextDeliveryDate">ä¸‹æ¬¡äº¤ä»˜æ—¶é—´</label>
                        <input type="date" id="nextDeliveryDate" value="${nextDeliveryDate}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="totalServicePeriods">æœåŠ¡æ€»æœŸæ•°</label>
                        <input type="number" id="totalServicePeriods" value="${personalInfo.totalServicePeriods || ''}">
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>è¿‡æ•å²</label>
                            <span class="add-icon add-allergy-icon">+</span>
                        </div>
                        <div id="allergyHistoryContainer">
                            ${this.renderAllergyHistoryTable(customer.allergyHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>ç”¨è¯å²</label>
                            <span class="add-icon add-medication-icon">+</span>
                        </div>
                        <div id="medicationHistoryContainer">
                            ${this.renderMedicationHistoryTable(customer.medicationHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>æ—¢å¾€ç—…å²</label>
                            <span class="add-icon add-past-medical-icon">+</span>
                        </div>
                        <div id="pastMedicalHistoryContainer">
                            ${this.renderPastMedicalHistoryTable(customer.pastMedicalHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>æ‰‹æœ¯ä¸ä½é™¢å²</label>
                            <span class="add-icon add-surgery-icon">+</span>
                        </div>
                        <div id="surgeryHospitalizationHistoryContainer">
                            ${this.renderSurgeryHospitalizationHistoryTable(customer.surgeryHospitalizationHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>ç–«è‹—æ¥ç§å²</label>
                            <span class="add-icon add-vaccination-icon">+</span>
                        </div>
                        <div id="vaccinationHistoryContainer">
                            ${this.renderVaccinationHistoryTable(customer.vaccinationHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>å®¶æ—ç—…å²</label>
                            <span class="add-icon add-family-icon">+</span>
                        </div>
                        <div id="familyHistoryContainer">
                            ${this.renderFamilyHistoryTable(customer.familyHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="customerPortrait">å®¢æˆ·ç”»åƒ</label>
                        <textarea id="customerPortrait" rows="3">${personalInfo.customerPortrait || ''}</textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="notes">å¤‡æ³¨</label>
                        <textarea id="notes" rows="3">${personalInfo.notes || ''}</textarea>
                    </div>
                `;
                
                // ç»‘å®šè‡ªåŠ¨è®¡ç®—äº‹ä»¶
                document.getElementById('birthDate').addEventListener('change', () => {
                    const age = CustomerModel.calculateAge(document.getElementById('birthDate').value);
                    document.getElementById('age').value = age;
                });
                
                document.getElementById('height').addEventListener('input', this.calculateAndDisplayBMI.bind(this));
                document.getElementById('weight').addEventListener('input', this.calculateAndDisplayBMI.bind(this));
                
                // ç»‘å®šè‡ªåŠ¨ä¿å­˜äº‹ä»¶
                this.bindAutoSaveEvents();
            },
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºBMI
            calculateAndDisplayBMI() {
                const height = document.getElementById('height').value;
                const weight = document.getElementById('weight').value;
                const bmi = CustomerModel.calculateBMI(height, weight);
                document.getElementById('bmi').value = bmi;
            },
            
            // ç»‘å®šè‡ªåŠ¨ä¿å­˜äº‹ä»¶
            bindAutoSaveEvents() {
                // ä¸ºæ‰€æœ‰è¾“å…¥å…ƒç´ ç»‘å®šè‡ªåŠ¨ä¿å­˜
                const inputs = document.querySelectorAll('#personalInfoForm input, #personalInfoForm select, #personalInfoForm textarea');
                inputs.forEach(input => {
                    // è¾“å…¥æ¡†å¤±ç„¦æ—¶ä¿å­˜
                    input.addEventListener('blur', () => {
                        this.autoSavePersonalInfo();
                    });
                    
                    // æ–‡æœ¬åŒºåŸŸä½¿ç”¨é˜²æŠ–ä¿å­˜
                    if (input.tagName === 'TEXTAREA') {
                        input.addEventListener('input', () => {
                            clearTimeout(this.autoSaveTimeout);
                            this.autoSaveTimeout = setTimeout(() => {
                                this.autoSavePersonalInfo();
                            }, 2000);
                        });
                    }
                });
            },
            
            // è‡ªåŠ¨ä¿å­˜ä¸ªäººä¿¡æ¯
            async autoSavePersonalInfo() {
                await this.savePersonalInfo(false);
            },
            
            // æ¸²æŸ“è´¦æœŸé€‰æ‹©å™¨
            renderPeriodSelector(customer) {
                const periodSelect = document.getElementById('periodSelect');
                periodSelect.innerHTML = '';
                
                if (customer.periods && customer.periods.length > 0) {
                    // æŒ‰è´¦æœŸåç§°æ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢ï¼ˆç¼–å·-å¹´æœˆæ—¥æ ¼å¼ï¼‰
                    const sortedPeriods = [...customer.periods].sort((a, b) => {
                        // ç›´æ¥æŒ‰å­—ç¬¦ä¸²æ’åºï¼Œå› ä¸ºæ ¼å¼æ˜¯å›ºå®šçš„ç¼–å·-æ—¥æœŸ
                        return b.periodName.localeCompare(a.periodName);
                    });
                    
                    sortedPeriods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period.periodId;
                        option.textContent = period.periodName;
                        periodSelect.appendChild(option);
                    });
                    
                    this.currentPeriod = sortedPeriods[0];
                    periodSelect.value = this.currentPeriod.periodId;
                    this.renderPeriodForm(this.currentPeriod);
                } else {
                    this.currentPeriod = null;
                    document.getElementById('periodFormContainer').innerHTML = '<p>æš‚æ— è´¦æœŸä¿¡æ¯</p>';
                }
            },
            
            // æ¸²æŸ“è´¦æœŸè¡¨å•
            renderPeriodForm(period) {
                // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
                if (!this.validatePeriodData(period)) {
                    document.getElementById('periodFormContainer').innerHTML = '<p>è´¦æœŸæ•°æ®å¼‚å¸¸ï¼Œè¯·é‡æ–°é€‰æ‹©</p>';
                    return;
                }
                
                const container = document.getElementById('periodFormContainer');
                
                container.innerHTML = `
                    <form id="periodForm">
                        <div class="form-group full-width">
                            <div class="title-container">
                                <label>è†³é£Ÿä¹ æƒ¯</label>
                                <span class="add-icon add-dietary-icon">+</span>
                            </div>
                            <div id="dietaryHabitsContainer">
                                ${this.renderDietaryHabitsTable(period.dietaryHabits || [])}
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <div class="title-container">
                                <label>èº«ä½“æ´»åŠ¨</label>
                                <span class="add-icon add-physical-icon">+</span>
                            </div>
                            <div id="physicalActivityContainer">
                                ${this.renderPhysicalActivityTable(period.physicalActivity || [])}
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <div class="title-container">
                                <label>ç¡çœ æ¨¡å¼</label>
                                <span class="add-icon add-sleep-icon">+</span>
                            </div>
                            <div id="sleepPatternContainer">
                                ${this.renderSleepPatternTable(period.sleepPattern || [])}
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="stressMentalHealth">å‹åŠ›ä¸å¿ƒç†å¥åº·</label>
                            <textarea id="stressMentalHealth" rows="3">${period.stressMentalHealth || ''}</textarea>
                        </div>

                        <div class="form-group full-width">
                            <label for="environmentOccupational">ç¯å¢ƒä¸èŒä¸šå› ç´ </label>
                            <textarea id="environmentOccupational" rows="3">${period.environmentOccupational || ''}</textarea>
                        </div>

                        <div class="form-group full-width">
                            <label for="subjectiveHealth">ä¸»è§‚å¥åº·æ„Ÿå—</label>
                            <textarea id="subjectiveHealth" rows="3">${period.subjectiveHealth || ''}</textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="abnormalIndicators">å¼‚å¸¸æ£€æµ‹æŒ‡æ ‡</label>
                            <div id="abnormalIndicatorsContainer">
                                ${this.renderAbnormalIndicators(period.abnormalIndicators || [])}
                            </div>
                            <button type="button" id="addIndicatorBtn" class="btn add-record-btn" style="margin-top: 10px;">æ·»åŠ æŒ‡æ ‡</button>
                            <button type="button" id="importIndicatorsBtn" class="btn btn-primary" style="margin-top: 10px;">å¯¼å…¥æŒ‡æ ‡</button>
                        </div>
                        
                        <div class="form-group full-width">
                            <div class="title-container">
                                <label for="communicationRecords">ä¼å¾®æ²Ÿé€šè®°å½•</label>
                                <span class="add-icon add-communication-icon">+</span>
                            </div>
                            <div id="communicationRecordsContainer">
                                ${this.renderCommunicationRecords(period.communicationRecords || [])}
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <div class="title-container">
                                <label for="followUpRecords">å›è®¿è®°å½•</label>
                                <span class="add-icon add-followup-icon">+</span>
                            </div>
                            <div id="followUpRecordsContainer">
                                ${this.renderFollowUpRecords(period.followUpRecords || [])}
                            </div>
                        </div>

                        <div class="form-group full-width" style="margin-top: 20px; border-top: 1px dashed #eee; padding-top: 15px;">
                            <div class="title-container" style="display: flex; align-items: center; justify-content: space-between;">
                                <label>é™„ä»¶ ğŸ“</label>
                                <div style="position: relative;">
                                    <input type="file" id="cloudFile" style="display: none;">
                                    <span id="uploadBtn" class="add-icon" title="æ·»åŠ é™„ä»¶" style="font-size: 20px;">+</span>
                                    <span id="uploadStatus" style="font-size: 12px; color: #666; margin-right: 10px;"></span>
                                </div>
                            </div>
                            
                            <div id="attachmentDropZone" style="border: 2px dashed #ddd; border-radius: 4px; padding: 20px; text-align: center; color: #999; display: none; margin-bottom: 10px;">
                                æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ 
                            </div>

                            <div id="attachmentListContainer">
                                </div>
                        </div>
                    </form>
                `;
                
                // ç»‘å®šæ·»åŠ æŒ‡æ ‡äº‹ä»¶
                document.getElementById('addIndicatorBtn').addEventListener('click', () => {
                    this.addAbnormalIndicator();
                });
                
                // ç»‘å®šå¯¼å…¥æŒ‡æ ‡äº‹ä»¶
                document.getElementById('importIndicatorsBtn').addEventListener('click', () => {
                    this.showImportIndicatorsModal();
                });
                
                // ç»‘å®šè‡ªåŠ¨ä¿å­˜äº‹ä»¶
                this.bindPeriodAutoSaveEvents();

                // === æ–°å¢ï¼šç»‘å®šé™„ä»¶åŠŸèƒ½ ===
            // 1. æ¸²æŸ“ç°æœ‰åˆ—è¡¨
            this.renderAttachments(period);

            // 2. ç»‘å®šåŠ å·å›¾æ ‡ç‚¹å‡»
            const fileInput = document.getElementById('cloudFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const dropZone = document.getElementById('attachmentDropZone');
            
            if(uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', () => fileInput.click());
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        // é™åˆ¶ 20MB
                        if (e.target.files[0].size > 20 * 1024 * 1024) {
                            alert('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·å°äº 20MB');
                            return;
                        }
                        this.uploadToCloudinary(e.target.files[0]);
                    }
                });
            }

            // 3. ç»‘å®šæ‹–æ‹½äº‹ä»¶
            const attachArea = uploadBtn.parentElement.parentElement; 
            
            // æ‹–å…¥æ—¶æ˜¾ç¤ºè™šçº¿æ¡†
            attachArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.display = 'block';
                dropZone.style.borderColor = '#787785';
                dropZone.style.backgroundColor = '#f8f9fa';
            });

            // æ‹–å‡ºæˆ–æ”¾ä¸‹å
            attachArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                const rect = attachArea.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX >= rect.right || e.clientY < rect.top || e.clientY >= rect.bottom) {
                    dropZone.style.display = 'none';
                }
            });

            attachArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.display = 'none'; 
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.size > 20 * 1024 * 1024) {
                        alert('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·å°äº 20MB');
                        return;
                    }
                    this.uploadToCloudinary(file);
                }
            });
            },
            
            // æ¸²æŸ“å¼‚å¸¸æ£€æµ‹æŒ‡æ ‡
            renderAbnormalIndicators(indicators) {
                if (indicators.length === 0) {
                    return '';
                }
                
                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>æŒ‡æ ‡åç§°</th><th>æ•°å€¼</th><th>å•ä½</th><th>å‚è€ƒèŒƒå›´</th><th>æµ‹é‡æ—¶é—´</th><th>æ£€æµ‹æœºæ„</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                indicators.forEach((indicator, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${indicator.name || ''}" data-index="${index}" data-field="name"></td>
                            <td><input type="text" value="${indicator.value || ''}" data-index="${index}" data-field="value"></td>
                            <td><input type="text" value="${indicator.unit || ''}" data-index="${index}" data-field="unit"></td>
                            <td><input type="text" value="${indicator.reference || ''}" data-index="${index}" data-field="reference"></td>
                            <td><input type="date" value="${indicator.measurementDate || ''}" data-index="${index}" data-field="measurementDate"></td>
                            <td><input type="text" value="${indicator.testingInstitution || ''}" data-index="${index}" data-field="testingInstitution"></td>
                            <td>
    <div class="delete-row-icon remove-indicator" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šåˆ é™¤äº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-indicator').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeAbnormalIndicator(index);
                        });
                    });
                    
                    // ç»‘å®šè¾“å…¥å˜åŒ–äº‹ä»¶
                    document.querySelectorAll('#abnormalIndicatorsContainer input').forEach(input => {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateAbnormalIndicator(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // === æ–°å¢ï¼šæ¸²æŸ“é™„ä»¶åˆ—è¡¨ ===
            renderAttachments(period) {
                const container = document.getElementById('attachmentListContainer');
                if (!container) return;
                container.innerHTML = '';
                
                // ç¡®ä¿æ•°æ®ç»“æ„é‡Œæœ‰ attachments æ•°ç»„
                const attachments = period.attachments || [];
                
                if (attachments.length === 0) {
                    // æ²¡æ–‡ä»¶æ—¶éšè—åˆ—è¡¨å®¹å™¨ï¼Œä¿æŒç•Œé¢å¹²å‡€
                    container.style.display = 'none';
                    return;
                }
                
                container.style.display = 'block';
                
                attachments.forEach((file, index) => {
                    // æ ¹æ®æ–‡ä»¶åç¼€åˆ¤æ–­å›¾æ ‡
                    let icon = 'ğŸ“„';
                    if (file.name.endsWith('.pdf')) icon = 'ğŸ“•';
                    if (file.name.match(/\.(doc|docx)$/)) icon = 'ğŸ“˜';
                    if (file.name.match(/\.(jpg|jpeg|png)$/)) icon = 'ğŸ–¼ï¸';

                    const div = document.createElement('div');
                    // æ ·å¼ï¼šæç®€è¡Œå†…æ ·å¼ï¼Œé¼ æ ‡æ‚¬åœå˜è‰²
                    div.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px;";
                    
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; overflow: hidden;">
                            <span style="margin-right: 8px; font-size: 16px;">${icon}</span>
                            <a href="${file.url}" target="_blank" style="text-decoration: none; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;" title="${file.name}">${file.name}</a>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <span class="delete-attachment-icon" data-index="${index}" style="cursor: pointer; color: #dc3545; font-weight: bold; font-size: 16px;" title="åˆ é™¤">Ã—</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                // ç»‘å®šåˆ é™¤äº‹ä»¶
                container.querySelectorAll('.delete-attachment-icon').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if(confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªé™„ä»¶å—ï¼Ÿ')) {
                            const idx = e.target.getAttribute('data-index');
                            this.currentPeriod.attachments.splice(idx, 1);
                            this.renderAttachments(this.currentPeriod);
                            this.autoSavePeriodInfo(); // è‡ªåŠ¨ä¿å­˜
                        }
                    });
                });
            },

            // === æ–°å¢ï¼šæ‰§è¡Œ Cloudinary ä¸Šä¼  ===
            async uploadToCloudinary(file) {
                const status = document.getElementById('uploadStatus');
                status.textContent = 'â³ æ­£åœ¨ä¸Šä¼ ...';
                
                // ============ é…ç½®åŒº (è¯·å¡«å…¥ä½ çš„ Cloudinary ä¿¡æ¯) ============
                const CLOUD_NAME = 'dtqjeak7u';
                const UPLOAD_PRESET = 'customer_files';
                // ===========================================================

                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);
                formData.append('resource_type', 'auto'); // è‡ªåŠ¨è¯†åˆ« PDF/Word/å›¾ç‰‡

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('ä¸Šä¼ äº‘ç«¯å¤±è´¥');

                    const data = await response.json();
                    
                    // åˆå§‹åŒ–é™„ä»¶æ•°ç»„
                    if (!this.currentPeriod.attachments) {
                        this.currentPeriod.attachments = [];
                    }
                    
                    // å­˜å…¥æ•°æ®
                    this.currentPeriod.attachments.push({
                        name: file.name,
                        url: data.secure_url, // æ°¸ä¹…é“¾æ¥
                        uploadDate: new Date().toISOString()
                    });

                    status.textContent = 'âœ…';
                    setTimeout(() => status.textContent = '', 2000);
                    
                    // åˆ·æ–°åˆ—è¡¨å¹¶ä¿å­˜
                    this.renderAttachments(this.currentPeriod);
                    this.autoSavePeriodInfo();

                } catch (error) {
                    console.error(error);
                    status.textContent = 'âŒ å¤±è´¥';
                    status.title = error.message;
                    status.style.color = 'red';
                }
            },
            
            // æ¸²æŸ“ä¼å¾®æ²Ÿé€šè®°å½•
            renderCommunicationRecords(records) {
                if (records.length === 0) {
                    return '';
                }
                
                let html = '<table class="followup-table"><thead><tr><th>æ—¥æœŸ</th><th>å…³é”®è¯</th><th>å®¢è¯‰å†…å®¹</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="date" value="${record.date || ''}" data-index="${index}" data-field="date"></td>
                            <td><input type="text" value="${record.keyword || ''}" data-index="${index}" data-field="keyword"></td>
                            <td><textarea data-index="${index}" data-field="content" rows="2">${record.content || ''}</textarea></td>
                            <td>
    <div class="delete-row-icon remove-communication" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šåˆ é™¤äº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-communication').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeCommunicationRecord(index);
                        });
                    });
                    
                    // ç»‘å®šè¾“å…¥å˜åŒ–äº‹ä»¶
                    document.querySelectorAll('#communicationRecordsContainer input, #communicationRecordsContainer textarea').forEach(input => {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateCommunicationRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },
            
            // æ¸²æŸ“å›è®¿è®°å½•
            renderFollowUpRecords(records) {
                if (records.length === 0) {
                    return '';
                }
                
                let html = '<table class="followup-table"><thead><tr><th>æ—¥æœŸ</th><th>é¡¹ç›®åç§°</th><th>å›è®¿å†…å®¹</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="date" value="${record.date || ''}" data-index="${index}" data-field="date"></td>
                            <td><input type="text" value="${record.project || ''}" data-index="${index}" data-field="project"></td>
                            <td><textarea data-index="${index}" data-field="reason" rows="2">${record.reason || ''}</textarea></td>
                            <td>
    <div class="delete-row-icon remove-followup" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šåˆ é™¤äº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-followup').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeFollowUpRecord(index);
                        });
                    });
                    
                    // ç»‘å®šè¾“å…¥å˜åŒ–äº‹ä»¶
                    document.querySelectorAll('#followUpRecordsContainer input, #followUpRecordsContainer textarea').forEach(input => {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateFollowUpRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },
            
            // æ·»åŠ å¼‚å¸¸æ£€æµ‹æŒ‡æ ‡
            addAbnormalIndicator() {
                if (!this.currentPeriod.abnormalIndicators) {
                    this.currentPeriod.abnormalIndicators = [];
                }
                
                this.currentPeriod.abnormalIndicators.push({
                    name: '',
                    value: '',
                    unit: '',
                    reference: '',
                    measurementDate: new Date().toISOString().split('T')[0],
                    testingInstitution: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // åˆ é™¤å¼‚å¸¸æ£€æµ‹æŒ‡æ ‡
            removeAbnormalIndicator(index) {
                this.currentPeriod.abnormalIndicators.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // æ›´æ–°å¼‚å¸¸æ£€æµ‹æŒ‡æ ‡
            updateAbnormalIndicator(index, field, value) {
                if (!this.currentPeriod.abnormalIndicators) {
                    this.currentPeriod.abnormalIndicators = [];
                }
                this.currentPeriod.abnormalIndicators[index][field] = value;
                this.autoSavePeriodInfo();
            },
            
            // æ·»åŠ æ²Ÿé€šè®°å½•
            addCommunicationRecord() {
                if (!this.currentPeriod.communicationRecords) {
                    this.currentPeriod.communicationRecords = [];
                }
                
                this.currentPeriod.communicationRecords.push({
                    date: new Date().toISOString().split('T')[0],
                    keyword: '',
                    content: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // åˆ é™¤æ²Ÿé€šè®°å½•
            removeCommunicationRecord(index) {
                this.currentPeriod.communicationRecords.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // æ›´æ–°æ²Ÿé€šè®°å½•
            updateCommunicationRecord(index, field, value) {
                if (!this.currentPeriod.communicationRecords) {
                    this.currentPeriod.communicationRecords = [];
                }
                this.currentPeriod.communicationRecords[index][field] = value;
                this.autoSavePeriodInfo();
            },
            
            // æ·»åŠ å›è®¿è®°å½•
            addFollowUpRecord() {
                if (!this.currentPeriod.followUpRecords) {
                    this.currentPeriod.followUpRecords = [];
                }
                
                this.currentPeriod.followUpRecords.push({
                    date: new Date().toISOString().split('T')[0],
                    project: '',
                    reason: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // åˆ é™¤å›è®¿è®°å½•
            removeFollowUpRecord(index) {
                this.currentPeriod.followUpRecords.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // æ›´æ–°å›è®¿è®°å½•
            updateFollowUpRecord(index, field, value) {
                if (!this.currentPeriod.followUpRecords) {
                    this.currentPeriod.followUpRecords = [];
                }
                this.currentPeriod.followUpRecords[index][field] = value;
                this.autoSavePeriodInfo();
            },
            
            // ç»‘å®šè´¦æœŸè‡ªåŠ¨ä¿å­˜äº‹ä»¶
            bindPeriodAutoSaveEvents() {
                // ä¸ºæ‰€æœ‰è¾“å…¥å…ƒç´ ç»‘å®šè‡ªåŠ¨ä¿å­˜
                const inputs = document.querySelectorAll('#periodForm input, #periodForm select, #periodForm textarea');
                inputs.forEach(input => {
                    // è¾“å…¥æ¡†å¤±ç„¦æ—¶ä¿å­˜
                    input.addEventListener('blur', () => {
                        this.autoSavePeriodInfo();
                    });
                    
                    // æ–‡æœ¬åŒºåŸŸä½¿ç”¨é˜²æŠ–ä¿å­˜
                    if (input.tagName === 'TEXTAREA') {
                        input.addEventListener('input', () => {
                            clearTimeout(this.autoSaveTimeout);
                            this.autoSaveTimeout = setTimeout(() => {
                                this.autoSavePeriodInfo();
                            }, 2000);
                        });
                    }
                });
            },
            
            // è‡ªåŠ¨ä¿å­˜è´¦æœŸä¿¡æ¯
            async autoSavePeriodInfo() {
                await this.savePeriodInfo(false);
            },
            
            // æ¸²æŸ“æŒ‡æ ‡å¯¹æ¯”
            renderIndicatorsCompare() {
                if (!this.currentCustomer) return;
                
                // è·å–æ‰€æœ‰æŒ‡æ ‡åç§°
                let indicatorNames = CustomerModel.getAllIndicatorNames(this.currentCustomer);
                
                // æ ¹æ®æœç´¢æ¡ä»¶è¿‡æ»¤æŒ‡æ ‡åç§°
                if (this.indicatorSearchTerm) {
                    indicatorNames = indicatorNames.filter(name => 
                        name.toLowerCase().includes(this.indicatorSearchTerm)
                    );
                }
                
                if (indicatorNames.length === 0) {
                    document.getElementById('indicatorsTableContainer').innerHTML = '<p>æš‚æ— æŒ‡æ ‡æ•°æ®</p>';
                    return;
                }
                
                // æ”¶é›†æŒ‡æ ‡æ•°æ®
                const indicatorData = {};
                const datePeriodMap = {}; // å­˜å‚¨æ—¥æœŸåˆ°è´¦æœŸç¼–å·çš„æ˜ å°„
                const indicatorRecords = {}; // å­˜å‚¨æŒ‡æ ‡è®°å½•è¯¦æƒ…
                const referenceRanges = {}; // å­˜å‚¨æŒ‡æ ‡çš„å‚è€ƒèŒƒå›´
                
                indicatorNames.forEach(indicator => {
                    indicatorData[indicator] = [];
                });
                
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.abnormalIndicators) {
                            period.abnormalIndicators.forEach(indicator => {
                                if (indicatorNames.includes(indicator.name)) {
                                    indicatorData[indicator.name].push({
                                        period: period.periodName,
                                        value: indicator.value,
                                        measurementDate: indicator.measurementDate
                                    });
                                    
                                    // æå–è´¦æœŸç¼–å·ï¼ˆä»"01-20251011"ä¸­æå–"01"ï¼‰
                                    const periodNumber = period.periodName.split('-')[0];
                                    datePeriodMap[indicator.measurementDate] = periodNumber;
                                    
                                    // å­˜å‚¨æŒ‡æ ‡è®°å½•è¯¦æƒ…
                                    const key = `${indicator.name}_${indicator.measurementDate}`;
                                    indicatorRecords[key] = {
                                        ...indicator,
                                        periodId: period.periodId,
                                        periodName: period.periodName
                                    };
                                    
                                    // å­˜å‚¨ç¬¬ä¸€ä¸ªå‡ºç°çš„å‚è€ƒèŒƒå›´
                                    if (indicator.reference && !referenceRanges[indicator.name]) {
                                        referenceRanges[indicator.name] = indicator.reference;
                                    }
                                }
                            });
                        }
                    });
                }
                
                // æ¸²æŸ“è¡¨æ ¼
                this.renderIndicatorsTable(indicatorData, datePeriodMap, indicatorRecords, referenceRanges);
            },
            
            // æ¸²æŸ“æŒ‡æ ‡è¡¨æ ¼ - ä¿®æ”¹ï¼šåœ¨æ—¥æœŸåé¢åŠ ä¸Šè´¦æœŸç¼–å·ï¼Œå¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
            renderIndicatorsTable(indicatorData, datePeriodMap, indicatorRecords, referenceRanges) {
                const container = document.getElementById('indicatorsTableContainer');
                
                // æ”¶é›†æ‰€æœ‰æµ‹é‡æ—¥æœŸ
                const allDates = [];
                Object.keys(indicatorData).forEach(indicator => {
                    indicatorData[indicator].forEach(item => {
                        if (!allDates.includes(item.measurementDate)) {
                            allDates.push(item.measurementDate);
                        }
                    });
                });
                
                allDates.sort();
                
                // æ”¶é›†æ‰€æœ‰æŒ‡æ ‡åç§°å¹¶æ’åº
                const indicators = Object.keys(indicatorData).sort();
                
                let html = '<table class="indicators-table"><thead><tr><th>æŒ‡æ ‡åç§°</th><th>å‚è€ƒèŒƒå›´</th>';
                
                allDates.forEach(date => {
                    // åœ¨æ—¥æœŸåé¢åŠ ä¸Šè´¦æœŸç¼–å·
                    const periodNumber = datePeriodMap[date] || '';
                    const headerText = periodNumber ? `${date} (${periodNumber})` : date;
                    html += `<th>${headerText}</th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                indicators.forEach(indicator => {
                    html += `<tr><td>${indicator}</td><td>${referenceRanges[indicator] || '-'}</td>`;
                    
                    allDates.forEach(date => {
                        const item = indicatorData[indicator].find(d => d.measurementDate === date);
                        const value = item ? item.value : '-';
                        const key = `${indicator}_${date}`;
                        const hasRecord = indicatorRecords[key] !== undefined;
                        
                        // æ£€æŸ¥æ•°å€¼æ˜¯å¦åœ¨æ­£å¸¸èŒƒå›´å†…
                        let isNormal = false;
                        if (item && referenceRanges[indicator]) {
                            isNormal = this.isValueInNormalRange(item.value, referenceRanges[indicator]);
                        }
                        
                        // æ·»åŠ å¯ç‚¹å‡»æ ·å¼å’Œæ­£å¸¸å€¼æ ·å¼
                        const cellClass = hasRecord ? 'clickable-cell' : '';
                        const valueClass = isNormal ? 'normal-value' : '';
                        html += `<td class="${cellClass} ${valueClass}" data-indicator="${indicator}" data-date="${date}">${value}</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                container.innerHTML = html;
                
                // ç»‘å®šå•å…ƒæ ¼ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.clickable-cell').forEach(cell => {
                    cell.addEventListener('click', (e) => {
                        const indicator = e.target.getAttribute('data-indicator');
                        const date = e.target.getAttribute('data-date');
                        const key = `${indicator}_${date}`;
                        
                        if (indicatorRecords[key]) {
                            this.showIndicatorEditModal(indicatorRecords[key]);
                        }
                    });
                });
            },
            
            // æ£€æŸ¥æ•°å€¼æ˜¯å¦åœ¨æ­£å¸¸èŒƒå›´å†… - æ”¯æŒä¸‰ç§è¿æ¥ç¬¦
            isValueInNormalRange(value, referenceRange) {
                if (!value || !referenceRange) return false;
                
                try {
                    // è§£ææ•°å€¼
                    const numValue = parseFloat(value);
                    if (isNaN(numValue)) return false;
                    
                    // è§£æå‚è€ƒèŒƒå›´ï¼Œæ”¯æŒä¸‰ç§è¿æ¥ç¬¦ï¼š" - "ã€"ï½"ã€"~"
                    let rangeParts = [];
                    if (referenceRange.includes(' - ')) {
                        rangeParts = referenceRange.split(' - ');
                    } else if (referenceRange.includes('ï½')) {
                        rangeParts = referenceRange.split('ï½');
                    } else if (referenceRange.includes('~')) {
                        rangeParts = referenceRange.split('~');
                    } else {
                        return false;
                    }
                    
                    if (rangeParts.length !== 2) return false;
                    
                    const min = parseFloat(rangeParts[0]);
                    const max = parseFloat(rangeParts[1]);
                    
                    if (isNaN(min) || isNaN(max)) return false;
                    
                    return numValue >= min && numValue <= max;
                } catch (error) {
                    console.error('æ£€æŸ¥æ•°å€¼èŒƒå›´æ—¶å‡ºé”™:', error);
                    return false;
                }
            },
            
            // æ˜¾ç¤ºæŒ‡æ ‡ç¼–è¾‘æ¨¡æ€æ¡† - ä¿®å¤ï¼šä¿å­˜åŸå§‹æ•°æ®ç”¨äºæŸ¥æ‰¾
            showIndicatorEditModal(indicator) {
                // ä¿å­˜åŸå§‹æ•°æ®ï¼Œç”¨äºåœ¨ä¿å­˜æ—¶å®šä½åŸå§‹è®°å½•
                this.editingIndicator = {
                    ...indicator,
                    originalName: indicator.name, // ä¿å­˜åŸå§‹åç§°
                    originalMeasurementDate: indicator.measurementDate // ä¿å­˜åŸå§‹æµ‹é‡æ—¥æœŸ
                };
                
                document.getElementById('editIndicatorName').value = indicator.name || '';
                document.getElementById('editIndicatorValue').value = indicator.value || '';
                document.getElementById('editIndicatorUnit').value = indicator.unit || '';
                document.getElementById('editIndicatorReference').value = indicator.reference || '';
                document.getElementById('editIndicatorDate').value = indicator.measurementDate || '';
                document.getElementById('editIndicatorInstitution').value = indicator.testingInstitution || '';
                
                document.getElementById('indicatorEditModal').classList.add('active');
            },
            
            // ä¿å­˜æŒ‡æ ‡è®°å½• - ä¿®å¤ï¼šé€šè¿‡åŸå§‹åç§°å’Œæµ‹é‡æ—¥æœŸæ‰¾åˆ°åŸå§‹è®°å½•å¹¶æ›´æ–°
            async saveIndicatorRecord() {
                if (!this.editingIndicator) return;
                
                const name = document.getElementById('editIndicatorName').value;
                const value = document.getElementById('editIndicatorValue').value;
                const unit = document.getElementById('editIndicatorUnit').value;
                const reference = document.getElementById('editIndicatorReference').value;
                const measurementDate = document.getElementById('editIndicatorDate').value;
                const testingInstitution = document.getElementById('editIndicatorInstitution').value;
                
                // æ‰¾åˆ°å¯¹åº”çš„è´¦æœŸ
                const period = this.currentCustomer.periods.find(p => p.periodId === this.editingIndicator.periodId);
                if (period && period.abnormalIndicators) {
                    // ä½¿ç”¨åŸå§‹åç§°å’ŒåŸå§‹æµ‹é‡æ—¥æœŸæ¥æŸ¥æ‰¾è®°å½•
                    const index = period.abnormalIndicators.findIndex(i => 
                        i.name === this.editingIndicator.originalName && 
                        i.measurementDate === this.editingIndicator.originalMeasurementDate
                    );
                    
                    if (index !== -1) {
                        // æ›´æ–°è®°å½•
                        period.abnormalIndicators[index] = {
                            ...period.abnormalIndicators[index],
                            name: name,
                            value: value,
                            unit: unit,
                            reference: reference,
                            measurementDate: measurementDate,
                            testingInstitution: testingInstitution
                        };
                        
                        // ä¿å­˜æ•°æ®
                        await this.saveCustomerData();
                        
                        // åˆ·æ–°æŒ‡æ ‡å¯¹æ¯”è¡¨æ ¼
                        this.renderIndicatorsCompare();
                        
                        this.closeModal(document.getElementById('indicatorEditModal'));
                        this.showSaveNotification();
                    }
                }
            },
            
            // åˆ é™¤æŒ‡æ ‡è®°å½•
            async deleteIndicatorRecord() {
                if (!this.editingIndicator) return;
                
                // æ‰¾åˆ°å¯¹åº”çš„è´¦æœŸå’ŒæŒ‡æ ‡è®°å½•
                const period = this.currentCustomer.periods.find(p => p.periodId === this.editingIndicator.periodId);
                if (period && period.abnormalIndicators) {
                    const index = period.abnormalIndicators.findIndex(i => 
                        i.name === this.editingIndicator.name && 
                        i.measurementDate === this.editingIndicator.measurementDate
                    );
                    
                    if (index !== -1) {
                        period.abnormalIndicators.splice(index, 1);
                        
                        // ä¿å­˜æ•°æ®
                        await this.saveCustomerData();
                        
                        // åˆ·æ–°æŒ‡æ ‡å¯¹æ¯”è¡¨æ ¼
                        this.renderIndicatorsCompare();
                        
                        this.closeModal(document.getElementById('indicatorEditModal'));
                        this.showSaveNotification();
                    }
                }
            },
            
            // åˆ‡æ¢æ ‡ç­¾é¡µ - ä¿®æ”¹ï¼šæ·»åŠ å»¶è¿Ÿæ¸²æŸ“ä»¥é¿å…æŠ–åŠ¨
            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                // ä½¿ç”¨setTimeoutå»¶è¿Ÿæ¸²æŸ“ï¼Œé¿å…æŠ–åŠ¨
                if (tabName === 'indicators-compare') {
                    setTimeout(() => {
            this.renderIndicatorsCompare();
        }, 10);
    } else if (tabName === 'health-dashboard') {
                }
            },
            
            // åˆ·æ–°è´¦æœŸ
            async refreshPeriod() {
                const periodSelect = document.getElementById('periodSelect');
                const periodId = periodSelect.value;
                
                if (!this.currentCustomer || !periodId) {
                    console.error('æ— æ³•åˆ·æ–°ï¼šå½“å‰å®¢æˆ·æˆ–è´¦æœŸIDä¸ºç©º');
                    return;
                }
                
                // å…ˆä¿å­˜å½“å‰è´¦æœŸçš„æ•°æ®
                await this.savePeriodInfo(false);
                
                // ä»æ•°æ®ä¸­é‡æ–°åŠ è½½è´¦æœŸä¿¡æ¯ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                const data = await CustomerModel.loadData();
                const customer = data.customers.find(c => c.id === this.currentCustomer.id);
                
                if (!customer) {
                    console.error('å®¢æˆ·ä¸å­˜åœ¨');
                    return;
                }
                
                this.currentCustomer = customer;
                this.currentPeriod = customer.periods.find(p => p.periodId === periodId);
                
                if (!this.currentPeriod) {
                    console.error('è´¦æœŸä¸å­˜åœ¨');
                    return;
                }
                
                this.renderPeriodForm(this.currentPeriod);
                console.log('å·²åˆ‡æ¢åˆ°è´¦æœŸ:', this.currentPeriod.periodName);
            },
            
            // æ˜¾ç¤ºæ·»åŠ è´¦æœŸæ¨¡æ€æ¡†
            showAddPeriodModal() {
                document.getElementById('addPeriodModal').classList.add('active');
            },
            
            // æ˜¾ç¤ºä¿®æ”¹è´¦æœŸæ¨¡æ€æ¡†
            showEditPeriodModal() {
                if (!this.currentPeriod) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè´¦æœŸ');
                    return;
                }
                
                // è§£æå½“å‰è´¦æœŸåç§°ï¼Œè·å–ç¼–å·å’Œæ—¥æœŸ
                const periodName = this.currentPeriod.periodName;
                const match = periodName.match(/^(\d{2})-(\d{4})(\d{2})(\d{2})$/);
                
                if (!match) {
                    alert('è´¦æœŸæ ¼å¼ä¸æ­£ç¡®');
                    return;
                }
                
                const periodNumber = match[1];
                const year = match[2];
                const month = match[3];
                const day = match[4];
                const dateStr = `${year}-${month}-${day}`;
                
                document.getElementById('editPeriodNumber').value = periodNumber;
                document.getElementById('editPeriodDate').value = dateStr;
                
                document.getElementById('editPeriodModal').classList.add('active');
            },
            
            // æ·»åŠ è´¦æœŸ
            async addPeriod() {
                const periodDate = document.getElementById('newPeriodDate').value;
                
                if (!periodDate) {
                    alert('è¯·é€‰æ‹©è´¦æœŸæ—¥æœŸ');
                    return;
                }
                
                try {
                    // å…ˆä¿å­˜å½“å‰è´¦æœŸçš„æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (this.currentPeriod) {
                        await this.savePeriodInfo(false);
                    }
                    
                    const periodName = CustomerModel.generatePeriodName(periodDate, this.currentCustomer);
                    
                    if (!this.currentCustomer.periods) {
                        this.currentCustomer.periods = [];
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè´¦æœŸ
                    const existingPeriod = this.currentCustomer.periods.find(p => p.periodName === periodName);
                    if (existingPeriod) {
                        alert('è¯¥è´¦æœŸå·²å­˜åœ¨');
                        return;
                    }
                    
                    const newPeriod = {
                        periodId: `P${Date.now()}`,
                        periodName: periodName,
                        periodDate: periodDate,
                        abnormalIndicators: [],
                        communicationRecords: [],
                        dietaryHabits: [],
                        physicalActivity: [],
                        sleepPattern: [],
                        stressMentalHealth: '',
                        environmentOccupational: '',
                        subjectiveHealth: '',
                        followUpRecords: [],
                        financialStats: []
                    };
                    
                    this.currentCustomer.periods.push(newPeriod);
                    
                    // ç«‹å³ä¿å­˜å®¢æˆ·æ•°æ®
                    await this.saveCustomerData();
                    
                    // æ›´æ–°ä¸‹æ¬¡äº¤ä»˜æ—¶é—´ï¼ˆè€ƒè™‘å‰©ä½™æœŸæ•°æ˜¯å¦ä¸º0ï¼‰
                    this.updateNextDeliveryDate();
                    
                    this.closeModal(document.getElementById('addPeriodModal'));
                    this.renderPeriodSelector(this.currentCustomer);
                    
                    // è‡ªåŠ¨é€‰æ‹©æ–°æ·»åŠ çš„è´¦æœŸ
                    const periodSelect = document.getElementById('periodSelect');
                    periodSelect.value = newPeriod.periodId;
                    this.currentPeriod = newPeriod;
                    this.renderPeriodForm(this.currentPeriod);
                    
                    // æ›´æ–°æœåŠ¡è¿›åº¦
                    this.updateServiceProgress();
                    
                    console.log('æ–°è´¦æœŸå·²åˆ›å»º:', periodName);
                } catch (error) {
                    console.error('åˆ›å»ºè´¦æœŸæ—¶å‡ºé”™:', error);
                    alert('åˆ›å»ºè´¦æœŸå¤±è´¥');
                }
            },
            
            // ä¿®æ”¹è´¦æœŸ
            async editPeriod() {
                const periodDate = document.getElementById('editPeriodDate').value;
                const periodNumber = document.getElementById('editPeriodNumber').value;
                
                if (!periodDate) {
                    alert('è¯·é€‰æ‹©è´¦æœŸæ—¥æœŸ');
                    return;
                }
                
                try {
                    // ç”Ÿæˆæ–°çš„è´¦æœŸåç§°ï¼ˆä¿æŒç¼–å·ä¸å˜ï¼Œåªä¿®æ”¹æ—¥æœŸéƒ¨åˆ†ï¼‰
                    const dateObj = new Date(periodDate);
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    const newPeriodName = `${periodNumber}-${dateStr}`;
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè´¦æœŸ
                    const existingPeriod = this.currentCustomer.periods.find(p => p.periodName === newPeriodName && p.periodId !== this.currentPeriod.periodId);
                    if (existingPeriod) {
                        alert('è¯¥è´¦æœŸå·²å­˜åœ¨');
                        return;
                    }
                    
                    // æ›´æ–°å½“å‰è´¦æœŸçš„åç§°å’Œæ—¥æœŸ
                    this.currentPeriod.periodName = newPeriodName;
                    this.currentPeriod.periodDate = periodDate;
                    
                    // ä¿å­˜æ•°æ®
                    await this.saveCustomerData();
                    
                    // åˆ·æ–°ç•Œé¢
                    this.renderPeriodSelector(this.currentCustomer);
                    this.renderPeriodForm(this.currentPeriod);
                    
                    this.closeModal(document.getElementById('editPeriodModal'));
                    this.showSaveNotification();
                    
                    console.log('è´¦æœŸå·²ä¿®æ”¹ä¸º:', newPeriodName);
                } catch (error) {
                    console.error('ä¿®æ”¹è´¦æœŸæ—¶å‡ºé”™:', error);
                    alert('ä¿®æ”¹è´¦æœŸå¤±è´¥');
                }
            },
            
            // æ›´æ–°æœåŠ¡è¿›åº¦
            updateServiceProgress() {
                const latestPeriod = CustomerModel.getLatestPeriod(this.currentCustomer);
                const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                document.getElementById('serviceProgress').value = serviceProgress;
                
                // æ›´æ–°å®¢æˆ·æ•°æ®ä¸­çš„æœåŠ¡è¿›åº¦
                this.currentCustomer.personalInfo.serviceProgress = serviceProgress;
                this.saveCustomerData();
            },
            
            // æ›´æ–°ä¸‹æ¬¡äº¤ä»˜æ—¶é—´
            updateNextDeliveryDate() {
                const nextDeliveryDate = CustomerModel.getNextDeliveryDate(this.currentCustomer);
                document.getElementById('nextDeliveryDate').value = nextDeliveryDate;
                
                // æ›´æ–°å®¢æˆ·æ•°æ®ä¸­çš„ä¸‹æ¬¡äº¤ä»˜æ—¶é—´
                this.currentCustomer.personalInfo.nextDeliveryDate = nextDeliveryDate;
                this.saveCustomerData();
            },
                
            
            // æ˜¾ç¤ºå¯¼å…¥æŒ‡æ ‡æ¨¡æ€æ¡†
            showImportIndicatorsModal() {
                document.getElementById('importIndicatorsModal').classList.add('active');
            },
            
            // æ–°å¢ï¼šä¸‹è½½Excelæ¨¡æ¿ - æ”¹è¿›æ¨¡æ¿æ ¼å¼
            downloadExcelTemplate() {
                const templateContent = "æŒ‡æ ‡åç§°\tæ•°å€¼\tå•ä½\tå‚è€ƒèŒƒå›´\tæµ‹é‡æ—¶é—´\tæ£€æµ‹æœºæ„\nè¡€ç³–\t5.5\tmmol/L\t3.9-6.1\t2023-10-01\tXXæ£€æµ‹ä¸­å¿ƒ\nè¡€å‹\t120/80\tmmHg\t90/60-140/90\t2023-10-01\tXXæ£€æµ‹ä¸­å¿ƒ\nèƒ†å›ºé†‡\t4.5\tmmol/L\t0-5.2\t2023-10-01\tXXæ£€æµ‹ä¸­å¿ƒ";
                
                const blob = new Blob([templateContent], {type: 'text/plain;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'æŒ‡æ ‡å¯¼å…¥æ¨¡æ¿.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('æ¨¡æ¿å·²ä¸‹è½½ï¼è¯·ç”¨Excelæ‰“å¼€æ­¤æ–‡ä»¶ï¼Œå¡«å†™æ•°æ®åå¤åˆ¶æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬æ ‡é¢˜è¡Œï¼‰ç²˜è´´åˆ°ç³»ç»Ÿä¸­ã€‚');
            },
            
            // å¯¼å…¥æŒ‡æ ‡ - ä¿®å¤è§£æé€»è¾‘
            async importIndicators() {
                const measurementDate = document.getElementById('measurementDate').value;
                const testingInstitution = document.getElementById('testingInstitution').value;
                const pastedData = document.getElementById('pastedExcelData').value;
                
                if (!pastedData) {
                    alert('è¯·å…ˆç²˜è´´Excelæ•°æ®');
                    return;
                }
                
                try {
                    // è§£æç²˜è´´çš„æ•°æ®
                    const lines = pastedData.trim().split('\n');
                    const indicators = [];
                    
                    // æŸ¥æ‰¾æ ‡é¢˜è¡Œï¼Œç¡®å®šåˆ—çš„é¡ºåº
                    let nameIndex = -1, valueIndex = -1, unitIndex = -1, 
                        referenceIndex = -1, dateIndex = -1, institutionIndex = -1;
                    
                    if (lines.length > 0) {
                        const headerLine = lines[0].toLowerCase();
                        const headers = this.parseLine(headerLine);
                        
                        // æŸ¥æ‰¾å„åˆ—çš„ç´¢å¼•ä½ç½®
                        nameIndex = headers.findIndex(h => h.includes('æŒ‡æ ‡') || h.includes('åç§°'));
                        valueIndex = headers.findIndex(h => h.includes('æ•°å€¼') || h.includes('å€¼'));
                        unitIndex = headers.findIndex(h => h.includes('å•ä½'));
                        referenceIndex = headers.findIndex(h => h.includes('å‚è€ƒ') || h.includes('èŒƒå›´'));
                        dateIndex = headers.findIndex(h => h.includes('æµ‹é‡') || h.includes('æ—¶é—´') || h.includes('æ—¥æœŸ'));
                        institutionIndex = headers.findIndex(h => h.includes('æ£€æµ‹') || h.includes('æœºæ„'));
                    }
                    
                    // ä»ç¬¬äºŒè¡Œå¼€å§‹è§£ææ•°æ®ï¼ˆè·³è¿‡æ ‡é¢˜è¡Œï¼‰
                    const startIndex = (nameIndex >= 0 && valueIndex >= 0) ? 1 : 0;
                    
                    for (let i = startIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const parts = this.parseLine(line);
                        
                        if (parts.length < 2) continue; // è‡³å°‘éœ€è¦æŒ‡æ ‡åç§°å’Œæ•°å€¼
                        
                        // æ ¹æ®åˆ—ç´¢å¼•è·å–æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ ‡é¢˜è¡Œåˆ™æŒ‰é¡ºåº
                        const indicator = {
                            name: nameIndex >= 0 ? parts[nameIndex] || '' : parts[0] || '',
                            value: valueIndex >= 0 ? parts[valueIndex] || '' : parts[1] || '',
                            unit: unitIndex >= 0 ? (parts[unitIndex] || '') : (parts[2] || ''),
                            reference: referenceIndex >= 0 ? (parts[referenceIndex] || '') : (parts[3] || ''),
                            measurementDate: dateIndex >= 0 ? (parts[dateIndex] || '') : (parts[4] || ''),
                            testingInstitution: institutionIndex >= 0 ? (parts[institutionIndex] || '') : (parts[5] || '')
                        };
                        
                        // éªŒè¯å¿…è¦å­—æ®µ
                        if (!indicator.name || !indicator.value) {
                            console.warn('è·³è¿‡æ— æ•ˆæ•°æ®è¡Œ:', line);
                            continue;
                        }
                        
                        // å¦‚æœè¡¨å•ä¸­æœ‰å¡«å†™æµ‹é‡æ—¥æœŸå’Œæ£€æµ‹æœºæ„ï¼Œåˆ™è¦†ç›–
                        if (measurementDate) {
                            indicator.measurementDate = measurementDate;
                        }
                        if (testingInstitution) {
                            indicator.testingInstitution = testingInstitution;
                        }
                        
                        // å¦‚æœæ²¡æœ‰æµ‹é‡æ—¥æœŸï¼Œä½¿ç”¨ä»Šå¤©
                        if (!indicator.measurementDate) {
                            indicator.measurementDate = new Date().toISOString().split('T')[0];
                        }
                        
                        indicators.push(indicator);
                    }
                    
                    if (indicators.length === 0) {
                        alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æŒ‡æ ‡æ•°æ®ï¼Œè¯·æ£€æŸ¥ç²˜è´´æ ¼å¼ã€‚ç¡®ä¿åŒ…å«æŒ‡æ ‡åç§°å’Œæ•°å€¼åˆ—ã€‚');
                        return;
                    }
                    
                    // æ·»åŠ åˆ°å½“å‰è´¦æœŸ
                    if (!this.currentPeriod.abnormalIndicators) {
                        this.currentPeriod.abnormalIndicators = [];
                    }
                    
                    this.currentPeriod.abnormalIndicators.push(...indicators);
                    
                    // ä¿å­˜æ•°æ®
                    await this.saveCustomerData();
                    
                    // åˆ·æ–°ç•Œé¢
                    this.renderPeriodForm(this.currentPeriod);
                    
                    this.closeModal(document.getElementById('importIndicatorsModal'));
                    this.showSaveNotification();
                    
                    alert(`æˆåŠŸå¯¼å…¥ ${indicators.length} ä¸ªæŒ‡æ ‡`);
                    
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    alert('å¯¼å…¥å¤±è´¥: ' + error.message + '\n\nè¯·ç¡®ä¿ç²˜è´´çš„æ•°æ®åŒ…å«æŒ‡æ ‡åç§°å’Œæ•°å€¼ï¼Œå¹¶ç”¨åˆ¶è¡¨ç¬¦æˆ–é€—å·åˆ†éš”ã€‚');
                }
            },
            
            // æ–°å¢ï¼šä»JSONæ–‡ä»¶å¯¼å…¥æŒ‡æ ‡
            async importIndicatorsFromJSON(file) {
                if (!file) {
                    alert('è¯·é€‰æ‹©JSONæ–‡ä»¶');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        let indicators = [];
                        
                        // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šæŒ‡æ ‡æ•°ç»„æˆ–åŒ…å«indicatorså­—æ®µçš„å¯¹è±¡
                        if (Array.isArray(importedData)) {
                            indicators = importedData;
                        } else if (importedData.indicators && Array.isArray(importedData.indicators)) {
                            indicators = importedData.indicators;
                        } else {
                            throw new Error('JSONæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæŒ‡æ ‡æ•°ç»„æˆ–åŒ…å«indicatorså­—æ®µçš„å¯¹è±¡');
                        }
                        
                        if (indicators.length === 0) {
                            alert('JSONæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æŒ‡æ ‡æ•°æ®');
                            return;
                        }
                        
                        const measurementDate = document.getElementById('measurementDate').value;
                        const testingInstitution = document.getElementById('testingInstitution').value;
                        
                        // å¤„ç†æ¯ä¸ªæŒ‡æ ‡ï¼Œåº”ç”¨è¡¨å•ä¸­çš„æµ‹é‡æ—¥æœŸå’Œæ£€æµ‹æœºæ„
                        indicators.forEach(indicator => {
                            if (measurementDate) {
                                indicator.measurementDate = measurementDate;
                            }
                            if (testingInstitution) {
                                indicator.testingInstitution = testingInstitution;
                            }
                            // å¦‚æœæ²¡æœ‰æµ‹é‡æ—¥æœŸï¼Œä½¿ç”¨ä»Šå¤©
                            if (!indicator.measurementDate) {
                                indicator.measurementDate = new Date().toISOString().split('T')[0];
                            }
                        });
                        
                        // æ·»åŠ åˆ°å½“å‰è´¦æœŸ
                        if (!this.currentPeriod.abnormalIndicators) {
                            this.currentPeriod.abnormalIndicators = [];
                        }
                        
                        this.currentPeriod.abnormalIndicators.push(...indicators);
                        
                        // ä¿å­˜æ•°æ®
                        await this.saveCustomerData();
                        
                        // åˆ·æ–°ç•Œé¢
                        this.renderPeriodForm(this.currentPeriod);
                        
                        this.closeModal(document.getElementById('importIndicatorsModal'));
                        this.showSaveNotification();
                        
                        alert(`æˆåŠŸå¯¼å…¥ ${indicators.length} ä¸ªæŒ‡æ ‡`);
                        
                    } catch (error) {
                        alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                    }
                };
                reader.readAsText(file);
            },
            
            // æ–°å¢ï¼šè§£æè¡Œæ•°æ®ï¼Œæ”¯æŒåˆ¶è¡¨ç¬¦å’Œé€—å·åˆ†éš”
            parseLine(line) {
                // å…ˆå°è¯•åˆ¶è¡¨ç¬¦åˆ†éš”ï¼ˆExcelå¤åˆ¶çš„å†…å®¹é€šå¸¸æ˜¯åˆ¶è¡¨ç¬¦ï¼‰
                if (line.includes('\t')) {
                    return line.split('\t').map(cell => cell.trim());
                }
                // ç„¶åå°è¯•é€—å·åˆ†éš”
                else if (line.includes(',')) {
                    return line.split(',').map(cell => cell.trim());
                }
                // æœ€åå°è¯•ç©ºæ ¼åˆ†éš”
                else {
                    return line.split(/\s+/).map(cell => cell.trim());
                }
            },
            
            // æ–°å¢ï¼šå¯¼å‡ºå®¢æˆ·åˆ—è¡¨Excel
            async exportCustomerListExcel() {
                const data = await CustomerModel.loadData();
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const customerServiceSearch = document.getElementById('customerServiceSearch').value.toLowerCase();
                const startPeriod = document.getElementById('startPeriod').value;
                const endPeriod = document.getElementById('endPeriod').value;
                
                // è¿‡æ»¤å®¢æˆ·ï¼ˆä¸å®¢æˆ·åˆ—è¡¨ç›¸åŒçš„è¿‡æ»¤æ¡ä»¶ï¼‰
                let filteredCustomers = data.customers.filter(customer => {
                    const matchesSearch = customer.personalInfo.name.toLowerCase().includes(searchTerm);
                    
                    // ä¿®å¤é¡¾é—®è¿‡æ»¤æ¡ä»¶ï¼šå½“é¡¾é—®æœç´¢æ¡†ä¸ºç©ºæ—¶ï¼Œä¸è¿‡æ»¤ä»»ä½•å®¢æˆ·
                    const matchesCustomerService = !customerServiceSearch || 
                        (customer.personalInfo.customerService && 
                         customer.personalInfo.customerService.toLowerCase().includes(customerServiceSearch));
                    
                    // æ£€æŸ¥ä¸‹æ¬¡äº¤ä»˜æ—¶é—´åŒºé—´
                    let matchesPeriod = true;
                    if (startPeriod && endPeriod) {
                        const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                        if (!nextDeliveryDate) {
                            matchesPeriod = false;
                        } else {
                            matchesPeriod = nextDeliveryDate >= startPeriod && nextDeliveryDate <= endPeriod;
                        }
                    }
                    
                    return matchesSearch && matchesCustomerService && matchesPeriod;
                });

                // ç”ŸæˆCSVå†…å®¹ï¼ˆæ·»åŠ BOMå¤´è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ï¼‰
                let csvContent = "\uFEFFå®¢æˆ·å§“å,æ€§åˆ«,å¹´é¾„,æœåŠ¡è¿›åº¦,é”€å”®,é¡¾é—®,ä¸‹æ¬¡äº¤ä»˜æ—¶é—´,å‰©ä½™æœŸæ•°\n";
                
                filteredCustomers.forEach(customer => {
                    const latestPeriod = CustomerModel.getLatestPeriod(customer);
                    const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                    const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                    const remainingPeriods = CustomerModel.getRemainingPeriods(customer);
                    
                    csvContent += `"${customer.personalInfo.name}","${customer.personalInfo.gender}",${customer.personalInfo.age},"${serviceProgress}","${customer.personalInfo.sales}","${customer.personalInfo.customerService}","${nextDeliveryDate}",${remainingPeriods}\n`;
                });
                
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å®¢æˆ·åˆ—è¡¨_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // æ–°å¢ï¼šå¯¼å‡ºæœåŠ¡è´¦æœŸåˆ—è¡¨Excel
            async exportPeriodListExcel() {
                const data = await CustomerModel.loadData();
                
                // æ”¶é›†æ‰€æœ‰è´¦æœŸæ•°æ®
                let periodData = [];
                
                data.customers.forEach(customer => {
                    if (customer.periods && customer.periods.length > 0) {
                        customer.periods.forEach(period => {
                            const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                            const remainingPeriods = CustomerModel.getRemainingPeriods(customer);
                            
                            periodData.push({
                                periodDate: period.periodDate,
                                customerName: customer.personalInfo.name,
                                gender: customer.personalInfo.gender,
                                age: customer.personalInfo.age,
                                sales: customer.personalInfo.sales,
                                customerService: customer.personalInfo.customerService,
                                nextDeliveryDate: nextDeliveryDate,
                                remainingPeriods: remainingPeriods
                            });
                        });
                    }
                });
                
                // æŒ‰è´¦æœŸæ—¥æœŸå€’åºæ’åº
                periodData.sort((a, b) => new Date(b.periodDate) - new Date(a.periodDate));
                
                // ç”ŸæˆCSVå†…å®¹ï¼ˆæ·»åŠ BOMå¤´è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ï¼‰
                let csvContent = "\uFEFFè´¦æœŸæ—¥æœŸ,å®¢æˆ·å,æ€§åˆ«,å¹´é¾„,é”€å”®,é¡¾é—®,ä¸‹æ¬¡äº¤ä»˜æ—¶é—´,å‰©ä½™æœŸæ•°\n";
                
                periodData.forEach(item => {
                    csvContent += `"${item.periodDate}","${item.customerName}","${item.gender}",${item.age},"${item.sales}","${item.customerService}","${item.nextDeliveryDate}",${item.remainingPeriods}\n`;
                });
                
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æœåŠ¡è´¦æœŸåˆ—è¡¨_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // æ·»åŠ æ–°å®¢æˆ· - ä¿®å¤ï¼šç¡®ä¿æ–°å®¢æˆ·èƒ½æ­£ç¡®ä¿å­˜å¹¶åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º
            async addNewCustomer() {
                const data = await CustomerModel.loadData();
                const newCustomerId = CustomerModel.generateCustomerId(data);
                
                const newCustomer = {
                    id: newCustomerId,
                    personalInfo: {
                        name: 'æ–°å®¢æˆ·',
                        gender: 'ç”·',
                        birthDate: '',
                        age: 0,
                        residence: '',
                        maritalStatus: 'æœªå©š',
                        height: '',
                        weight: '',
                        bmi: '',
                        serviceProgress: '',
                        sales: '',
                        customerService: '',
                        nextDeliveryDate: '',
                        totalServicePeriods: 0, // æ–°å¢ï¼šé»˜è®¤æœåŠ¡æ€»æœŸæ•°ä¸º0
                        customerPortrait: '',
                        notes: ''
                    },
                    allergyHistory: [],
                    medicationHistory: [],
                    pastMedicalHistory: [],
                    surgeryHospitalizationHistory: [],
                    vaccinationHistory: [],
                    familyHistory: [],
                    periods: [],
                    lastUpdated: new Date().toISOString()
                };
                
                data.customers.push(newCustomer);
                
                // ä¿®å¤ï¼šç¡®ä¿æ•°æ®æ­£ç¡®ä¿å­˜
                const success = await CustomerModel.saveData(data);
                
                if (success) {
                    // æ¸…ç©ºæœç´¢æ¡ä»¶ï¼Œç¡®ä¿æ–°å®¢æˆ·åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º
                    document.getElementById('searchInput').value = '';
                    document.getElementById('customerServiceSearch').value = '';
                    
                    // é‡ç½®åˆ†é¡µåˆ°ç¬¬ä¸€é¡µ
                    this.currentPageIndex = 0;
                    
                    // åˆ·æ–°å®¢æˆ·åˆ—è¡¨
                    this.renderCustomerList();
                    
                    // æ˜¾ç¤ºæ–°å®¢æˆ·çš„è¯¦æƒ…
                    this.showCustomerDetail(newCustomerId);
                    
                    this.showSaveNotification();
                } else {
                    alert('åˆ›å»ºå®¢æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            },
            
            // ä¿å­˜ä¸ªäººä¿¡æ¯ - ä¿®å¤ï¼šä¿å­˜ååˆ·æ–°å®¢æˆ·åˆ—è¡¨å¹¶æ›´æ–°å½“å‰å®¢æˆ·å¼•ç”¨
            async savePersonalInfo(showNotification = true) {
                if (!this.currentCustomer) return;
                
                const data = await CustomerModel.loadData();
                const customerIndex = data.customers.findIndex(c => c.id === this.currentCustomer.id);
                
                if (customerIndex === -1) return;
                
                // æ›´æ–°ä¸ªäººä¿¡æ¯
                data.customers[customerIndex].personalInfo.name = document.getElementById('customerName').value;
                data.customers[customerIndex].personalInfo.gender = document.getElementById('customerGender').value;
                data.customers[customerIndex].personalInfo.birthDate = document.getElementById('birthDate').value;
                data.customers[customerIndex].personalInfo.age = document.getElementById('age').value;
                data.customers[customerIndex].personalInfo.residence = document.getElementById('residence').value;
                data.customers[customerIndex].personalInfo.maritalStatus = document.getElementById('maritalStatus').value;
                data.customers[customerIndex].personalInfo.height = document.getElementById('height').value;
                data.customers[customerIndex].personalInfo.weight = document.getElementById('weight').value;
                data.customers[customerIndex].personalInfo.bmi = document.getElementById('bmi').value;
                data.customers[customerIndex].personalInfo.sales = document.getElementById('sales').value;
                data.customers[customerIndex].personalInfo.customerService = document.getElementById('customerService').value;
                data.customers[customerIndex].personalInfo.totalServicePeriods = parseInt(document.getElementById('totalServicePeriods').value) || 0; // æ–°å¢ï¼šä¿å­˜æœåŠ¡æ€»æœŸæ•°
                data.customers[customerIndex].personalInfo.customerPortrait = document.getElementById('customerPortrait').value;
                data.customers[customerIndex].personalInfo.notes = document.getElementById('notes').value;
                
                // æ›´æ–°è¡¨æ ¼æ•°æ®
                data.customers[customerIndex].allergyHistory = this.currentCustomer.allergyHistory || [];
                data.customers[customerIndex].medicationHistory = this.currentCustomer.medicationHistory || [];
                data.customers[customerIndex].pastMedicalHistory = this.currentCustomer.pastMedicalHistory || [];
                data.customers[customerIndex].surgeryHospitalizationHistory = this.currentCustomer.surgeryHospitalizationHistory || [];
                data.customers[customerIndex].vaccinationHistory = this.currentCustomer.vaccinationHistory || [];
                data.customers[customerIndex].familyHistory = this.currentCustomer.familyHistory || [];
                
                data.customers[customerIndex].lastUpdated = new Date().toISOString();
                
                await CustomerModel.saveData(data);
                
                // ä¿å­˜åæ›´æ–°å½“å‰å®¢æˆ·å¼•ç”¨
                const updatedData = await CustomerModel.loadData();
                const updatedCustomer = updatedData.customers.find(c => c.id === this.currentCustomer.id);
                if (updatedCustomer) {
                    this.currentCustomer = updatedCustomer;
                }
                
                // æ›´æ–°ä¸‹æ¬¡äº¤ä»˜æ—¶é—´ï¼ˆè€ƒè™‘å‰©ä½™æœŸæ•°æ˜¯å¦ä¸º0ï¼‰
                this.updateNextDeliveryDate();
                
                // åˆ·æ–°å®¢æˆ·åˆ—è¡¨ï¼Œç¡®ä¿åˆ—è¡¨æ˜¾ç¤ºæœ€æ–°æ•°æ®
                this.renderCustomerList();
                
                if (showNotification) {
                    this.showSaveNotification();
                }
            },
            
            // ä¿å­˜è´¦æœŸä¿¡æ¯ - ä¿®å¤ï¼šä¿å­˜ååˆ·æ–°å®¢æˆ·åˆ—è¡¨
            async savePeriodInfo(showNotification = true) {
                if (!this.currentCustomer || !this.currentPeriod) {
                    console.error('æ— æ³•ä¿å­˜ï¼šå½“å‰å®¢æˆ·æˆ–è´¦æœŸä¸ºç©º');
                    return;
                }
                
                try {
                    const data = await CustomerModel.loadData();
                    const customerIndex = data.customers.findIndex(c => c.id === this.currentCustomer.id);
                    
                    if (customerIndex === -1) {
                        console.error('å®¢æˆ·ä¸å­˜åœ¨äºæ•°æ®ä¸­');
                        return;
                    }
                    
                    // æ‰¾åˆ°å½“å‰è´¦æœŸåœ¨æ•°æ®ä¸­çš„ç´¢å¼•
                    const periodIndex = data.customers[customerIndex].periods.findIndex(p => p.periodId === this.currentPeriod.periodId);
                    
                    if (periodIndex === -1) {
                        console.error('è´¦æœŸä¸å­˜åœ¨äºå®¢æˆ·æ•°æ®ä¸­');
                        return;
                    }
                    
                    // æ›´æ–°è´¦æœŸä¿¡æ¯
                    const updatedPeriod = {
                        ...data.customers[customerIndex].periods[periodIndex],
                        stressMentalHealth: document.getElementById('stressMentalHealth')?.value || '',
                        environmentOccupational: document.getElementById('environmentOccupational')?.value || '',
                        subjectiveHealth: document.getElementById('subjectiveHealth')?.value || '',
                        // ä¿ç•™è¡¨æ ¼æ•°æ®
                        dietaryHabits: this.currentPeriod.dietaryHabits || [],
                        physicalActivity: this.currentPeriod.physicalActivity || [],
                        sleepPattern: this.currentPeriod.sleepPattern || [],
                        abnormalIndicators: this.currentPeriod.abnormalIndicators || [],
                        communicationRecords: this.currentPeriod.communicationRecords || [],
                        followUpRecords: this.currentPeriod.followUpRecords || [],
                        financialStats: this.currentPeriod.financialStats || [],
                        attachments: this.currentPeriod.attachments || []
                    };
                    
                    // ç›´æ¥æ›¿æ¢æ•´ä¸ªè´¦æœŸå¯¹è±¡
                    data.customers[customerIndex].periods[periodIndex] = updatedPeriod;
                    data.customers[customerIndex].lastUpdated = new Date().toISOString();
                    
                    // åŒæ­¥æ›´æ–°å½“å‰å®¢æˆ·å’Œå½“å‰è´¦æœŸçš„å¼•ç”¨
                    this.currentCustomer = data.customers[customerIndex];
                    this.currentPeriod = updatedPeriod;
                    
                    await CustomerModel.saveData(data);
                    
                    // æ›´æ–°ä¸‹æ¬¡äº¤ä»˜æ—¶é—´ï¼ˆè€ƒè™‘å‰©ä½™æœŸæ•°æ˜¯å¦ä¸º0ï¼‰
                    this.updateNextDeliveryDate();
                    
                    // åˆ·æ–°å®¢æˆ·åˆ—è¡¨
                    this.renderCustomerList();
                    
                    if (showNotification) {
                        this.showSaveNotification();
                    }
                    
                    console.log('è´¦æœŸä¿¡æ¯å·²ä¿å­˜:', this.currentPeriod.periodName);
                } catch (error) {
                    console.error('ä¿å­˜è´¦æœŸä¿¡æ¯æ—¶å‡ºé”™:', error);
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®å®Œæ•´æ€§');
                }
            },
            
            // ä¿å­˜å®¢æˆ·æ•°æ®ï¼ˆé€šç”¨æ–¹æ³•ï¼‰
            async saveCustomerData() {
                const data = await CustomerModel.loadData();
                const customerIndex = data.customers.findIndex(c => c.id === this.currentCustomer.id);
                
                if (customerIndex === -1) return;
                
                // æ›´æ–°æ•´ä¸ªå®¢æˆ·å¯¹è±¡
                data.customers[customerIndex] = this.currentCustomer;
                data.customers[customerIndex].lastUpdated = new Date().toISOString();
                
                await CustomerModel.saveData(data);
            },
            
            // æ˜¾ç¤ºä¿å­˜é€šçŸ¥
            showSaveNotification() {
                const notification = document.getElementById('saveNotification');
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            },
            
            // å…³é—­æ¨¡æ€æ¡†
            closeModal(modal) {
                modal.classList.remove('active');
            },
            
            // æ˜¾ç¤ºå¯¼å‡ºæ•°æ®æ¨¡æ€æ¡† - ä¿®æ”¹ï¼šæ”¯æŒå¤šé€‰
            async showExportDataModal() {
                const modal = document.getElementById('exportDataModal');
                const customerCheckboxes = document.getElementById('customerCheckboxes');
                const customerSearchInput = document.getElementById('customerSearchInput');
                
                // æ¸…ç©ºæœç´¢æ¡†å’Œé€‰æ‹©æ¡†
                customerSearchInput.value = '';
                customerCheckboxes.innerHTML = '';
                this.selectedCustomerIds = [];
                
                // åŠ è½½æ‰€æœ‰å®¢æˆ·
                const data = await CustomerModel.loadData();
                data.customers.forEach(customer => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'customer-checkbox-item';
                    checkboxItem.innerHTML = `
                        <input type="checkbox" value="${customer.id}" id="customer_${customer.id}">
                        <label for="customer_${customer.id}">${customer.personalInfo.name} (${customer.id})</label>
                    `;
                    customerCheckboxes.appendChild(checkboxItem);
                });
                
                // ç»‘å®šå¤é€‰æ¡†å˜åŒ–äº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('#customerCheckboxes input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            const customerId = e.target.value;
                            if (e.target.checked) {
                                if (!this.selectedCustomerIds.includes(customerId)) {
                                    this.selectedCustomerIds.push(customerId);
                                }
                            } else {
                                const index = this.selectedCustomerIds.indexOf(customerId);
                                if (index > -1) {
                                    this.selectedCustomerIds.splice(index, 1);
                                }
                            }
                        });
                    });
                }, 0);
                
                modal.classList.add('active');
            },
            
            // è¿‡æ»¤å¯¼å‡ºå®¢æˆ·
            filterExportCustomers(searchTerm) {
                const customerCheckboxes = document.getElementById('customerCheckboxes');
                const items = customerCheckboxes.getElementsByClassName('customer-checkbox-item');
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm.toLowerCase())) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                }
            },
            
            // æ–°å¢ï¼šå¯¼å‡ºé€‰ä¸­å®¢æˆ·æ•°æ® - æ¯ä¸ªå®¢æˆ·å•ç‹¬æ–‡ä»¶
            async exportSelectedData() {
                if (this.selectedCustomerIds.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©å®¢æˆ·');
                    return;
                }
                
                const data = await CustomerModel.loadData();
                
                for (const customerId of this.selectedCustomerIds) {
                    const customer = data.customers.find(c => c.id === customerId);
                    
                    if (!customer) {
                        console.warn(`æœªæ‰¾åˆ°å®¢æˆ·æ•°æ®: ${customerId}`);
                        continue;
                    }
                    
                    // åˆ›å»ºä¸åŒ…å«idçš„å®¢æˆ·å‰¯æœ¬
                    const customerWithoutId = {...customer};
                    delete customerWithoutId.id;
                    
                    // å¯¼å‡ºå•ä¸ªå®¢æˆ·æ•°æ®ï¼ˆä¸åŒ…å«idï¼‰
                    const customerData = {
                        customer: customerWithoutId
                    };
                    
                    const dataStr = JSON.stringify(customerData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `customer_${customer.personalInfo.name}_${customer.id}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                
                this.closeModal(document.getElementById('exportDataModal'));
                alert(`å·²å¯¼å‡º ${this.selectedCustomerIds.length} ä¸ªå®¢æˆ·æ•°æ®`);
            },
            
            // æ–°å¢ï¼šå¯¼å‡ºå½“å‰åˆ—è¡¨æ•°æ® - æ¯ä¸ªå®¢æˆ·å•ç‹¬æ–‡ä»¶
            async exportCurrentListData() {
                const data = await CustomerModel.loadData();
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const customerServiceSearch = document.getElementById('customerServiceSearch').value.toLowerCase();
                const startPeriod = document.getElementById('startPeriod').value;
                const endPeriod = document.getElementById('endPeriod').value;
                
                // è¿‡æ»¤å®¢æˆ·ï¼ˆä¸å®¢æˆ·åˆ—è¡¨ç›¸åŒçš„è¿‡æ»¤æ¡ä»¶ï¼‰
                let filteredCustomers = data.customers.filter(customer => {
                    const matchesSearch = customer.personalInfo.name.toLowerCase().includes(searchTerm);
                    
                    // ä¿®å¤é¡¾é—®è¿‡æ»¤æ¡ä»¶ï¼šå½“é¡¾é—®æœç´¢æ¡†ä¸ºç©ºæ—¶ï¼Œä¸è¿‡æ»¤ä»»ä½•å®¢æˆ·
                    const matchesCustomerService = !customerServiceSearch || 
                        (customer.personalInfo.customerService && 
                         customer.personalInfo.customerService.toLowerCase().includes(customerServiceSearch));
                    
                    // æ£€æŸ¥ä¸‹æ¬¡äº¤ä»˜æ—¶é—´åŒºé—´
                    let matchesPeriod = true;
                    if (startPeriod && endPeriod) {
                        const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                        if (!nextDeliveryDate) {
                            matchesPeriod = false;
                        } else {
                            matchesPeriod = nextDeliveryDate >= startPeriod && nextDeliveryDate <= endPeriod;
                        }
                    }
                    
                    return matchesSearch && matchesCustomerService && matchesPeriod;
                });
                
                if (filteredCustomers.length === 0) {
                    alert('å½“å‰åˆ—è¡¨æ²¡æœ‰å®¢æˆ·æ•°æ®');
                    return;
                }
                
                for (const customer of filteredCustomers) {
                    // åˆ›å»ºä¸åŒ…å«idçš„å®¢æˆ·å‰¯æœ¬
                    const customerWithoutId = {...customer};
                    delete customerWithoutId.id;
                    
                    // å¯¼å‡ºå•ä¸ªå®¢æˆ·æ•°æ®ï¼ˆä¸åŒ…å«idï¼‰
                    const customerData = {
                        customer: customerWithoutId
                    };
                    
                    const dataStr = JSON.stringify(customerData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `customer_${customer.personalInfo.name}_${customer.id}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                
                this.closeModal(document.getElementById('exportDataModal'));
                alert(`å·²å¯¼å‡º ${filteredCustomers.length} ä¸ªå®¢æˆ·æ•°æ®`);
            },
            
            // å¯¼å‡ºå…¨éƒ¨æ•°æ® - ä¿®æ”¹ï¼šå¯¼å‡ºæ—¶ä¸åŒ…å«å®¢æˆ·ç¼–å·å­—æ®µ
            async exportAllData() {
                const data = await CustomerModel.loadData();
                
                // åˆ›å»ºä¸åŒ…å«idçš„å®¢æˆ·æ•°æ®å‰¯æœ¬
                const dataWithoutIds = {
                    customers: data.customers.map(customer => {
                        const customerWithoutId = {...customer};
                        delete customerWithoutId.id;
                        return customerWithoutId;
                    }),
                    nextCustomerId: data.nextCustomerId,
                    settings: data.settings
                };
                
                const dataStr = JSON.stringify(dataWithoutIds, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `customer_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.closeModal(document.getElementById('exportDataModal'));
            },
            
            // æ˜¾ç¤ºå¯¼å‡ºWordæ¨¡æ€æ¡†
            showExportWordModal() {
                if (!this.currentCustomer) {
                    alert('è¯·å…ˆé€‰æ‹©å®¢æˆ·');
                    return;
                }
                
                const periodsCheckboxes = document.getElementById('periodsCheckboxes');
                periodsCheckboxes.innerHTML = '';
                
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        const checkbox = document.createElement('div');
                        checkbox.innerHTML = `
                            <label>
                                <input type="checkbox" value="${period.periodId}" checked>
                                ${period.periodName}
                            </label>
                        `;
                        periodsCheckboxes.appendChild(checkbox);
                    });
                }
                
                document.getElementById('exportWordModal').classList.add('active');
            },
            
            // æ–°å¢ï¼šæ˜¾ç¤ºå¯¼å…¥æ•°æ®æ¨¡æ€æ¡†
            showImportDataModal() {
                const modal = document.getElementById('importDataModal');
                const fileList = document.getElementById('importFileList');
                
                // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
                fileList.innerHTML = '';
                this.importFiles = [];
                
                modal.classList.add('active');
            },
            
            // æ–°å¢ï¼šå¤„ç†å¯¼å…¥æ–‡ä»¶
            handleImportFiles(files) {
                if (!files || files.length === 0) return;
                
                const fileList = document.getElementById('importFileList');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.name.toLowerCase().endsWith('.json')) {
                        alert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯JSONæ ¼å¼ï¼Œå·²è·³è¿‡`);
                        continue;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
                    if (this.importFiles.some(f => f.name === file.name)) {
                        alert(`æ–‡ä»¶ ${file.name} å·²å­˜åœ¨ï¼Œå·²è·³è¿‡`);
                        continue;
                    }
                    
                    this.importFiles.push(file);
                    
                    // æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨
                    const fileItem = document.createElement('div');
                    fileItem.className = 'customer-checkbox-item';
                    fileItem.innerHTML = `
                        <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                        <button type="button" class="btn btn-danger btn-sm remove-file" data-index="${this.importFiles.length - 1}">åˆ é™¤</button>
                    `;
                    fileList.appendChild(fileItem);
                }
                
                // ç»‘å®šåˆ é™¤æ–‡ä»¶äº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-file').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeImportFile(index);
                        });
                    });
                }, 0);
            },
            
            // æ–°å¢ï¼šåˆ é™¤å¯¼å…¥æ–‡ä»¶
            removeImportFile(index) {
                if (index >= 0 && index < this.importFiles.length) {
                    this.importFiles.splice(index, 1);
                    this.updateImportFileList();
                }
            },
            
            // æ–°å¢ï¼šæ›´æ–°å¯¼å…¥æ–‡ä»¶åˆ—è¡¨
            updateImportFileList() {
                const fileList = document.getElementById('importFileList');
                fileList.innerHTML = '';
                
                this.importFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'customer-checkbox-item';
                    fileItem.innerHTML = `
                        <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                        <button type="button" class="btn btn-danger btn-sm remove-file" data-index="${index}">åˆ é™¤</button>
                    `;
                    fileList.appendChild(fileItem);
                });
                
                // é‡æ–°ç»‘å®šåˆ é™¤æ–‡ä»¶äº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-file').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeImportFile(index);
                        });
                    });
                }, 0);
            },
            
            // æ–°å¢ï¼šå¯¼å…¥é€‰ä¸­çš„æ–‡ä»¶
            async importSelectedFiles() {
                if (this.importFiles.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const file of this.importFiles) {
                    try {
                        const importedData = await this.readFileAsJSON(file);
                        const currentData = await CustomerModel.loadData();
                        
                        // åˆå¹¶å®¢æˆ·æ•°æ® - ä¿®æ”¹ï¼šæ€»æ˜¯æ–°å¢ï¼Œä¸è¦†ç›–
                        if (importedData.customer) {
                            // ä¸ºå¯¼å…¥çš„å®¢æˆ·ç”Ÿæˆæ–°çš„ID
                            const newCustomerId = CustomerModel.generateCustomerId(currentData);
                            const newCustomer = {
                                ...importedData.customer,
                                id: newCustomerId
                            };
                            
                            // æ€»æ˜¯æ·»åŠ ä¸ºæ–°å®¢æˆ·ï¼Œä¸æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                            currentData.customers.push(newCustomer);
                            successCount++;
                        } else if (importedData.customers && Array.isArray(importedData.customers)) {
                            // å¤„ç†æ‰¹é‡å®¢æˆ·æ•°æ®
                            importedData.customers.forEach(importedCustomer => {
                                const newCustomerId = CustomerModel.generateCustomerId(currentData);
                                const newCustomer = {
                                    ...importedCustomer,
                                    id: newCustomerId
                                };
                                currentData.customers.push(newCustomer);
                                successCount++;
                            });
                        } else {
                            errorCount++;
                            console.warn(`æ–‡ä»¶ ${file.name} æ ¼å¼ä¸æ­£ç¡®ï¼Œå·²è·³è¿‡`);
                        }
                        
                        // ä¿å­˜æ•°æ®
                        await CustomerModel.saveData(currentData);
                        
                    } catch (error) {
                        errorCount++;
                        console.error(`å¯¼å…¥æ–‡ä»¶ ${file.name} å¤±è´¥:`, error);
                    }
                }
                
                // åˆ·æ–°ç•Œé¢
                this.renderCustomerList();
                this.showSaveNotification();
                
                // å…³é—­æ¨¡æ€æ¡†
                this.closeModal(document.getElementById('importDataModal'));
                
                // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
                alert(`å¯¼å…¥å®Œæˆï¼æˆåŠŸ: ${successCount} ä¸ªï¼Œå¤±è´¥: ${errorCount} ä¸ª`);
            },
            
            // æ–°å¢ï¼šè¯»å–æ–‡ä»¶ä¸ºJSON
            readFileAsJSON(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            resolve(importedData);
                        } catch (error) {
                            reject(new Error(`æ–‡ä»¶ ${file.name} ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼`));
                        }
                    };
                    reader.onerror = () => reject(new Error(`è¯»å–æ–‡ä»¶ ${file.name} å¤±è´¥`));
                    reader.readAsText(file);
                });
            },
            
            // å¯¼å‡ºWordæ–‡æ¡£ - ä¿®æ”¹ï¼šæ·»åŠ æŒ‡æ ‡å¯¹æ¯”å†…å®¹
            exportWord() {
                if (!this.currentCustomer) return;
                
                const selectedPeriods = [];
                document.querySelectorAll('#periodsCheckboxes input:checked').forEach(checkbox => {
                    const periodId = checkbox.value;
                    const period = this.currentCustomer.periods.find(p => p.periodId === periodId);
                    if (period) {
                        selectedPeriods.push(period);
                    }
                });
                
                // ç”ŸæˆWordæ–‡æ¡£å†…å®¹
                let content = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                          xmlns:w='urn:schemas-microsoft-com:office:word' 
                          xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset="utf-8">
                        <title>${this.currentCustomer.personalInfo.name}å¥åº·æ¡£æ¡ˆ</title>
                        <style>
                            table { border-collapse: collapse; }
                            td, th { padding: 5px 10px; }
                        </style>
                    </head>
                    <body>
                        <h1>${this.currentCustomer.personalInfo.name}å¥åº·æ¡£æ¡ˆ</h1>
                        <h2>ä¸ªäººä¿¡æ¯</h2>
                        <table>
                            <tr><td>å§“å</td><td>${this.currentCustomer.personalInfo.name}</td></tr>
                            <tr><td>æ€§åˆ«</td><td>${this.currentCustomer.personalInfo.gender}</td></tr>
                            <tr><td>å¹´é¾„</td><td>${this.currentCustomer.personalInfo.age}</td></tr>
                            <tr><td>å¸¸å±…åœ°</td><td>${this.currentCustomer.personalInfo.residence}</td></tr>
                            <tr><td>å©šå§»çŠ¶å†µ</td><td>${this.currentCustomer.personalInfo.maritalStatus}</td></tr>
                            <tr><td>èº«é«˜</td><td>${this.currentCustomer.personalInfo.height} cm</td></tr>
                            <tr><td>ä½“é‡</td><td>${this.currentCustomer.personalInfo.weight} kg</td></tr>
                            <tr><td>BMI</td><td>${this.currentCustomer.personalInfo.bmi}</td></tr>
                            <tr><td>æœåŠ¡è¿›åº¦</td><td>${this.currentCustomer.personalInfo.serviceProgress}</td></tr>
                            <tr><td>é”€å”®</td><td>${this.currentCustomer.personalInfo.sales}</td></tr>
                            <tr><td>é¡¾é—®</td><td>${this.currentCustomer.personalInfo.customerService}</td></tr>
                            <tr><td>ä¸‹æ¬¡äº¤ä»˜æ—¶é—´</td><td>${this.currentCustomer.personalInfo.nextDeliveryDate}</td></tr>
                            <tr><td>æœåŠ¡æ€»æœŸæ•°</td><td>${this.currentCustomer.personalInfo.totalServicePeriods || 0}</td></tr>
                            <tr><td>å®¢æˆ·ç”»åƒ</td><td>${this.currentCustomer.personalInfo.customerPortrait ? this.currentCustomer.personalInfo.customerPortrait.replace(/\n/g, '<br>') : ''}</td></tr>
                            <tr><td>å¤‡æ³¨</td><td>${this.currentCustomer.personalInfo.notes ? this.currentCustomer.personalInfo.notes.replace(/\n/g, '<br>') : ''}</td></tr>
                        </table>
                `;
                
                // æ·»åŠ ä¸ªäººä¿¡æ¯è¡¨æ ¼
                content += this.exportPersonalInfoTables();
                
                // æ·»åŠ è´¦æœŸä¿¡æ¯
                selectedPeriods.forEach(period => {
                    content += `
                        <h2>${period.periodName} è´¦æœŸä¿¡æ¯</h2>
                        ${this.exportPeriodInfoTables(period)}
                        <h3>å¼‚å¸¸æ£€æµ‹æŒ‡æ ‡</h3>
                    `;
                    
                    if (period.abnormalIndicators && period.abnormalIndicators.length > 0) {
                        content += `<table border="1" cellpadding="5" cellspacing="0">
                            <tr><th>æŒ‡æ ‡åç§°</th><th>æ•°å€¼</th><th>å•ä½</th><th>å‚è€ƒèŒƒå›´</th><th>æµ‹é‡æ—¶é—´</th><th>æ£€æµ‹æœºæ„</th></tr>`;
                        
                        period.abnormalIndicators.forEach(indicator => {
                            content += `<tr>
                                <td>${indicator.name}</td>
                                <td>${indicator.value}</td>
                                <td>${indicator.unit}</td>
                                <td>${indicator.reference}</td>
                                <td>${indicator.measurementDate}</td>
                                <td>${indicator.testingInstitution || ''}</td>
                            </tr>`;
                        });
                        
                        content += `</table>`;
                    } else {
                        content += `<p>æ— </p>`;
                    }
                    
                    content += `
                        <h3>ä¼å¾®æ²Ÿé€šè®°å½•</h3>
                    `;
                    
                    if (period.communicationRecords && period.communicationRecords.length > 0) {
                        content += `<table border="1" cellpadding="5" cellspacing="0">
                            <tr><th>æ—¥æœŸ</th><th>å…³é”®è¯</th><th>å®¢è¯‰å†…å®¹</th></tr>`;
                        
                        period.communicationRecords.forEach(record => {
                            content += `<tr>
                                <td>${record.date}</td>
                                <td>${record.keyword}</td>
                                <td>${record.content ? record.content.replace(/\n/g, '<br>') : ''}</td>
                            </tr>`;
                        });
                        
                        content += `</table>`;
                    } else {
                        content += `<p>æ— </p>`;
                    }
                    
                    content += `
                        <h3>å›è®¿è®°å½•</h3>
                    `;
                    
                    if (period.followUpRecords && period.followUpRecords.length > 0) {
                        content += `<table border="1" cellpadding="5" cellspacing="0">
                            <tr><th>æ—¥æœŸ</th><th>é¡¹ç›®åç§°</th><th>å›è®¿å†…å®¹</th></tr>`;
                        
                        period.followUpRecords.forEach(record => {
                            content += `<tr>
                                <td>${record.date}</td>
                                <td>${record.project}</td>
                                <td>${record.reason ? record.reason.replace(/\n/g, '<br>') : ''}</td>
                            </tr>`;
                        });
                        
                        content += `</table>`;
                    } else {
                        content += `<p>æ— </p>`;
                    }
                });
                
                // æ·»åŠ æŒ‡æ ‡å¯¹æ¯”å†…å®¹
                content += this.exportIndicatorsCompare();
                
                content += `</body></html>`;
                
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const blob = new Blob([content], {type: 'application/msword'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.currentCustomer.personalInfo.name}å¥åº·æ¡£æ¡ˆ.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.closeModal(document.getElementById('exportWordModal'));
            },
            
            // å¯¼å‡ºä¸ªäººä¿¡æ¯è¡¨æ ¼
            exportPersonalInfoTables() {
                let content = '';
                
                // è¿‡æ•å²
                content += '<h2>è¿‡æ•å²</h2>';
                if (this.currentCustomer.allergyHistory && this.currentCustomer.allergyHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>è¿‡æ•åŸç±»åˆ«</th><th>å…·ä½“è¿‡æ•åŸ</th><th>ååº”ä¸¥é‡ç¨‹åº¦</th><th>è¿‡æ•ååº”æè¿°</th><th>é¦–æ¬¡å‘ç°æ—¥æœŸ</th></tr>';
                    this.currentCustomer.allergyHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.allergenType}</td>
                            <td>${record.allergen}</td>
                            <td>${record.severity}</td>
                            <td>${record.description}</td>
                            <td>${record.firstFoundDate}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                // ç”¨è¯å²
                content += '<h2>ç”¨è¯å²</h2>';
                if (this.currentCustomer.medicationHistory && this.currentCustomer.medicationHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>è¯ç‰©åç§°</th><th>è¯ç‰©ç±»å‹</th><th>ç”¨è¯åŸå› /é€‚åº”ç—‡</th><th>å‰‚é‡</th><th>æœç”¨é¢‘ç‡</th></tr>';
                    this.currentCustomer.medicationHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.medicationName}</td>
                            <td>${record.medicationType}</td>
                            <td>${record.reason}</td>
                            <td>${record.dosage}</td>
                            <td>${record.frequency}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                // æ—¢å¾€ç—…å²
                content += '<h2>æ—¢å¾€ç—…å²</h2>';
                if (this.currentCustomer.pastMedicalHistory && this.currentCustomer.pastMedicalHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>ç–¾ç—…/çŠ¶å†µåç§°</th><th>è®°å½•ç±»å‹</th><th>è¯¦æƒ…</th><th>è¯Šæ–­/å‘ç”Ÿæ—¥æœŸ</th></tr>';
                    this.currentCustomer.pastMedicalHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.conditionName}</td>
                            <td>${record.recordType}</td>
                            <td>${record.currentStatus}</td>
                            <td>${record.diagnosisDate}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                // æ‰‹æœ¯ä¸ä½é™¢å²
                content += '<h2>æ‰‹æœ¯ä¸ä½é™¢å²</h2>';
                if (this.currentCustomer.surgeryHospitalizationHistory && this.currentCustomer.surgeryHospitalizationHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>äº‹ä»¶åç§°</th><th>äº‹ä»¶ç±»å‹</th><th>å‘ç”Ÿæ—¥æœŸ</th><th>ç»“æœä¸å½±å“</th></tr>';
                    this.currentCustomer.surgeryHospitalizationHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.eventName}</td>
                            <td>${record.eventType}</td>
                            <td>${record.eventDate}</td>
                            <td>${record.result ? record.result.replace(/\n/g, '<br>') : ''}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                // ç–«è‹—æ¥ç§å²
                content += '<h2>ç–«è‹—æ¥ç§å²</h2>';
                if (this.currentCustomer.vaccinationHistory && this.currentCustomer.vaccinationHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>ç–«è‹—åç§°</th><th>æ¥ç§æ—¥æœŸ</th><th>å¤‡æ³¨</th></tr>';
                    this.currentCustomer.vaccinationHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.vaccineName}</td>
                            <td>${record.vaccinationDate}</td>
                            <td>${record.notes}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                // å®¶æ—ç—…å²
                content += '<h2>å®¶æ—ç—…å²</h2>';
                if (this.currentCustomer.familyHistory && this.currentCustomer.familyHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>äº²å±å…³ç³»</th><th>ç–¾ç—…/çŠ¶å†µåç§°</th><th>å‘ç—…å¹´é¾„</th></tr>';
                    this.currentCustomer.familyHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.relationship}</td>
                            <td>${record.condition}</td>
                            <td>${record.onsetAge}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                return content;
            },
            
            // å¯¼å‡ºè´¦æœŸä¿¡æ¯è¡¨æ ¼
            exportPeriodInfoTables(period) {
                let content = '';
                
                // è†³é£Ÿä¹ æƒ¯
                content += '<h3>è†³é£Ÿä¹ æƒ¯</h3>';
                if (period.dietaryHabits && period.dietaryHabits.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>ä¸»ç±»å‹</th><th>å­ç±»å‹</th><th>å¤‡æ³¨</th></tr>';
                    period.dietaryHabits.forEach(record => {
                        content += `<tr>
                            <td>${record.mainType}</td>
                            <td>${record.subType}</td>
                            <td>${record.notes ? record.notes.replace(/\n/g, '<br>') : ''}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                // èº«ä½“æ´»åŠ¨
                content += '<h3>èº«ä½“æ´»åŠ¨</h3>';
                if (period.physicalActivity && period.physicalActivity.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>è¿åŠ¨ç±»å‹</th><th>é¢‘ç‡</th><th>æ—¶é•¿å’Œå¼ºåº¦</th><th>æ—¥å¸¸æ´»åŠ¨æ°´å¹³ä¸ä¹…åæ—¶é—´</th></tr>';
                    period.physicalActivity.forEach(record => {
                        content += `<tr>
                            <td>${record.exerciseType}</td>
                            <td>${record.frequency}</td>
                            <td>${record.durationIntensity}</td>
                            <td>${record.dailyActivity}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                // ç¡çœ æ¨¡å¼
                content += '<h3>ç¡çœ æ¨¡å¼</h3>';
                if (period.sleepPattern && period.sleepPattern.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>æ•´ä½“ç¡çœ çŠ¶å†µ</th><th>ä¸»è§‚ç¡çœ é—®é¢˜</th></tr>';
                    period.sleepPattern.forEach(record => {
                        content += `<tr>
                            <td>${record.sleepStatus}</td>
                            <td>${record.subjectiveProblems ? record.subjectiveProblems.replace(/\n/g, '<br>') : ''}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>æ— </p>';
                }
                
                // å‹åŠ›ä¸å¿ƒç†å¥åº·
                content += '<h3>å‹åŠ›ä¸å¿ƒç†å¥åº·</h3>';
                content += `<p>${period.stressMentalHealth ? period.stressMentalHealth.replace(/\n/g, '<br>') : 'æ— '}</p>`;
                
                // ç¯å¢ƒä¸èŒä¸šå› ç´ 
                content += '<h3>ç¯å¢ƒä¸èŒä¸šå› ç´ </h3>';
                content += `<p>${period.environmentOccupational ? period.environmentOccupational.replace(/\n/g, '<br>') : 'æ— '}</p>`;
                
                // ä¸»è§‚å¥åº·æ„Ÿå—
                content += '<h3>ä¸»è§‚å¥åº·æ„Ÿå—</h3>';
                content += `<p>${period.subjectiveHealth ? period.subjectiveHealth.replace(/\n/g, '<br>') : 'æ— '}</p>`;
                
                return content;
            },
            
            // å¯¼å‡ºæŒ‡æ ‡å¯¹æ¯”å†…å®¹
            exportIndicatorsCompare() {
                if (!this.currentCustomer) return '';
                
                // è·å–æ‰€æœ‰æŒ‡æ ‡åç§°
                const indicatorNames = CustomerModel.getAllIndicatorNames(this.currentCustomer);
                
                if (indicatorNames.length === 0) {
                    return '<h2>æŒ‡æ ‡å¯¹æ¯”</h2><p>æš‚æ— æŒ‡æ ‡æ•°æ®</p>';
                }
                
                // æ”¶é›†æŒ‡æ ‡æ•°æ®
                const indicatorData = {};
                const datePeriodMap = {};
                
                indicatorNames.forEach(indicator => {
                    indicatorData[indicator] = [];
                });
                
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.abnormalIndicators) {
                            period.abnormalIndicators.forEach(indicator => {
                                if (indicatorNames.includes(indicator.name)) {
                                    indicatorData[indicator.name].push({
                                        period: period.periodName,
                                        value: indicator.value,
                                        measurementDate: indicator.measurementDate
                                    });
                                    
                                    // æå–è´¦æœŸç¼–å·
                                    const periodNumber = period.periodName.split('-')[0];
                                    datePeriodMap[indicator.measurementDate] = periodNumber;
                                }
                            });
                        }
                    });
                }
                
                // æ”¶é›†æ‰€æœ‰æµ‹é‡æ—¥æœŸ
                const allDates = [];
                Object.keys(indicatorData).forEach(indicator => {
                    indicatorData[indicator].forEach(item => {
                        if (!allDates.includes(item.measurementDate)) {
                            allDates.push(item.measurementDate);
                        }
                    });
                });
                
                allDates.sort();
                
                // æ”¶é›†æ‰€æœ‰æŒ‡æ ‡åç§°å¹¶æ’åº
                const indicators = Object.keys(indicatorData).sort();
                
                let content = '<h2>æŒ‡æ ‡å¯¹æ¯”</h2>';
                
                if (indicators.length === 0) {
                    content += '<p>æš‚æ— æŒ‡æ ‡æ•°æ®</p>';
                    return content;
                }
                
                content += '<table border="1" cellpadding="5" cellspacing="0"><thead><tr><th>æŒ‡æ ‡åç§°</th><th>å‚è€ƒèŒƒå›´</th>';
                
                allDates.forEach(date => {
                    const periodNumber = datePeriodMap[date] || '';
                    const headerText = periodNumber ? `${date} (${periodNumber})` : date;
                    content += `<th>${headerText}</th>`;
                });
                
                content += '</tr></thead><tbody>';
                
                indicators.forEach(indicator => {
                    content += `<tr><td>${indicator}</td><td>${this.getReferenceRange(indicator) || '-'}</td>`;
                    
                    allDates.forEach(date => {
                        const item = indicatorData[indicator].find(d => d.measurementDate === date);
                        content += `<td>${item ? item.value : '-'}</td>`;
                    });
                    
                    content += '</tr>';
                });
                
                content += '</tbody></table>';
                
                return content;
            },
            
            // è·å–æŒ‡æ ‡çš„å‚è€ƒèŒƒå›´
            getReferenceRange(indicatorName) {
                if (!this.currentCustomer || !this.currentCustomer.periods) return '';
                
                for (const period of this.currentCustomer.periods) {
                    if (period.abnormalIndicators) {
                        for (const indicator of period.abnormalIndicators) {
                            if (indicator.name === indicatorName && indicator.reference) {
                                return indicator.reference;
                            }
                        }
                    }
                }
                
                return '';
            },
            
            
            // å¯¼å‡ºæŒ‡æ ‡å¯¹æ¯”Excel
            async exportIndicatorsExcel() {
                if (!this.currentCustomer) {
                    alert('è¯·å…ˆé€‰æ‹©å®¢æˆ·');
                    return;
                }
                
                // è·å–æ‰€æœ‰æŒ‡æ ‡åç§°
                const indicatorNames = CustomerModel.getAllIndicatorNames(this.currentCustomer);
                
                if (indicatorNames.length === 0) {
                    alert('è¯¥å®¢æˆ·æš‚æ— æŒ‡æ ‡æ•°æ®');
                    return;
                }
                
                // æ”¶é›†æŒ‡æ ‡æ•°æ®
                const indicatorData = {};
                const datePeriodMap = {};
                
                indicatorNames.forEach(indicator => {
                    indicatorData[indicator] = [];
                });
                
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.abnormalIndicators) {
                            period.abnormalIndicators.forEach(indicator => {
                                if (indicatorNames.includes(indicator.name)) {
                                    indicatorData[indicator.name].push({
                                        period: period.periodName,
                                        value: indicator.value,
                                        measurementDate: indicator.measurementDate
                                    });
                                    
                                    // æå–è´¦æœŸç¼–å·
                                    const periodNumber = period.periodName.split('-')[0];
                                    datePeriodMap[indicator.measurementDate] = periodNumber;
                                }
                            });
                        }
                    });
                }
                
                // æ”¶é›†æ‰€æœ‰æµ‹é‡æ—¥æœŸ
                const allDates = [];
                Object.keys(indicatorData).forEach(indicator => {
                    indicatorData[indicator].forEach(item => {
                        if (!allDates.includes(item.measurementDate)) {
                            allDates.push(item.measurementDate);
                        }
                    });
                });
                
                allDates.sort();
                
                // æ”¶é›†æ‰€æœ‰æŒ‡æ ‡åç§°å¹¶æ’åº
                const indicators = Object.keys(indicatorData).sort();
                
                // ç”ŸæˆCSVå†…å®¹ï¼ˆæ·»åŠ BOMå¤´è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ï¼‰
                let csvContent = "\uFEFFæŒ‡æ ‡åç§°,å‚è€ƒèŒƒå›´";
                
                allDates.forEach(date => {
                    const periodNumber = datePeriodMap[date] || '';
                    const headerText = periodNumber ? `${date} (${periodNumber})` : date;
                    csvContent += `,"${headerText}"`;
                });
                
                csvContent += "\n";
                
                indicators.forEach(indicator => {
                    csvContent += `"${indicator}","${this.getReferenceRange(indicator) || '-'}"`;
                    
                    allDates.forEach(date => {
                        const item = indicatorData[indicator].find(d => d.measurementDate === date);
                        csvContent += `,"${item ? item.value : '-'}"`;
                    });
                    
                    csvContent += "\n";
                });
                
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.currentCustomer.personalInfo.name}æŒ‡æ ‡å¯¹æ¯”_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // å¯¼å…¥æ•°æ® - ä¿®æ”¹ï¼šç¡®ä¿æ€»æ˜¯æ–°å¢æ•°æ®ï¼Œä¸è¦†ç›–åŸæœ‰æ•°æ®
            async importData(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        const currentData = await CustomerModel.loadData();
                        
                        // åˆå¹¶å®¢æˆ·æ•°æ® - ä¿®æ”¹ï¼šæ€»æ˜¯æ–°å¢ï¼Œä¸è¦†ç›–
                        if (importedData.customers) {
                            importedData.customers.forEach(importedCustomer => {
                                // ä¸ºå¯¼å…¥çš„å®¢æˆ·ç”Ÿæˆæ–°çš„ID
                                const newCustomerId = CustomerModel.generateCustomerId(currentData);
                                const newCustomer = {
                                    ...importedCustomer,
                                    id: newCustomerId
                                };
                                
                                // æ€»æ˜¯æ·»åŠ ä¸ºæ–°å®¢æˆ·ï¼Œä¸æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                                currentData.customers.push(newCustomer);
                            });
                        }
                        
                        // ä¿å­˜æ•°æ®
                        await CustomerModel.saveData(currentData);
                        this.showSaveNotification();
                        this.renderCustomerList();
                        
                        alert(`æˆåŠŸå¯¼å…¥ ${importedData.customers ? importedData.customers.length : 0} ä¸ªå®¢æˆ·æ•°æ®`);
                    } catch (error) {
                        alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    }
                };
                reader.readAsText(file);
            },
            
            // æ˜¾ç¤ºé‡ç½®ç¡®è®¤æ¨¡æ€æ¡†
            showResetConfirmModal() {
                document.getElementById('resetConfirmModal').classList.add('active');
            },
            
            // é‡ç½®æ‰€æœ‰æ•°æ®
            async resetAllData() {
                const emptyData = {
                    customers: [],
                    nextCustomerId: 1,
                    settings: {
                        pageSize: 10
                    }
                };
                
                await CustomerModel.saveData(emptyData);
                this.closeModal(document.getElementById('resetConfirmModal'));
                this.showPage('customer-list');
                this.renderCustomerList();
                alert('æ‰€æœ‰æ•°æ®å·²é‡ç½®');
            },
            
            // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
            validatePeriodData(period) {
                if (!period || !period.periodId || !period.periodName) {
                    console.error('è´¦æœŸæ•°æ®ä¸å®Œæ•´');
                    return false;
                }
                return true;
            },
            
            // ========== ä¸ªäººä¿¡æ¯è¡¨æ ¼ç›¸å…³æ–¹æ³• ==========
            
            // æ¸²æŸ“è¿‡æ•å²è¡¨æ ¼
            renderAllergyHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>è¿‡æ•åŸç±»åˆ«</th><th>å…·ä½“è¿‡æ•åŸ</th><th>ååº”ä¸¥é‡ç¨‹åº¦</th><th>è¿‡æ•ååº”æè¿°</th><th>é¦–æ¬¡å‘ç°æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td>
                                <select data-index="${index}" data-field="allergenType">
                                    <option value="è¯ç‰©" ${record.allergenType === 'è¯ç‰©' ? 'selected' : ''}>è¯ç‰©</option>
                                    <option value="é£Ÿç‰©" ${record.allergenType === 'é£Ÿç‰©' ? 'selected' : ''}>é£Ÿç‰©</option>
                                    <option value="ç¯å¢ƒ" ${record.allergenType === 'ç¯å¢ƒ' ? 'selected' : ''}>ç¯å¢ƒ</option>
                                    <option value="å…¶ä»–" ${record.allergenType === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.allergen || ''}" data-index="${index}" data-field="allergen"></td>
                            <td>
                                <select data-index="${index}" data-field="severity">
                                    <option value="è½»åº¦" ${record.severity === 'è½»åº¦' ? 'selected' : ''}>è½»åº¦</option>
                                    <option value="ä¸­åº¦" ${record.severity === 'ä¸­åº¦' ? 'selected' : ''}>ä¸­åº¦</option>
                                    <option value="é‡åº¦" ${record.severity === 'é‡åº¦' ? 'selected' : ''}>é‡åº¦</option>
                                    <option value="å±åŠç”Ÿå‘½" ${record.severity === 'å±åŠç”Ÿå‘½' ? 'selected' : ''}>å±åŠç”Ÿå‘½</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.description || ''}" data-index="${index}" data-field="description"></td>
                            <td><input type="date" value="${record.firstFoundDate || ''}" data-index="${index}" data-field="firstFoundDate"></td>
                            <td>
    <div class="delete-row-icon remove-allergy" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-allergy').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeAllergyHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#allergyHistoryContainer select, #allergyHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateAllergyHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ è¿‡æ•å²è®°å½•
            addAllergyHistoryRecord() {
                if (!this.currentCustomer.allergyHistory) {
                    this.currentCustomer.allergyHistory = [];
                }
                
                this.currentCustomer.allergyHistory.push({
                    allergenType: 'è¯ç‰©',
                    allergen: '',
                    severity: 'è½»åº¦',
                    description: '',
                    firstFoundDate: new Date().toISOString().split('T')[0]
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // åˆ é™¤è¿‡æ•å²è®°å½•
            removeAllergyHistoryRecord(index) {
                this.currentCustomer.allergyHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // æ›´æ–°è¿‡æ•å²è®°å½•
            updateAllergyHistoryRecord(index, field, value) {
                if (!this.currentCustomer.allergyHistory) {
                    this.currentCustomer.allergyHistory = [];
                }
                this.currentCustomer.allergyHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // æ¸²æŸ“ç”¨è¯å²è¡¨æ ¼
            renderMedicationHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>è¯ç‰©åç§°</th><th>è¯ç‰©ç±»å‹</th><th>ç”¨è¯åŸå› /é€‚åº”ç—‡</th><th>å‰‚é‡</th><th>æœç”¨é¢‘ç‡</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.medicationName || ''}" data-index="${index}" data-field="medicationName"></td>
                            <td>
                                <select data-index="${index}" data-field="medicationType">
                                    <option value="å¤„æ–¹è¯" ${record.medicationType === 'å¤„æ–¹è¯' ? 'selected' : ''}>å¤„æ–¹è¯</option>
                                    <option value="éå¤„æ–¹è¯" ${record.medicationType === 'éå¤„æ–¹è¯' ? 'selected' : ''}>éå¤„æ–¹è¯</option>
                                    <option value="ä¿å¥å“/è¥å…»è¡¥å‰‚" ${record.medicationType === 'ä¿å¥å“/è¥å…»è¡¥å‰‚' ? 'selected' : ''}>ä¿å¥å“/è¥å…»è¡¥å‰‚</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.reason || ''}" data-index="${index}" data-field="reason"></td>
                            <td><input type="text" value="${record.dosage || ''}" data-index="${index}" data-field="dosage"></td>
                            <td><input type="text" value="${record.frequency || ''}" data-index="${index}" data-field="frequency"></td>
                            <td>
    <div class="delete-row-icon remove-medication" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-medication').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeMedicationHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#medicationHistoryContainer select, #medicationHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateMedicationHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ ç”¨è¯å²è®°å½•
            addMedicationHistoryRecord() {
                if (!this.currentCustomer.medicationHistory) {
                    this.currentCustomer.medicationHistory = [];
                }
                
                this.currentCustomer.medicationHistory.push({
                    medicationName: '',
                    medicationType: 'å¤„æ–¹è¯',
                    reason: '',
                    dosage: '',
                    frequency: ''
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // åˆ é™¤ç”¨è¯å²è®°å½•
            removeMedicationHistoryRecord(index) {
                this.currentCustomer.medicationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // æ›´æ–°ç”¨è¯å²è®°å½•
            updateMedicationHistoryRecord(index, field, value) {
                if (!this.currentCustomer.medicationHistory) {
                    this.currentCustomer.medicationHistory = [];
                }
                this.currentCustomer.medicationHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // æ¸²æŸ“æ—¢å¾€ç—…å²è¡¨æ ¼
            renderPastMedicalHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>ç–¾ç—…/çŠ¶å†µåç§°</th><th>è®°å½•ç±»å‹</th><th>è¯¦æƒ…</th><th>è¯Šæ–­/å‘ç”Ÿæ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.conditionName || ''}" data-index="${index}" data-field="conditionName"></td>
                            <td>
                                <select data-index="${index}" data-field="recordType">
                                    <option value="æ…¢æ€§ç—…" ${record.recordType === 'æ…¢æ€§ç—…' ? 'selected' : ''}>æ…¢æ€§ç—…</option>
                                    <option value="æ€¥æ€§ç—…" ${record.recordType === 'æ€¥æ€§ç—…' ? 'selected' : ''}>æ€¥æ€§ç—…</option>
                                    <option value="æ‰‹æœ¯" ${record.recordType === 'æ‰‹æœ¯' ? 'selected' : ''}>æ‰‹æœ¯</option>
                                    <option value="ä½é™¢" ${record.recordType === 'ä½é™¢' ? 'selected' : ''}>ä½é™¢</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.currentStatus || ''}" data-index="${index}" data-field="record.currentStatus"></td>
                            <td><input type="date" value="${record.diagnosisDate || ''}" data-index="${index}" data-field="diagnosisDate"></td>
                            <td>
    <div class="delete-row-icon remove-past-medical" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-past-medical').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removePastMedicalHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#pastMedicalHistoryContainer select, #pastMedicalHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updatePastMedicalHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ æ—¢å¾€ç—…å²è®°å½•
            addPastMedicalHistoryRecord() {
                if (!this.currentCustomer.pastMedicalHistory) {
                    this.currentCustomer.pastMedicalHistory = [];
                }
                
                this.currentCustomer.pastMedicalHistory.push({
                    conditionName: '',
                    recordType: 'æ…¢æ€§ç—…',
                    currentStatus: 'æ´»åŠ¨æ€§',
                    diagnosisDate: new Date().toISOString().split('T')[0]
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // åˆ é™¤æ—¢å¾€ç—…å²è®°å½•
            removePastMedicalHistoryRecord(index) {
                this.currentCustomer.pastMedicalHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // æ›´æ–°æ—¢å¾€ç—…å²è®°å½•
            updatePastMedicalHistoryRecord(index, field, value) {
                if (!this.currentCustomer.pastMedicalHistory) {
                    this.currentCustomer.pastMedicalHistory = [];
                }
                this.currentCustomer.pastMedicalHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // æ¸²æŸ“æ‰‹æœ¯ä¸ä½é™¢å²è¡¨æ ¼
            renderSurgeryHospitalizationHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>äº‹ä»¶åç§°</th><th>äº‹ä»¶ç±»å‹</th><th>å‘ç”Ÿæ—¥æœŸ</th><th>ç»“æœä¸å½±å“</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.eventName || ''}" data-index="${index}" data-field="eventName"></td>
                            <td>
                                <select data-index="${index}" data-field="eventType">
                                    <option value="æ‰‹æœ¯" ${record.eventType === 'æ‰‹æœ¯' ? 'selected' : ''}>æ‰‹æœ¯</option>
                                    <option value="ä½é™¢" ${record.eventType === 'ä½é™¢' ? 'selected' : ''}>ä½é™¢</option>
                                    <option value="ä½“æ£€" ${record.eventType === 'ä½“æ£€' ? 'selected' : ''}>ä½“æ£€</option>
                                </select>
                            </td>
                            <td><input type="date" value="${record.eventDate || ''}" data-index="${index}" data-field="eventDate"></td>
                            <td><textarea data-index="${index}" data-field="result" rows="2">${record.result || ''}</textarea></td>
                            <td>
    <div class="delete-row-icon remove-surgery" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-surgery').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeSurgeryHospitalizationHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#surgeryHospitalizationHistoryContainer select, #surgeryHospitalizationHistoryContainer input, #surgeryHospitalizationHistoryContainer textarea').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateSurgeryHospitalizationHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ æ‰‹æœ¯ä¸ä½é™¢å²è®°å½•
            addSurgeryHospitalizationHistoryRecord() {
                if (!this.currentCustomer.surgeryHospitalizationHistory) {
                    this.currentCustomer.surgeryHospitalizationHistory = [];
                }
                
                this.currentCustomer.surgeryHospitalizationHistory.push({
                    eventName: '',
                    eventType: 'æ‰‹æœ¯',
                    eventDate: new Date().toISOString().split('T')[0],
                    result: ''
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // åˆ é™¤æ‰‹æœ¯ä¸ä½é™¢å²è®°å½•
            removeSurgeryHospitalizationHistoryRecord(index) {
                this.currentCustomer.surgeryHospitalizationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // æ›´æ–°æ‰‹æœ¯ä¸ä½é™¢å²è®°å½•
            updateSurgeryHospitalizationHistoryRecord(index, field, value) {
                if (!this.currentCustomer.surgeryHospitalizationHistory) {
                    this.currentCustomer.surgeryHospitalizationHistory = [];
                }
                this.currentCustomer.surgeryHospitalizationHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // æ¸²æŸ“ç–«è‹—æ¥ç§å²è¡¨æ ¼
            renderVaccinationHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>ç–«è‹—åç§°</th><th>æ¥ç§æ—¥æœŸ</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.vaccineName || ''}" data-index="${index}" data-field="vaccineName"></td>
                            <td><input type="date" value="${record.vaccinationDate || ''}" data-index="${index}" data-field="vaccinationDate"></td>
                            <td><input type="text" value="${record.notes || ''}" data-index="${index}" data-field="notes"></td>
                            <td>
    <div class="delete-row-icon remove-vaccination" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-vaccination').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeVaccinationHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#vaccinationHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateVaccinationHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ ç–«è‹—æ¥ç§å²è®°å½•
            addVaccinationHistoryRecord() {
                if (!this.currentCustomer.vaccinationHistory) {
                    this.currentCustomer.vaccinationHistory = [];
                }
                
                this.currentCustomer.vaccinationHistory.push({
                    vaccineName: '',
                    vaccinationDate: new Date().toISOString().split('T')[0],
                    notes: ''
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // åˆ é™¤ç–«è‹—æ¥ç§å²è®°å½•
            removeVaccinationHistoryRecord(index) {
                this.currentCustomer.vaccinationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // æ›´æ–°ç–«è‹—æ¥ç§å²è®°å½•
            updateVaccinationHistoryRecord(index, field, value) {
                if (!this.currentCustomer.vaccinationHistory) {
                    this.currentCustomer.vaccinationHistory = [];
                }
                this.currentCustomer.vaccinationHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // æ¸²æŸ“å®¶æ—ç—…å²è¡¨æ ¼
            renderFamilyHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>äº²å±å…³ç³»</th><th>ç–¾ç—…/çŠ¶å†µåç§°</th><th>å‘ç—…å¹´é¾„</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td>
                                <select data-index="${index}" data-field="relationship">
                                    <option value="çˆ¶æ¯" ${record.relationship === 'çˆ¶æ¯' ? 'selected' : ''}>çˆ¶æ¯</option>
                                    <option value="å…„å¼Ÿå§å¦¹" ${record.relationship === 'å…„å¼Ÿå§å¦¹' ? 'selected' : ''}>å…„å¼Ÿå§å¦¹</option>
                                    <option value="å­å¥³" ${record.relationship === 'å­å¥³' ? 'selected' : ''}>å­å¥³</option>
                                    <option value="ç¥–çˆ¶æ¯" ${record.relationship === 'ç¥–çˆ¶æ¯' ? 'selected' : ''}>ç¥–çˆ¶æ¯</option>
                                    <option value="å…¶ä»–" ${record.relationship === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.condition || ''}" data-index="${index}" data-field="condition"></td>
                            <td><input type="number" value="${record.onsetAge || ''}" data-index="${index}" data-field="onsetAge"></td>
                            <td>
    <div class="delete-row-icon remove-family" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-family').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeFamilyHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#familyHistoryContainer select, #familyHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateFamilyHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ å®¶æ—ç—…å²è®°å½•
            addFamilyHistoryRecord() {
                if (!this.currentCustomer.familyHistory) {
                    this.currentCustomer.familyHistory = [];
                }
                
                this.currentCustomer.familyHistory.push({
                    relationship: 'çˆ¶æ¯',
                    condition: '',
                    onsetAge: ''
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // åˆ é™¤å®¶æ—ç—…å²è®°å½•
            removeFamilyHistoryRecord(index) {
                this.currentCustomer.familyHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // æ›´æ–°å®¶æ—ç—…å²è®°å½•
            updateFamilyHistoryRecord(index, field, value) {
                if (!this.currentCustomer.familyHistory) {
                    this.currentCustomer.familyHistory = [];
                }
                this.currentCustomer.familyHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // ========== è´¦æœŸä¿¡æ¯è¡¨æ ¼ç›¸å…³æ–¹æ³• ==========

            // æ¸²æŸ“è†³é£Ÿä¹ æƒ¯è¡¨æ ¼
            renderDietaryHabitsTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>ä¸»ç±»å‹</th><th>å­ç±»å‹</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td>
                                <select data-index="${index}" data-field="mainType">
                                    <option value="å¸¸è§„é¥®é£Ÿ" ${record.mainType === 'å¸¸è§„é¥®é£Ÿ' ? 'selected' : ''}>å¸¸è§„é¥®é£Ÿ</option>
                                    <option value="ç‰¹æ®Šé¥®é£Ÿ" ${record.mainType === 'ç‰¹æ®Šé¥®é£Ÿ' ? 'selected' : ''}>ç‰¹æ®Šé¥®é£Ÿ</option>
                                    <option value="é¥®é£Ÿåå¥½" ${record.mainType === 'é¥®é£Ÿåå¥½' ? 'selected' : ''}>é¥®é£Ÿåå¥½</option>
                                    <option value="é¥®é£Ÿé™åˆ¶" ${record.mainType === 'é¥®é£Ÿé™åˆ¶' ? 'selected' : ''}>é¥®é£Ÿé™åˆ¶</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.subType || ''}" data-index="${index}" data-field="subType"></td>
                            <td><textarea data-index="${index}" data-field="notes" rows="2">${record.notes || ''}</textarea></td>
                            <td>
    <div class="delete-row-icon remove-dietary" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-dietary').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeDietaryHabitsRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#dietaryHabitsContainer select, #dietaryHabitsContainer input, #dietaryHabitsContainer textarea').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateDietaryHabitsRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ è†³é£Ÿä¹ æƒ¯è®°å½•
            addDietaryHabitsRecord() {
                if (!this.currentPeriod.dietaryHabits) {
                    this.currentPeriod.dietaryHabits = [];
                }
                
                this.currentPeriod.dietaryHabits.push({
                    mainType: 'å¸¸è§„é¥®é£Ÿ',
                    subType: '',
                    notes: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // åˆ é™¤è†³é£Ÿä¹ æƒ¯è®°å½•
            removeDietaryHabitsRecord(index) {
                this.currentPeriod.dietaryHabits.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // æ›´æ–°è†³é£Ÿä¹ æƒ¯è®°å½•
            updateDietaryHabitsRecord(index, field, value) {
                if (!this.currentPeriod.dietaryHabits) {
                    this.currentPeriod.dietaryHabits = [];
                }
                this.currentPeriod.dietaryHabits[index][field] = value;
                this.autoSavePeriodInfo();
            },

            // æ¸²æŸ“èº«ä½“æ´»åŠ¨è¡¨æ ¼
            renderPhysicalActivityTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>è¿åŠ¨ç±»å‹</th><th>é¢‘ç‡</th><th>æ—¶é•¿å’Œå¼ºåº¦</th><th>æ—¥å¸¸æ´»åŠ¨æ°´å¹³ä¸ä¹…åæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.exerciseType || ''}" data-index="${index}" data-field="exerciseType"></td>
                            <td><input type="text" value="${record.frequency || ''}" data-index="${index}" data-field="frequency"></td>
                            <td><input type="text" value="${record.durationIntensity || ''}" data-index="${index}" data-field="durationIntensity"></td>
                            <td><input type="text" value="${record.dailyActivity || ''}" data-index="${index}" data-field="dailyActivity"></td>
                            <td>
    <div class="delete-row-icon remove-physical" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-physical').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removePhysicalActivityRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#physicalActivityContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updatePhysicalActivityRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ èº«ä½“æ´»åŠ¨è®°å½•
            addPhysicalActivityRecord() {
                if (!this.currentPeriod.physicalActivity) {
                    this.currentPeriod.physicalActivity = [];
                }
                
                this.currentPeriod.physicalActivity.push({
                    exerciseType: '',
                    frequency: '',
                    durationIntensity: '',
                    dailyActivity: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // åˆ é™¤èº«ä½“æ´»åŠ¨è®°å½•
            removePhysicalActivityRecord(index) {
                this.currentPeriod.physicalActivity.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // æ›´æ–°èº«ä½“æ´»åŠ¨è®°å½•
            updatePhysicalActivityRecord(index, field, value) {
                if (!this.currentPeriod.physicalActivity) {
                    this.currentPeriod.physicalActivity = [];
                }
                this.currentPeriod.physicalActivity[index][field] = value;
                this.autoSavePeriodInfo();
            },

            // æ¸²æŸ“ç¡çœ æ¨¡å¼è¡¨æ ¼
            renderSleepPatternTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>æ•´ä½“ç¡çœ çŠ¶å†µ</th><th>ä¸»è§‚ç¡çœ é—®é¢˜</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.sleepStatus || ''}" data-index="${index}" data-field="sleepStatus"></td>
                            <td><textarea data-index="${index}" data-field="subjectiveProblems" rows="2">${record.subjectiveProblems || ''}</textarea></td>
                            <td>
    <div class="delete-row-icon remove-sleep" data-index="${index}" title="åˆ é™¤">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // ç»‘å®šäº‹ä»¶
                setTimeout(() => {
                    document.querySelectorAll('.remove-sleep').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeSleepPatternRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#sleepPatternContainer input, #sleepPatternContainer textarea').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateSleepPatternRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // æ·»åŠ ç¡çœ æ¨¡å¼è®°å½•
            addSleepPatternRecord() {
                if (!this.currentPeriod.sleepPattern) {
                    this.currentPeriod.sleepPattern = [];
                }
                
                this.currentPeriod.sleepPattern.push({
                    sleepStatus: '',
                    subjectiveProblems: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // åˆ é™¤ç¡çœ æ¨¡å¼è®°å½•
            removeSleepPatternRecord(index) {
                this.currentPeriod.sleepPattern.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // æ›´æ–°ç¡çœ æ¨¡å¼è®°å½•
            updateSleepPatternRecord(index, field, value) {
                if (!this.currentPeriod.sleepPattern) {
                    this.currentPeriod.sleepPattern = [];
                }
                this.currentPeriod.sleepPattern[index][field] = value;
                this.autoSavePeriodInfo();
            }
        };

        // ================= å…¨å±€è‡ªåŠ¨ç¼©æ”¾å¼•æ“ =================
        function autoScalePage() {
            const designWidth = 1400; // è®¾è®¡åŸºå‡†å®½åº¦
            const windowWidth = window.innerWidth;
            
            // æ ¸å¿ƒä¿®æ”¹ï¼šåªæœ‰å½“çª—å£æ¯”è®¾è®¡å®½åº¦â€œå°â€çš„æ—¶å€™ï¼Œæ‰è¿›è¡Œç¼©æ”¾
            // å¦‚æœçª—å£å¾ˆå¤§ï¼Œå°±ä¿æŒåŸæ · (zoom = 1)ï¼Œè®© CSS å¸ƒå±€è‡ªç„¶é“ºæ»¡
            if (windowWidth < designWidth) {
                let scale = windowWidth / designWidth;
                document.body.style.zoom = scale;
            } else {
                document.body.style.zoom = 1; // å¤§å±ä¸ç¼©æ”¾
            }
        }

        window.addEventListener('resize', autoScalePage);
        window.addEventListener('load', autoScalePage);
        // ==========================================================
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            ViewController.init();
        });
    // ================= æƒé™æ§åˆ¶æ¨¡å— =================
        const AuthController = {
            currentUser: null,

            async checkPermission() {
                try {
                    const token = localStorage.getItem('crm_token');
                    // è¯¢é—®åç«¯ï¼šæˆ‘æ˜¯è°ï¼Ÿ
                    // æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»ç”¨å…¨è·¯å¾„ API_BASE_URL
                    const response = await fetch(`${API_BASE_URL}/api/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}` // âœ…é€’é’¥åŒ™
                        }
                    });
                    
                    if (response.ok) {
                        this.currentUser = await response.json();
                        console.log('å½“å‰ç”¨æˆ·:', this.currentUser.username, 'è§’è‰²:', this.currentUser.role);
                        
                        if (this.currentUser.role === 'reader') {
                            this.disableEditingFeatures();
                        }
                    }
                } catch (error) {
                    console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
                }
            },

            disableEditingFeatures() {
                // 1. æ³¨å…¥ä¸€æ®µCSSï¼ŒæŠŠæ‰€æœ‰â€œå±é™©æŒ‰é’®â€éšè—æ‰
                const style = document.createElement('style');
                style.innerHTML = `
                    /* éšè—æ‰€æœ‰æ·»åŠ ã€ä¿å­˜ã€åˆ é™¤ã€ç¼–è¾‘æŒ‰é’® */
                    button.btn-primary, 
                    button.btn-success, 
                    button.btn-danger, 
                    button.btn-warning,
                    .add-record-btn,
                    .add-icon,
                    .remove-indicator,
                    .remove-communication,
                    .remove-followup,
                    .remove-allergy,
                    .remove-medication,
                    .remove-past-medical,
                    .remove-surgery,
                    .remove-vaccination,
                    .remove-family,
                    .remove-dietary,
                    .remove-physical,
                    .remove-sleep,
                    .save-icon,
                    #importBtn,
                    #resetBtn {
                        display: none !important;
                    }
                    
                    /* æ¢å¤å¿…è¦çš„å¯¼èˆªå’Œæœç´¢æŒ‰é’® */
                    #searchConfirmBtn, 
                    #exportDataBtn,
                    #exportWordBtn,
                    #exportExcelBtn,
                    .nav-tab,
                    .page-btn {
                        display: inline-block !important;
                    }
                    
                    /* è®©è¾“å…¥æ¡†å˜æˆåªè¯» (è§†è§‰ä¸Š) */
                    input, textarea, select {
                        pointer-events: none;
                        background-color: #f9f9f9;
                    }
                    /* æ¢å¤æœç´¢æ¡†çš„å¯ç¼–è¾‘æ€§ */
                    .search-filter input {
                        pointer-events: auto;
                        background-color: white;
                    }
                `;
                document.head.appendChild(style);
                
                // 2. é¢å¤–çš„æç¤º
                const header = document.querySelector('header .header-content');
                const badge = document.createElement('div');
                badge.style.cssText = "background: #ffc107; color: #333; padding: 5px 10px; border-radius: 4px; font-weight: bold; margin-left: 10px;";
                badge.innerText = "ğŸ‘€ è®¿å®¢æ¨¡å¼ (ä»…é˜…è¯»)";
                header.appendChild(badge);
            }
        };

        // ä¿®æ”¹åˆå§‹åŒ–é€»è¾‘ï¼Œå…ˆæ£€æŸ¥æƒé™
        const originalInit = ViewController.init;
        ViewController.init = async function() {
            await originalInit.call(this); // å…ˆæ‰§è¡ŒåŸæœ‰çš„åˆå§‹åŒ–
            await AuthController.checkPermission(); // å†æ‰§è¡Œæƒé™æ£€æŸ¥
        };
        // ================= æƒé™æ¨¡å—ç»“æŸ =================
    </script>
</body>
<style>
    .delete-row-icon {
        width: 30px !important;
        height: 30px !important;
        display: inline-flex !important; /* å…³é”®ï¼šè®©å®ƒåˆ«å æ»¡ä¸€è¡Œ */
        align-items: center !important;
        justify-content: center !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        margin: 0 auto !important;
        background: transparent !important; /* é»˜è®¤æ— èƒŒæ™¯ */
    }

    /* 2. å¼ºåˆ¶åŠ æ‚¬åœæ•ˆæœ */
    .delete-row-icon:hover {
        background-color: #fee2e2 !important; /* æ‚¬åœå˜æ·¡çº¢è‰² */
    }
    .delete-row-icon svg {
        width: 18px !important;  /* å‹å°å°ºå¯¸ */
        height: 18px !important; /* å‹å°å°ºå¯¸ */
        color: #dc3545 !important; /* å¼ºåˆ¶å˜çº¢ */
        stroke: #dc3545 !important; /* å¼ºåˆ¶å˜çº¢ */
        fill: none !important;
        pointer-events: none !important; /* é˜²æ­¢ç‚¹ä¸åˆ° */
        display: block !important;
    }
</style>
</html>