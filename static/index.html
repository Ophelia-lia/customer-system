<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC客户管理</title>
    <!-- 引入Dexie.js库 -->
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #555;
            line-height: 1.6;
            padding-top: 60px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 头部样式 - 修改为固定定位 */
        header {
            background: #ffffff; /* 雪白色 */
            color: #333; /* 文字颜色改为深色 */
            padding: 20px 0;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 20px;
            font-weight: bold;
            color: #555;
            margin: 0;
        }
        
        /* 导航样式 - 修改为固定定位 */
        .nav-tabs {
            display: none !important;
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            position: fixed;
            top: 90px;
            left: 0;
            right: 0;
            z-index: 999;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab.active {
            background-color: #f6f2f1;
            color: #787785;
            border-bottom: 3px solid #787785;
        }
        
        .nav-tab:hover:not(.active) {
            background-color: #f8f9fa;
        }
        
        /* 页面内容样式 */
        .page {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 10px 20px 20px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .page.active {
            display: block;
        }
        
        /* 表格样式 - 表头取消加粗 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: normal; /* 取消加粗 */
            color: #495057;
        }
        
        tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }

        /* 添加选中行的样式 */
        tr.selected {
            background-color: #e9ecef;
            border-left: 3px solid #787785;
        }
        
        /* 按钮样式 - 头部按钮使用冷灰粉色系 */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: #787785; /* 冷灰粉 */
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #6a6a78;
        }
        
        .btn-secondary {
            background-color: #DEB7B8; /* 冷灰粉 */
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #d1a9aa;
        }
        
        .btn-success {
            background-color: #F2D5D7; /* 冷灰粉 */
            color: #333;
        }
        
        .btn-success:hover {
            background-color: #e8c8ca;
        }
        
        .btn-danger {
            background-color: #FDEBEB; /* 冷灰粉 */
            color: #333;
        }
        
        .btn-danger:hover {
            background-color: #f5dddd;
        }
        
        .btn-warning {
            background-color: #F6F2F1; /* 冷灰粉 */
            color: #333;
        }
        
        .btn-warning:hover {
            background-color: #ede9e8;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* 添加记录按钮样式 - 浅蓝色背景，黑色字体，不加粗 */
        .add-record-btn {
            background-color: #ECCEDF; /* 浅玫瑰粉 */
            color: #333; /* 黑色字体 */
            font-weight: normal; /* 不加粗 */
            border: 1px solid #ECCEDF;
        }
        
        .add-record-btn:hover {
            background-color: #009F73; /* 森林绿 */

        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #787785;
            outline: none;
            box-shadow: 0 0 0 2px rgba(120, 119, 133, 0.25);
        }
        
        input[readonly] {
            background-color: #e9ecef;
            opacity: 1;
        }
        
        /* 日期和数字使用蓝紫色字体 */
        input[type="date"], input[type="number"] {
            color: #0077be;
        }
        
        /* 搜索和筛选区域 */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .search-box, .filter-box {
            flex: 1;
            min-width: 150px; /* 缩短搜索框宽度 */
        }
        
        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-btn.active {
            background-color: #787785;
            color: white;
            border-color: #787785;
        }
        
        /* 标签页样式 */
        .tab-container {
            margin-top: 0px;
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
            position: sticky;
            top: 85px; /* 固定在页面顶部 */
            background: white;
            z-index: 998;
            padding: 0;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
           font-size: 16px; 
            font-weight: 600; 
            color: #666;
        }
        
        .tab.active {
           border-bottom: 3px solid #492D22;
            color: #492D22;
            font-weight: bold;
            background-color: #f0f7ff;
        }
        
        .tab-content {
            padding: 20px 0;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* 右上角图标容器 */
        .header-icons {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px; /* 图标之间的间距 */
            z-index: 1001;
        }

        /* 通用图标样式 */
        .header-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .header-icon:hover {
            background-color: #f1f1f1;
            color: #333;
        }

        /* 保存图标特有样式 (鼠标悬停变蓝) */
        .header-icon.save-action:hover {
            color: #203F9A; 
            background-color: #eef2ff;
        }

        /* 关闭图标特有样式 (鼠标悬停变红) */
        .header-icon.close-action:hover {
            color: #dc3545;
            background-color: #fff5f5;
        }
        
        /* 财务图表样式 */
        .finance-chart {
            height: 40px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
            cursor: pointer;
            position: relative;
        }
        
        .chart-segment {
            height: 100%;
            display: inline-block;
            float: left;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px; /* 修改：增大模态框最大宽度 */
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        /* 保存提示样式 */
        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
        }
        
        .save-notification.show {
            opacity: 1;
        }
        
        /* 按钮组样式 */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }
        
        .finance-button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }
        
        /* 三列布局样式 */
        .three-column-form {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        /* 图表容器样式 */
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }
        
        /* 指标对比表格样式 */
        .indicators-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .indicators-table th, .indicators-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .indicators-table th {
            background-color: #f8f9fa;
            font-weight: normal; /* 取消加粗 */
        }
        
        /* 财务统计页面样式 */
        .finance-summary {
            margin-bottom: 20px;
        }
        
        .finance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .finance-table th, .finance-table td {
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        
        .finance-table th {
            background-color: #f8f9fa;
            font-weight: normal; /* 取消加粗 */
        }
        
        .finance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        /* 健康字段布局 */
        .health-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .health-select {
            flex: 1;
        }
        
        .health-input {
            flex: 2;
        }
        
        /* 折叠面板样式 */
        .collapse-panel {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .collapse-header {
            padding: 12px 15px;
            background-color: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        
        .collapse-content {
            padding: 15px;
            display: none;
        }
        
        .collapse-content.active {
            display: block;
        }
        
        .collapse-icon {
            transition: transform 0.3s ease;
        }
        
        .collapse-panel.active .collapse-icon {
            transform: rotate(180deg);
        }
        
        /* 回访记录表格样式 */
        .followup-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .followup-table th, .followup-table td {
            padding: 8px 10px;
            border: 1px solid #dee2e6;
        }
        
        .followup-table th {
            background-color: #f8f9fa;
            font-weight: normal; /* 取消加粗 */
        }
        
        /* 账期选择器样式 */
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .period-selector select {
            flex: 1;
            max-width: 300px;
        }
        
        /* 特定标题颜色 */
        #allergyHistoryContainer label,
        #medicationHistoryContainer label,
        #pastMedicalHistoryContainer label,
        #surgeryHospitalizationHistoryContainer label,
        #vaccinationHistoryContainer label,
        #familyHistoryContainer label,
        #dietaryHabitsContainer label,
        #physicalActivityContainer label,
        #sleepPatternContainer label,
        #abnormalIndicatorsContainer label,
        #communicationRecordsContainer label,
        #followUpRecordsContainer label {
            color: #2F2F2F;
            font-weight: 500;
        }
        
        /* 加号图标样式 - 修改为简单加号，去掉圆形背景 */
        .add-icon {
            display: inline-block;
            color: #CC79A8; /* 玫瑰色 */
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            transition: color 0.2s ease;
            line-height: 1;
        }
        
        .add-icon:hover {
            color: #6a6a78;
        }
        
        /* 标题容器样式 */
        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        /* 指标对比搜索样式 */
        .indicators-search {
            margin-bottom: 20px;
        }
        
        /* 可点击单元格样式 */
        .clickable-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .clickable-cell:hover {
            background-color: #e9ecef;
        }
        
        /* 保存图标样式 */
        .save-icon {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #28a745;
            margin-left: 10px;
        }
        
        /* 正常值样式 - 森林绿 */
        .normal-value {
            color: #009F73;
        }
        
        /* 下拉菜单样式 */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            border: none;
            background: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dropdown-content button:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        /* 拖拽区域样式 */
        .drop-zone {
            border: 2px dashed #ced4da;
            border-radius: 4px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drop-zone.active {
            border-color: #787785;
            background-color: rgba(120, 119, 133, 0.05);
        }
        
        .drop-zone p {
            margin-bottom: 10px;
            color: #6c757d;
        }
        
        /* 多选列表样式 */
        .customer-checkboxes {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
        }
        
        .customer-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .customer-checkbox-item:last-child {
            border-bottom: none;
        }
        
        .customer-checkbox-item input {
            width: auto;
            margin-right: 10px;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部背景已改为雪白色，并固定定位 -->
        <header>
            <div class="header-content">
                <h1>TC客户管理</h1>
                <div class="header-actions">
                    <!-- 按钮已使用冷灰粉色系 -->
                    <button id="exportDataBtn" class="btn btn-primary">导出数据</button>
                    <button id="exportWordBtn" class="btn btn-secondary">导出Word文档</button>
                    <!-- 修改：将导出财务Excel按钮改为导出Excel下拉菜单 -->
                    <div class="dropdown">
                        <button id="exportExcelBtn" class="btn btn-success">导出Excel</button>
                        <div class="dropdown-content">
                            <button id="exportFinanceExcelBtn">导出财务Excel</button>
                            <button id="exportIndicatorsExcelBtn">导出指标对比Excel</button>
                            <!-- 新增：导出客户列表Excel按钮 -->
                            <button id="exportCustomerListExcelBtn">导出客户列表Excel</button>
                            <!-- 新增：导出服务账期列表Excel按钮 -->
                            <button id="exportPeriodListExcelBtn">导出服务账期列表Excel</button>
                        </div>
                    </div>
                    <button id="importBtn" class="btn btn-danger">导入数据</button>
                    <button id="resetBtn" class="btn btn-warning">重置数据</button>
                </div>
            </div>
        </header>
        
        <!-- 导航标签栏固定定位 -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-page="customer-list">客户列表</div>
            <div class="nav-tab" data-page="customer-detail">客户详情</div>
        </div>
        
        <!-- 客户列表页面 -->
        <div id="customer-list" class="page active">
            <div class="search-filter">
                <!-- 修改：搜索框标签改为"客户姓名"和"顾问" -->
                <div class="search-box">
                    <label for="searchInput">客户姓名</label>
                    <input type="text" id="searchInput" placeholder="输入客户姓名...">
                </div>
                <div class="search-box">
                    <label for="customerServiceSearch">顾问</label>
                    <input type="text" id="customerServiceSearch" placeholder="输入顾问姓名...">
                </div>
                <div class="filter-box">
                    <label for="startPeriod">交付起始日期</label>
                    <input type="date" id="startPeriod">
                </div>
                <div class="filter-box">
                    <label for="endPeriod">交付结束日期</label>
                    <input type="date" id="endPeriod">
                </div>
                <button id="searchConfirmBtn" class="btn btn-primary">确定</button>
                <button id="addCustomerBtn" class="btn btn-success">添加新客户</button>
                <button id="deleteCustomerBtn" class="btn btn-danger">删除客户</button>
            </div>
            
            <table id="customersTable">
                <thead>
                    <tr>
                        <!-- 删除客户编号列 -->
                        <th>客户姓名</th>
                        <th>性别</th>
                        <th>年龄</th>
                        <th>服务进度</th>
                        <th>销售</th>
                        <th>顾问</th>
                        <th>下次交付时间</th>
                        <th>剩余期数</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 客户数据将通过JS动态填充 -->
                </tbody>
            </table>
            
            <div class="pagination" id="pagination">
                <!-- 分页按钮将通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 客户详情页面 -->
        <div id="customer-detail" class="page">
            <!-- 删除客户详情标题 -->
            
            <div class="tab-container">
                <div class="tab-header">
                    <div class="tab active" data-tab="personal-info">个人信息</div>
                    <div class="tab" data-tab="period-info">账期信息</div>
                    <div class="tab" data-tab="finance-info">财务统计</div>
                    <div class="tab" data-tab="indicators-compare">指标对比</div>
                    
                    <div class="header-icons">
                        <div id="globalSaveBtn" class="header-icon save-action" title="保存当前页面">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                        </div>
                        <div id="closeDetailBtn" class="header-icon close-action" title="返回列表">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- 个人信息标签页 -->
                <div id="personal-info" class="tab-content active">
                    <form id="personalInfoForm" class="three-column-form">
                        <!-- 表单内容将通过JS动态生成 -->
                    </form>
                </div>
                
                <!-- 账期信息标签页 -->
                <div id="period-info" class="tab-content">
                    <div class="period-selector">
                        <select id="periodSelect">
                            <!-- 账期选项将通过JS动态添加 -->
                        </select>
                        <button id="refreshPeriodBtn" class="btn btn-primary">刷新</button>
                        <button id="addPeriodBtn" class="btn btn-success">添加新账期</button>
                        <button id="editPeriodBtn" class="btn btn-warning">修改账期</button>
                    </div>
                    
                    <div id="periodFormContainer">
                        <!-- 账期表单内容将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 财务统计标签页 -->
                <div id="finance-info" class="tab-content">
                    <div class="finance-header">
                        <h3>财务统计概览</h3>
                        <button id="addFinanceRecordBtn" class="btn btn-primary">添加财务记录</button>
                    </div>
                    
                    <div class="finance-chart-container">
                        <div id="financeChart" class="finance-chart">
                            <!-- 财务图表将通过JS动态生成 -->
                        </div>
                        <!-- 删除提示文字 -->
                    </div>
                    
                    <div class="finance-summary">
                        <h4>分类统计</h4>
                        <table class="finance-table" id="financeSummaryTable">
                            <thead>
                                <tr>
                                    <th>主分类</th>
                                    <th>金额总和</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 财务统计数据将通过JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 指标对比标签页 -->
                <div id="indicators-compare" class="tab-content">
                    <div class="indicators-search">
                        <label for="indicatorSearch">搜索指标名称</label>
                        <input type="text" id="indicatorSearch" placeholder="输入指标名称...">
                    </div>
                    <div id="indicatorsTableContainer">
                        <!-- 指标对比表格将通过JS动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 财务详情模态框 -->
        <div id="financeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="financeModalTitle">财务记录详情</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- 财务记录内容将通过JS动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 添加/编辑财务记录模态框 -->
        <div id="financeRecordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="financeRecordModalTitle">添加财务记录</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="financeRecordForm">
                        <div class="form-group">
                            <label for="financePeriod">账期</label>
                            <select id="financePeriod" required>
                                <!-- 账期选项将通过JS动态生成 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="financeMainCategory">主分类</label>
                            <select id="financeMainCategory" required>
                                <option value="订单记录">订单记录</option>
                                <option value="成本记录">成本记录</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="financeSubCategory">子分类</label>
                            <select id="financeSubCategory" required>
                                <!-- 子分类选项将通过JS动态生成 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="financeAmount">金额</label>
                            <input type="number" id="financeAmount" required>
                        </div>
                        <div class="form-group">
                            <label for="financeDate">日期</label>
                            <input type="date" id="financeDate" required>
                        </div>
                        <div class="form-group">
                            <label for="financeNotes">备注</label>
                            <textarea id="financeNotes" rows="3"></textarea>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary" id="saveFinanceRecordBtn">保存</button>
                            <button type="button" class="btn btn-secondary" id="cancelFinanceRecordBtn">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 添加账期模态框 -->
        <div id="addPeriodModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>添加新账期</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addPeriodForm">
                        <div class="form-group">
                            <label for="newPeriodDate">账期日期</label>
                            <input type="date" id="newPeriodDate" required>
                        </div>
                        <button type="submit" class="btn btn-primary">添加</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 修改账期模态框 -->
        <div id="editPeriodModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>修改账期</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editPeriodForm">
                        <div class="form-group">
                            <label for="editPeriodNumber">账期编号</label>
                            <input type="text" id="editPeriodNumber" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editPeriodDate">账期日期</label>
                            <input type="date" id="editPeriodDate" required>
                        </div>
                        <button type="submit" class="btn btn-primary">修改</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 导入异常指标模态框 -->
        <div id="importIndicatorsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>导入异常检测指标</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="importIndicatorsForm">
                        <div class="form-group">
                            <label for="measurementDate">检测日期</label>
                            <input type="date" id="measurementDate">
                        </div>
                        <div class="form-group">
                            <label for="testingInstitution">检测机构</label>
                            <input type="text" id="testingInstitution">
                        </div>
                        <!-- 修改：添加下载模板按钮和粘贴文本区域 -->
                        <div class="form-group">
                            <label>Excel导入方式</label>
                            <button type="button" id="downloadTemplateBtn" class="btn btn-primary" style="margin-bottom: 10px;">下载Excel模板</button>
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                请下载模板，在Excel中填写数据后，复制内容粘贴到下方文本框
                            </p>
                            <textarea id="pastedExcelData" rows="8" placeholder="请将Excel中的数据复制粘贴到此處..."></textarea>
                        </div>
                        <!-- 新增：JSON导入方式 -->
                        <div class="form-group">
                            <label>JSON导入方式</label>
                            <input type="file" id="jsonFileInput" accept=".json" style="margin-bottom: 10px;">
                            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                请选择JSON格式的指标数据文件
                            </p>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary">导入</button>
                            <button type="button" class="btn btn-secondary" id="cancelImportIndicatorsBtn">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 导出Word模态框 -->
        <div id="exportWordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>导出Word文档</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>选择要导出的账期:</label>
                        <div id="periodsCheckboxes">
                            <!-- 账期复选框将通过JS动态生成 -->
                        </div>
                    </div>
                    <button id="confirmExportWordBtn" class="btn btn-primary">确认导出</button>
                </div>
            </div>
        </div>
        
        <!-- 重置确认模态框 -->
        <div id="resetConfirmModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>确认重置数据</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>此操作将永久删除所有客户数据、账期信息和财务记录，且无法恢复。建议先导出备份数据。确定要继续吗？</p>
                    <div class="button-group">
                        <button id="confirmResetBtn" class="btn btn-danger">确认重置</button>
                        <button id="cancelResetBtn" class="btn btn-secondary">取消</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 删除确认模态框 -->
        <div id="deleteConfirmModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>确认删除</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage">确定要删除这条财务记录吗？此操作不可恢复。</p>
                    <div class="button-group">
                        <button id="confirmDeleteBtn" class="btn btn-danger">确认删除</button>
                        <button id="cancelDeleteBtn" class="btn btn-secondary">取消</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 指标编辑模态框 -->
        <div id="indicatorEditModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>编辑指标记录</h3>
                    <div>
                        <button class="save-icon" title="保存">✓</button>
                        <button class="close-modal">&times;</button>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="indicatorEditForm">
                        <div class="form-group">
                            <label for="editIndicatorName">指标名称</label>
                            <input type="text" id="editIndicatorName" required>
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorValue">数值</label>
                            <input type="text" id="editIndicatorValue" required>
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorUnit">单位</label>
                            <input type="text" id="editIndicatorUnit">
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorReference">参考范围</label>
                            <input type="text" id="editIndicatorReference">
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorDate">测量时间</label>
                            <input type="date" id="editIndicatorDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editIndicatorInstitution">检测机构</label>
                            <input type="text" id="editIndicatorInstitution">
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-danger" id="deleteIndicatorBtn">删除记录</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 导出数据模态框 - 修改：支持多选和批量导出 -->
        <div id="exportDataModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>导出数据</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="customerSearchInput">搜索客户</label>
                        <input type="text" id="customerSearchInput" placeholder="输入客户姓名搜索...">
                    </div>
                    <div class="form-group">
                        <label>选择客户（可多选）</label>
                        <div class="customer-checkboxes" id="customerCheckboxes">
                            <!-- 客户复选框将通过JS动态生成 -->
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="exportSelectedDataBtn" class="btn btn-primary">导出选中客户数据</button>
                        <button id="exportCurrentListDataBtn" class="btn btn-secondary">导出当前列表数据</button>
                        <button id="exportAllDataInModalBtn" class="btn btn-warning">导出全部数据</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 删除客户确认模态框 -->
        <div id="deleteCustomerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>确认删除客户</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="deleteCustomerMessage">是否确认删除客户编号[编号][姓名]的所有信息？</p>
                    <div class="button-group">
                        <button id="confirmDeleteCustomerBtn" class="btn btn-danger">确认删除</button>
                        <button id="cancelDeleteCustomerBtn" class="btn btn-secondary">取消</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 导入数据模态框 - 新增：支持拖拽导入 -->
        <div id="importDataModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>导入数据</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="drop-zone" id="dropZone">
                        <p>拖拽JSON文件到这里，或点击选择文件</p>
                        <p style="font-size: 12px; color: #666;">支持批量导入多个JSON文件</p>
                        <input type="file" id="importFileInput" multiple accept=".json" style="display: none;">
                        <button type="button" id="selectFilesBtn" class="btn btn-primary">选择文件</button>
                    </div>
                    <div id="importFileList" style="margin-top: 15px;">
                        <!-- 导入文件列表将通过JS动态生成 -->
                    </div>
                    <div class="button-group">
                        <button id="confirmImportBtn" class="btn btn-primary">确认导入</button>
                        <button id="cancelImportBtn" class="btn btn-secondary">取消</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 文件输入（用于导入数据） -->
        <input type="file" id="fileInput" style="display: none;" accept=".json">
        
        <!-- 保存提示 -->
        <div id="saveNotification" class="save-notification">数据已保存</div>
    </div>

    <script>
        // 定义Dexie数据库
        const db = new Dexie('CustomerManagementSystem');
        
        // 定义数据库结构
        db.version(1).stores({
            customers: 'id, personalInfo.name, personalInfo.customerService, personalInfo.nextDeliveryDate',
            settings: 'key'
        });

        // 数据模型 - 修改为使用Dexie.js
        const CustomerModel = {
    // API 基础路径
    baseUrl: '/api',

    async loadData() {
        try {
            const response = await fetch(`${this.baseUrl}/load_data`);
            if (!response.ok) throw new Error('网络响应异常');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('加载数据失败:', error);
            // 降级处理：如果连不上网，返回空结构防止报错
            return {
                customers: [],
                nextCustomerId: 1,
                settings: { pageSize: 10 }
            };
        }
    },
    
    async saveData(data) {
        try {
            const response = await fetch(`${this.baseUrl}/save_data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) throw new Error('保存失败');
            return true;
        } catch (error) {
            console.error('保存数据失败:', error);
            alert('警告：数据保存到服务器失败，请检查网络连接！');
            return false;
        }
    },
            
            // 迁移旧数据
            async migrateOldData() {
                try {
                    // 检查是否已经迁移过
                    const migrationFlag = await db.settings.get('migrationCompleted');
                    if (migrationFlag && migrationFlag.value === true) {
                        console.log('数据已迁移，跳过迁移过程');
                        return;
                    }
                    
                    // 检查localStorage中是否有旧数据
                    const oldData = localStorage.getItem('customerManagementSystem');
                    if (!oldData) {
                        console.log('没有找到旧数据，跳过迁移');
                        // 标记迁移完成
                        await db.settings.put({ key: 'migrationCompleted', value: true });
                        return;
                    }
                    
                    console.log('开始迁移旧数据...');
                    
                    // 解析旧数据
                    const parsedData = JSON.parse(oldData);
                    
                    // 保存到Dexie
                    const success = await this.saveData(parsedData);
                    
                    if (success) {
                        console.log('数据迁移成功');
                        // 标记迁移完成
                        await db.settings.put({ key: 'migrationCompleted', value: true });
                        
                        // 可选：删除localStorage中的旧数据
                        // localStorage.removeItem('customerManagementSystem');
                    } else {
                        console.error('数据迁移失败');
                    }
                } catch (error) {
                    console.error('迁移数据时出错:', error);
                }
            },
            
            // 生成客户ID
            generateCustomerId(data) {
        const id = `C${data.nextCustomerId.toString().padStart(5, '0')}`;
        data.nextCustomerId++;
        return id;
    },
    
    calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    },
    
    calculateBMI(height, weight) {
        if (!height || !weight) return 0;
        const heightInMeters = height / 100;
        return (weight / (heightInMeters * heightInMeters)).toFixed(2);
    },
    
    getAllPeriods(data) {
        const periods = new Set();
        data.customers.forEach(customer => {
            if(customer.periods) {
                customer.periods.forEach(period => {
                    periods.add(period.periodName);
                });
            }
        });
        return Array.from(periods).sort();
    },
    
    getLatestPeriod(customer) {
        if (!customer.periods || customer.periods.length === 0) return null;
        return customer.periods.sort((a, b) => {
            return b.periodName.localeCompare(a.periodName);
        })[0];
    },
    
    generatePeriodName(date, customer) {
        const dateObj = new Date(date);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const dateStr = `${year}${month}${day}`;
        const existingPeriods = customer.periods || [];
        let maxNumber = 0;
        existingPeriods.forEach(period => {
            const match = period.periodName.match(/^(\d{2})-\d{8}$/);
            if (match) {
                const num = parseInt(match[1]);
                if (num > maxNumber) maxNumber = num;
            }
        });
        const nextNumber = maxNumber + 1;
        const numberStr = String(nextNumber).padStart(2, '0');
        return `${numberStr}-${dateStr}`;
    },
    
    getAllIndicatorNames(customer) {
        const indicatorNames = new Set();
        if (customer.periods) {
            customer.periods.forEach(period => {
                if (period.abnormalIndicators) {
                    period.abnormalIndicators.forEach(indicator => {
                        indicatorNames.add(indicator.name);
                    });
                }
            });
        }
        return Array.from(indicatorNames);
    },
    
    getNextDeliveryDate(customer) {
        const remainingPeriods = this.getRemainingPeriods(customer);
        if (remainingPeriods <= 0) return '';
        if (!customer.periods || customer.periods.length === 0) return '';
        const dates = customer.periods
            .map(p => p.periodDate)
            .filter(d => d)
            .sort((a, b) => new Date(b) - new Date(a));
        if (dates.length === 0) return '';
        const lastDate = new Date(dates[0]);
        lastDate.setDate(lastDate.getDate() + 70);
        return lastDate.toISOString().split('T')[0];
    },
    
    getOrderTotal(customer) {
        let total = 0;
        if (customer.periods) {
            customer.periods.forEach(period => {
                if (period.financialStats) {
                    period.financialStats.forEach(record => {
                        if (record.mainCategory === '订单记录') {
                            total += record.amount;
                        }
                    });
                }
            });
        }
        return total;
    },
    
    getRemainingPeriods(customer) {
        const totalServicePeriods = customer.personalInfo.totalServicePeriods || 0;
        const usedPeriods = customer.periods ? customer.periods.length : 0;
        const remaining = totalServicePeriods - usedPeriods;
        return Math.max(0, remaining);
    }
};

        // 视图控制器
        const ViewController = {
            currentPage: 'customer-list',
            currentCustomer: null,
            currentPeriod: null,
            currentPageIndex: 0,
            autoSaveTimeout: null,
            editingFinanceRecord: null,
            recordToDelete: null,
            editingIndicator: null,
            indicatorSearchTerm: '',
            selectedCustomerId: null, // 新增：选中的客户ID
            selectedCustomerIds: [], // 新增：多选客户ID数组
            importFiles: [], // 新增：导入文件列表
            
            async init() {
                // 先迁移旧数据
                await CustomerModel.migrateOldData();
                
                this.bindEvents();
                this.showPage('customer-list');
                this.renderCustomerList();
                // 移除默认日期设置
                this.setDefaultPeriodDates();
            },
            
            // 设置默认交付日期区间 - 修改：移除默认日期设置
            setDefaultPeriodDates() {
                // 移除默认日期设置，让用户手动选择
                // 保持日期输入框为空，这样新客户就能显示
                document.getElementById('startPeriod').value = '';
                document.getElementById('endPeriod').value = '';
            },
            
            // 绑定事件
            bindEvents() {
                // 导航标签点击事件
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const page = tab.getAttribute('data-page');
                        this.showPage(page);
                    });
                });
                
                // === 顶部图标逻辑 ===
                
                // 1. 关闭按钮：返回列表
                const closeBtn = document.getElementById('closeDetailBtn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.showPage('customer-list');
                    });
                }

                // 2. 全局保存按钮：智能判断当前Tab
                const saveBtn = document.getElementById('globalSaveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        // 获取当前激活的 tab ID
                        const activeTab = document.querySelector('.tab-content.active').id;
                        
                        switch(activeTab) {
                            case 'personal-info':
                                this.savePersonalInfo();
                                break;
                            case 'period-info':
                                this.savePeriodInfo();
                                break;
                            case 'finance-info':
                            case 'indicators-compare':
                                // 这两个页面通常是即时保存或无需保存，给个提示即可
                                this.showSaveNotification(); 
                                break;
                        }
                    });
                }

                // 客户列表相关事件
                document.getElementById('searchConfirmBtn').addEventListener('click', () => {
                    this.renderCustomerList();
                });
                
                document.getElementById('addCustomerBtn').addEventListener('click', () => {
                    this.addNewCustomer();
                });
                
                // 新增：删除客户按钮事件
                document.getElementById('deleteCustomerBtn').addEventListener('click', () => {
                    this.showDeleteCustomerModal();
                });
                
                // 账期相关事件
                document.getElementById('refreshPeriodBtn').addEventListener('click', () => {
                    this.refreshPeriod();
                });
                
                document.getElementById('addPeriodBtn').addEventListener('click', () => {
                    this.showAddPeriodModal();
                });
                
                // 新增：修改账期按钮事件
                document.getElementById('editPeriodBtn').addEventListener('click', () => {
                    this.showEditPeriodModal();
                });
                
                // 账期选择变化事件
                document.getElementById('periodSelect').addEventListener('change', () => {
                    this.refreshPeriod();
                });
                
                // 财务相关事件
                document.getElementById('addFinanceRecordBtn').addEventListener('click', () => {
                    this.showFinanceRecordModal();
                });
                
                // 标签页切换事件
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.getAttribute('data-tab'));
                    });
                });
                
                // 模态框关闭事件
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.closeModal(btn.closest('.modal'));
                    });
                });
                
                // 财务图表点击事件 - 修改：添加订单总额背景点击事件
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('finance-chart') || 
                        e.target.classList.contains('chart-segment') ||
                        e.target.classList.contains('order-total-background')) {
                        const category = e.target.getAttribute('data-category');
                        if (category) {
                            this.showFinanceModal(category);
                        } else if (e.target.classList.contains('order-total-background')) {
                            // 点击订单总额背景
                            this.showFinanceModal('订单记录');
                        }
                    }
                });
                
                // 导入导出事件
                document.getElementById('exportDataBtn').addEventListener('click', () => {
                    this.showExportDataModal();
                });
                
                document.getElementById('exportWordBtn').addEventListener('click', () => {
                    this.showExportWordModal();
                });
                
                // 修改：移除原来的导出财务Excel事件，添加新的下拉菜单事件
                document.getElementById('exportFinanceExcelBtn').addEventListener('click', () => {
                    this.exportFinanceExcel();
                });
                
                document.getElementById('exportIndicatorsExcelBtn').addEventListener('click', () => {
                    this.exportIndicatorsExcel();
                });
                
                // 新增：导出客户列表Excel事件
                document.getElementById('exportCustomerListExcelBtn').addEventListener('click', () => {
                    this.exportCustomerListExcel();
                });
                
                // 新增：导出服务账期列表Excel事件
                document.getElementById('exportPeriodListExcelBtn').addEventListener('click', () => {
                    this.exportPeriodListExcel();
                });
                
                // 修改：导入数据事件 - 改为显示导入数据模态框
                document.getElementById('importBtn').addEventListener('click', () => {
                    this.showImportDataModal();
                });
                
                // 新增：导入数据模态框事件
                document.getElementById('selectFilesBtn').addEventListener('click', () => {
                    document.getElementById('importFileInput').click();
                });
                
                document.getElementById('importFileInput').addEventListener('change', (e) => {
                    this.handleImportFiles(e.target.files);
                });
                
                document.getElementById('confirmImportBtn').addEventListener('click', () => {
                    this.importSelectedFiles();
                });
                
                document.getElementById('cancelImportBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('importDataModal'));
                });
                
                // 拖拽区域事件
                const dropZone = document.getElementById('dropZone');
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('active');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('active');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('active');
                    this.handleImportFiles(e.dataTransfer.files);
                });
                
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.showResetConfirmModal();
                });
                
                // 添加账期表单提交事件
                document.getElementById('addPeriodForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addPeriod();
                });
                
                // 修改账期表单提交事件
                document.getElementById('editPeriodForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.editPeriod();
                });
                
                // 财务记录表单提交事件
                document.getElementById('financeRecordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveFinanceRecord();
                });
                
                document.getElementById('cancelFinanceRecordBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('financeRecordModal'));
                });
                
                // 导入指标表单提交事件
                document.getElementById('importIndicatorsForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.importIndicators();
                });
                
                // 新增：取消导入指标事件
                document.getElementById('cancelImportIndicatorsBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('importIndicatorsModal'));
                });
                
                // 新增：下载模板事件
                document.getElementById('downloadTemplateBtn').addEventListener('click', () => {
                    this.downloadExcelTemplate();
                });
                
                // 新增：JSON文件导入事件
                document.getElementById('jsonFileInput').addEventListener('change', (e) => {
                    this.importIndicatorsFromJSON(e.target.files[0]);
                });
                
                // 确认导出Word事件
                document.getElementById('confirmExportWordBtn').addEventListener('click', () => {
                    this.exportWord();
                });
                
                // 重置确认事件
                document.getElementById('confirmResetBtn').addEventListener('click', () => {
                    this.resetAllData();
                });
                
                document.getElementById('cancelResetBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('resetConfirmModal'));
                });
                
                // 删除确认事件
                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    this.deleteFinanceRecord();
                });
                
                document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('deleteConfirmModal'));
                });
                
                // 财务主分类变化事件
                document.getElementById('financeMainCategory').addEventListener('change', (e) => {
                    this.updateFinanceSubCategory(e.target.value);
                });
                
                // 折叠面板事件
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('collapse-header')) {
                        const panel = e.target.closest('.collapse-panel');
                        panel.classList.toggle('active');
                    }
                });

                // 个人信息表格事件绑定
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-allergy-icon')) {
                        this.addAllergyHistoryRecord();
                    } else if (e.target.classList.contains('add-medication-icon')) {
                        this.addMedicationHistoryRecord();
                    } else if (e.target.classList.contains('add-past-medical-icon')) {
                        this.addPastMedicalHistoryRecord();
                    } else if (e.target.classList.contains('add-surgery-icon')) {
                        this.addSurgeryHospitalizationHistoryRecord();
                    } else if (e.target.classList.contains('add-vaccination-icon')) {
                        this.addVaccinationHistoryRecord();
                    } else if (e.target.classList.contains('add-family-icon')) {
                        this.addFamilyHistoryRecord();
                    }
                });

                // 账期信息表格事件绑定
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-dietary-icon')) {
                        this.addDietaryHabitsRecord();
                    } else if (e.target.classList.contains('add-physical-icon')) {
                        this.addPhysicalActivityRecord();
                    } else if (e.target.classList.contains('add-sleep-icon')) {
                        this.addSleepPatternRecord();
                    } else if (e.target.classList.contains('add-communication-icon')) {
                        this.addCommunicationRecord();
                    } else if (e.target.classList.contains('add-followup-icon')) {
                        this.addFollowUpRecord();
                    }
                });
                
                // 指标搜索事件
                document.getElementById('indicatorSearch').addEventListener('input', (e) => {
                    this.indicatorSearchTerm = e.target.value.toLowerCase();
                    this.renderIndicatorsCompare();
                });
                
                // 指标编辑模态框事件
                document.querySelector('#indicatorEditModal .save-icon').addEventListener('click', () => {
                    this.saveIndicatorRecord();
                });
                
                document.getElementById('deleteIndicatorBtn').addEventListener('click', () => {
                    this.deleteIndicatorRecord();
                });
                
                // 导出数据模态框事件
                document.getElementById('customerSearchInput').addEventListener('input', (e) => {
                    this.filterExportCustomers(e.target.value);
                });
                
                // 修改：导出选中客户数据事件
                document.getElementById('exportSelectedDataBtn').addEventListener('click', () => {
                    this.exportSelectedData();
                });
                
                // 新增：导出当前列表数据事件
                document.getElementById('exportCurrentListDataBtn').addEventListener('click', () => {
                    this.exportCurrentListData();
                });
                
                document.getElementById('exportAllDataInModalBtn').addEventListener('click', () => {
                    this.exportAllData();
                });
                
                // 新增：删除客户确认事件
                document.getElementById('confirmDeleteCustomerBtn').addEventListener('click', () => {
                    this.deleteCustomer();
                });
                
                document.getElementById('cancelDeleteCustomerBtn').addEventListener('click', () => {
                    this.closeModal(document.getElementById('deleteCustomerModal'));
                });
            },
            
            // 显示页面 - 修改：在切换到客户列表时强制重新加载数据
            showPage(pageName) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.getElementById(pageName).classList.add('active');
                document.querySelector(`.nav-tab[data-page="${pageName}"]`).classList.add('active');
                
                this.currentPage = pageName;
                
                if (pageName === 'customer-list') {
                    // 强制重新加载数据，确保显示最新客户列表
                    this.currentPageIndex = 0;
                    this.renderCustomerList();
                }
            },
            
            // 渲染客户列表 - 修改：修复过滤逻辑，确保新客户能正确显示
            async renderCustomerList() {
                const data = await CustomerModel.loadData();
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const customerServiceSearch = document.getElementById('customerServiceSearch').value.toLowerCase();
                const startPeriod = document.getElementById('startPeriod').value;
                const endPeriod = document.getElementById('endPeriod').value;
                
                // 过滤客户 - 修改：修复交付日期区间过滤逻辑
                let filteredCustomers = data.customers.filter(customer => {
                    const matchesSearch = customer.personalInfo.name.toLowerCase().includes(searchTerm);
                    
                    // 修复顾问过滤条件：当顾问搜索框为空时，不过滤任何客户
                    const matchesCustomerService = !customerServiceSearch || 
                        (customer.personalInfo.customerService && 
                         customer.personalInfo.customerService.toLowerCase().includes(customerServiceSearch));
                    
                    // 检查下次交付时间区间 - 修改：只有当两个日期都有值时才进行过滤
                    let matchesPeriod = true;
                    if (startPeriod && endPeriod) {
                        const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                        if (!nextDeliveryDate) {
                            // 如果没有下次交付时间，且设置了日期区间，则不显示
                            matchesPeriod = false;
                        } else {
                            matchesPeriod = nextDeliveryDate >= startPeriod && nextDeliveryDate <= endPeriod;
                        }
                    }
                    // 如果只有一个日期有值，或者两个都没有值，则显示所有客户
                    
                    return matchesSearch && matchesCustomerService && matchesPeriod;
                });
                
                // 分页
                const pageSize = data.settings.pageSize;
                const startIndex = this.currentPageIndex * pageSize;
                const endIndex = startIndex + pageSize;
                const paginatedCustomers = filteredCustomers.slice(startIndex, endIndex);
                
                // 渲染表格 - 修改：删除客户编号列，改为下次交付时间
                const tbody = document.querySelector('#customersTable tbody');
                tbody.innerHTML = '';
                
                paginatedCustomers.forEach(customer => {
                    // 更新服务进度为最新账期
                    const latestPeriod = CustomerModel.getLatestPeriod(customer);
                    const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                    
                    // 获取下次交付时间
                    const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                    
                    // 计算剩余期数
                    const remainingPeriods = CustomerModel.getRemainingPeriods(customer);
                    
                    const row = document.createElement('tr');
                    // 修改：删除客户编号列，改为下次交付时间
                    row.innerHTML = `
                        <td>${customer.personalInfo.name}</td>
                        <td>${customer.personalInfo.gender}</td>
                        <td>${customer.personalInfo.age}</td>
                        <td>${serviceProgress}</td>
                        <td>${customer.personalInfo.sales}</td>
                        <td>${customer.personalInfo.customerService}</td>
                        <td>${nextDeliveryDate}</td>
                        <td>${remainingPeriods}</td>
                    `;
                    
                    // 新增：添加单击选中事件
                    row.addEventListener('click', (e) => {
                        // 移除所有行的选中状态
                        document.querySelectorAll('#customersTable tbody tr').forEach(r => {
                            r.classList.remove('selected');
                        });
                        // 添加当前行的选中状态
                        row.classList.add('selected');
                        // 记录选中的客户ID
                        this.selectedCustomerId = customer.id;
                    });
                    
                    // 保持原有的双击事件
                    row.addEventListener('dblclick', () => {
                        this.showCustomerDetail(customer.id);
                    });
                    
                    tbody.appendChild(row);
                });
                
                // 渲染分页
                this.renderPagination(filteredCustomers.length, pageSize);
            },
            
            // 渲染分页
            renderPagination(totalCustomers, pageSize) {
                const totalPages = Math.ceil(totalCustomers / pageSize);
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';
                
                for (let i = 0; i < totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-btn ${i === this.currentPageIndex ? 'active' : ''}`;
                    pageBtn.textContent = i + 1;
                    pageBtn.addEventListener('click', () => {
                        this.currentPageIndex = i;
                        this.renderCustomerList();
                    });
                    pagination.appendChild(pageBtn);
                }
            },
            
            // 显示客户详情 - 修改：总是从数据库重新加载客户数据
            async showCustomerDetail(customerId) {
                // 总是从数据库重新加载客户数据，确保数据一致性
                const data = await CustomerModel.loadData();
                const customer = data.customers.find(c => c.id === customerId);
                
                if (!customer) return;
                
                this.currentCustomer = customer;
                // 删除客户详情标题
                
                // 渲染个人信息表单
                this.renderPersonalInfoForm(customer);
                
                // 渲染账期选择器
                this.renderPeriodSelector(customer);
                
                // 渲染财务图表
                this.renderFinanceChart(customer);
                
                // 渲染指标对比
                this.renderIndicatorsCompare();
                
                this.showPage('customer-detail');
                this.switchTab('personal-info');
            },
            
            // 新增：显示删除客户确认模态框
            async showDeleteCustomerModal() {
                if (!this.selectedCustomerId) {
                    alert('请先选择一个客户');
                    return;
                }
                
                const data = await CustomerModel.loadData();
                const customer = data.customers.find(c => c.id === this.selectedCustomerId);
                
                if (!customer) {
                    alert('未找到选中的客户');
                    return;
                }
                
                document.getElementById('deleteCustomerMessage').textContent = 
                    `是否确认删除客户编号${customer.id}${customer.personalInfo.name}的所有信息？`;
                
                document.getElementById('deleteCustomerModal').classList.add('active');
            },
            
            // 新增：删除客户
            async deleteCustomer() {
                if (!this.selectedCustomerId) return;
                
                const data = await CustomerModel.loadData();
                const customerIndex = data.customers.findIndex(c => c.id === this.selectedCustomerId);
                
                if (customerIndex === -1) {
                    alert('未找到选中的客户');
                    return;
                }
                
                // 从数组中删除客户
                data.customers.splice(customerIndex, 1);
                
                // 保存数据
                await CustomerModel.saveData(data);
                
                // 关闭模态框
                this.closeModal(document.getElementById('deleteCustomerModal'));
                
                // 重置选中状态
                this.selectedCustomerId = null;
                
                // 重新渲染客户列表
                this.renderCustomerList();
                
                // 显示保存通知
                this.showSaveNotification();
            },
            
            // 渲染个人信息表单
            renderPersonalInfoForm(customer) {
                const form = document.getElementById('personalInfoForm');
                const personalInfo = customer.personalInfo;
                
                // 更新服务进度为最新账期
                const latestPeriod = CustomerModel.getLatestPeriod(customer);
                const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                
                // 获取下次交付时间
                const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                
                form.innerHTML = `
                    <div class="form-group">
                        <label for="customerName">姓名</label>
                        <input type="text" id="customerName" value="${personalInfo.name || ''}">
                    </div>
                    <div class="form-group">
                        <label for="customerGender">性别</label>
                        <select id="customerGender">
                            <option value="男" ${personalInfo.gender === '男' ? 'selected' : ''}>男</option>
                            <option value="女" ${personalInfo.gender === '女' ? 'selected' : ''}>女</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDate">出生日期</label>
                        <input type="date" id="birthDate" value="${personalInfo.birthDate || ''}">
                    </div>
                    <div class="form-group">
                        <label for="age">年龄</label>
                        <input type="number" id="age" value="${personalInfo.age || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="residence">常居地</label>
                        <input type="text" id="residence" value="${personalInfo.residence || ''}">
                    </div>
                    <div class="form-group">
                        <label for="maritalStatus">婚姻状况</label>
                        <select id="maritalStatus">
                            <option value="未婚" ${personalInfo.maritalStatus === '未婚' ? 'selected' : ''}>未婚</option>
                            <option value="已婚" ${personalInfo.maritalStatus === '已婚' ? 'selected' : ''}>已婚</option>
                            <option value="离异" ${personalInfo.maritalStatus === '离异' ? 'selected' : ''}>离异</option>
                            <option value="丧偶" ${personalInfo.maritalStatus === '丧偶' ? 'selected' : ''}>丧偶</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="height">身高 (cm)</label>
                        <input type="number" id="height" value="${personalInfo.height || ''}">
                    </div>
                    <div class="form-group">
                        <label for="weight">体重 (kg)</label>
                        <input type="number" id="weight" value="${personalInfo.weight || ''}">
                    </div>
                    <div class="form-group">
                        <label for="bmi">BMI</label>
                        <input type="number" id="bmi" value="${personalInfo.bmi || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="serviceProgress">服务进度</label>
                        <input type="text" id="serviceProgress" value="${serviceProgress}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="sales">销售</label>
                        <input type="text" id="sales" value="${personalInfo.sales || ''}">
                    </div>
                    <div class="form-group">
                        <label for="customerService">顾问</label>
                        <input type="text" id="customerService" value="${personalInfo.customerService || ''}">
                    </div>
                    <div class="form-group">
                        <label for="nextDeliveryDate">下次交付时间</label>
                        <input type="date" id="nextDeliveryDate" value="${nextDeliveryDate}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="totalServicePeriods">服务总期数</label>
                        <input type="number" id="totalServicePeriods" value="${personalInfo.totalServicePeriods || ''}">
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>过敏史</label>
                            <span class="add-icon add-allergy-icon">+</span>
                        </div>
                        <div id="allergyHistoryContainer">
                            ${this.renderAllergyHistoryTable(customer.allergyHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>用药史</label>
                            <span class="add-icon add-medication-icon">+</span>
                        </div>
                        <div id="medicationHistoryContainer">
                            ${this.renderMedicationHistoryTable(customer.medicationHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>既往病史</label>
                            <span class="add-icon add-past-medical-icon">+</span>
                        </div>
                        <div id="pastMedicalHistoryContainer">
                            ${this.renderPastMedicalHistoryTable(customer.pastMedicalHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>手术与住院史</label>
                            <span class="add-icon add-surgery-icon">+</span>
                        </div>
                        <div id="surgeryHospitalizationHistoryContainer">
                            ${this.renderSurgeryHospitalizationHistoryTable(customer.surgeryHospitalizationHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>疫苗接种史</label>
                            <span class="add-icon add-vaccination-icon">+</span>
                        </div>
                        <div id="vaccinationHistoryContainer">
                            ${this.renderVaccinationHistoryTable(customer.vaccinationHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <div class="title-container">
                            <label>家族病史</label>
                            <span class="add-icon add-family-icon">+</span>
                        </div>
                        <div id="familyHistoryContainer">
                            ${this.renderFamilyHistoryTable(customer.familyHistory || [])}
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="customerPortrait">客户画像</label>
                        <textarea id="customerPortrait" rows="3">${personalInfo.customerPortrait || ''}</textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="notes">备注</label>
                        <textarea id="notes" rows="3">${personalInfo.notes || ''}</textarea>
                    </div>
                `;
                
                // 绑定自动计算事件
                document.getElementById('birthDate').addEventListener('change', () => {
                    const age = CustomerModel.calculateAge(document.getElementById('birthDate').value);
                    document.getElementById('age').value = age;
                });
                
                document.getElementById('height').addEventListener('input', this.calculateAndDisplayBMI.bind(this));
                document.getElementById('weight').addEventListener('input', this.calculateAndDisplayBMI.bind(this));
                
                // 绑定自动保存事件
                this.bindAutoSaveEvents();
            },
            
            // 计算并显示BMI
            calculateAndDisplayBMI() {
                const height = document.getElementById('height').value;
                const weight = document.getElementById('weight').value;
                const bmi = CustomerModel.calculateBMI(height, weight);
                document.getElementById('bmi').value = bmi;
            },
            
            // 绑定自动保存事件
            bindAutoSaveEvents() {
                // 为所有输入元素绑定自动保存
                const inputs = document.querySelectorAll('#personalInfoForm input, #personalInfoForm select, #personalInfoForm textarea');
                inputs.forEach(input => {
                    // 输入框失焦时保存
                    input.addEventListener('blur', () => {
                        this.autoSavePersonalInfo();
                    });
                    
                    // 文本区域使用防抖保存
                    if (input.tagName === 'TEXTAREA') {
                        input.addEventListener('input', () => {
                            clearTimeout(this.autoSaveTimeout);
                            this.autoSaveTimeout = setTimeout(() => {
                                this.autoSavePersonalInfo();
                            }, 2000);
                        });
                    }
                });
            },
            
            // 自动保存个人信息
            async autoSavePersonalInfo() {
                await this.savePersonalInfo(false);
            },
            
            // 渲染账期选择器
            renderPeriodSelector(customer) {
                const periodSelect = document.getElementById('periodSelect');
                periodSelect.innerHTML = '';
                
                if (customer.periods && customer.periods.length > 0) {
                    // 按账期名称排序，最新的在前面（编号-年月日格式）
                    const sortedPeriods = [...customer.periods].sort((a, b) => {
                        // 直接按字符串排序，因为格式是固定的编号-日期
                        return b.periodName.localeCompare(a.periodName);
                    });
                    
                    sortedPeriods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period.periodId;
                        option.textContent = period.periodName;
                        periodSelect.appendChild(option);
                    });
                    
                    this.currentPeriod = sortedPeriods[0];
                    periodSelect.value = this.currentPeriod.periodId;
                    this.renderPeriodForm(this.currentPeriod);
                } else {
                    this.currentPeriod = null;
                    document.getElementById('periodFormContainer').innerHTML = '<p>暂无账期信息</p>';
                }
            },
            
            // 渲染账期表单
            renderPeriodForm(period) {
                // 数据完整性检查
                if (!this.validatePeriodData(period)) {
                    document.getElementById('periodFormContainer').innerHTML = '<p>账期数据异常，请重新选择</p>';
                    return;
                }
                
                const container = document.getElementById('periodFormContainer');
                
                container.innerHTML = `
                    <form id="periodForm">
                        <div class="form-group full-width">
                            <div class="title-container">
                                <label>膳食习惯</label>
                                <span class="add-icon add-dietary-icon">+</span>
                            </div>
                            <div id="dietaryHabitsContainer">
                                ${this.renderDietaryHabitsTable(period.dietaryHabits || [])}
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <div class="title-container">
                                <label>身体活动</label>
                                <span class="add-icon add-physical-icon">+</span>
                            </div>
                            <div id="physicalActivityContainer">
                                ${this.renderPhysicalActivityTable(period.physicalActivity || [])}
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <div class="title-container">
                                <label>睡眠模式</label>
                                <span class="add-icon add-sleep-icon">+</span>
                            </div>
                            <div id="sleepPatternContainer">
                                ${this.renderSleepPatternTable(period.sleepPattern || [])}
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="stressMentalHealth">压力与心理健康</label>
                            <textarea id="stressMentalHealth" rows="3">${period.stressMentalHealth || ''}</textarea>
                        </div>

                        <div class="form-group full-width">
                            <label for="environmentOccupational">环境与职业因素</label>
                            <textarea id="environmentOccupational" rows="3">${period.environmentOccupational || ''}</textarea>
                        </div>

                        <div class="form-group full-width">
                            <label for="subjectiveHealth">主观健康感受</label>
                            <textarea id="subjectiveHealth" rows="3">${period.subjectiveHealth || ''}</textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="abnormalIndicators">异常检测指标</label>
                            <div id="abnormalIndicatorsContainer">
                                ${this.renderAbnormalIndicators(period.abnormalIndicators || [])}
                            </div>
                            <button type="button" id="addIndicatorBtn" class="btn add-record-btn" style="margin-top: 10px;">添加指标</button>
                            <button type="button" id="importIndicatorsBtn" class="btn btn-primary" style="margin-top: 10px;">导入指标</button>
                        </div>
                        
                        <div class="form-group full-width">
                            <div class="title-container">
                                <label for="communicationRecords">企微沟通记录</label>
                                <span class="add-icon add-communication-icon">+</span>
                            </div>
                            <div id="communicationRecordsContainer">
                                ${this.renderCommunicationRecords(period.communicationRecords || [])}
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <div class="title-container">
                                <label for="followUpRecords">回访记录</label>
                                <span class="add-icon add-followup-icon">+</span>
                            </div>
                            <div id="followUpRecordsContainer">
                                ${this.renderFollowUpRecords(period.followUpRecords || [])}
                            </div>
                        </div>

                        <div class="form-group full-width" style="margin-top: 20px; border-top: 1px dashed #eee; padding-top: 15px;">
                            <div class="title-container" style="display: flex; align-items: center; justify-content: space-between;">
                                <label>附件 📎</label>
                                <div style="position: relative;">
                                    <input type="file" id="cloudFile" style="display: none;">
                                    <span id="uploadBtn" class="add-icon" title="添加附件" style="font-size: 20px;">+</span>
                                    <span id="uploadStatus" style="font-size: 12px; color: #666; margin-right: 10px;"></span>
                                </div>
                            </div>
                            
                            <div id="attachmentDropZone" style="border: 2px dashed #ddd; border-radius: 4px; padding: 20px; text-align: center; color: #999; display: none; margin-bottom: 10px;">
                                拖拽文件到这里上传
                            </div>

                            <div id="attachmentListContainer">
                                </div>
                        </div>
                    </form>
                `;
                
                // 绑定添加指标事件
                document.getElementById('addIndicatorBtn').addEventListener('click', () => {
                    this.addAbnormalIndicator();
                });
                
                // 绑定导入指标事件
                document.getElementById('importIndicatorsBtn').addEventListener('click', () => {
                    this.showImportIndicatorsModal();
                });
                
                // 绑定自动保存事件
                this.bindPeriodAutoSaveEvents();

                // === 新增：绑定附件功能 ===
            // 1. 渲染现有列表
            this.renderAttachments(period);

            // 2. 绑定加号图标点击
            const fileInput = document.getElementById('cloudFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const dropZone = document.getElementById('attachmentDropZone');
            
            if(uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', () => fileInput.click());
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        // 限制 20MB
                        if (e.target.files[0].size > 20 * 1024 * 1024) {
                            alert('文件太大，请小于 20MB');
                            return;
                        }
                        this.uploadToCloudinary(e.target.files[0]);
                    }
                });
            }

            // 3. 绑定拖拽事件
            const attachArea = uploadBtn.parentElement.parentElement; 
            
            // 拖入时显示虚线框
            attachArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.display = 'block';
                dropZone.style.borderColor = '#787785';
                dropZone.style.backgroundColor = '#f8f9fa';
            });

            // 拖出或放下后
            attachArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                const rect = attachArea.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX >= rect.right || e.clientY < rect.top || e.clientY >= rect.bottom) {
                    dropZone.style.display = 'none';
                }
            });

            attachArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.display = 'none'; 
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.size > 20 * 1024 * 1024) {
                        alert('文件太大，请小于 20MB');
                        return;
                    }
                    this.uploadToCloudinary(file);
                }
            });
            },
            
            // 渲染异常检测指标
            renderAbnormalIndicators(indicators) {
                if (indicators.length === 0) {
                    return '';
                }
                
                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>指标名称</th><th>数值</th><th>单位</th><th>参考范围</th><th>测量时间</th><th>检测机构</th><th>操作</th></tr></thead><tbody>';
                
                indicators.forEach((indicator, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${indicator.name || ''}" data-index="${index}" data-field="name"></td>
                            <td><input type="text" value="${indicator.value || ''}" data-index="${index}" data-field="value"></td>
                            <td><input type="text" value="${indicator.unit || ''}" data-index="${index}" data-field="unit"></td>
                            <td><input type="text" value="${indicator.reference || ''}" data-index="${index}" data-field="reference"></td>
                            <td><input type="date" value="${indicator.measurementDate || ''}" data-index="${index}" data-field="measurementDate"></td>
                            <td><input type="text" value="${indicator.testingInstitution || ''}" data-index="${index}" data-field="testingInstitution"></td>
                            <td><button type="button" class="btn btn-secondary remove-indicator" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定删除事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-indicator').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeAbnormalIndicator(index);
                        });
                    });
                    
                    // 绑定输入变化事件
                    document.querySelectorAll('#abnormalIndicatorsContainer input').forEach(input => {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateAbnormalIndicator(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // === 新增：渲染附件列表 ===
            renderAttachments(period) {
                const container = document.getElementById('attachmentListContainer');
                if (!container) return;
                container.innerHTML = '';
                
                // 确保数据结构里有 attachments 数组
                const attachments = period.attachments || [];
                
                if (attachments.length === 0) {
                    // 没文件时隐藏列表容器，保持界面干净
                    container.style.display = 'none';
                    return;
                }
                
                container.style.display = 'block';
                
                attachments.forEach((file, index) => {
                    // 根据文件后缀判断图标
                    let icon = '📄';
                    if (file.name.endsWith('.pdf')) icon = '📕';
                    if (file.name.match(/\.(doc|docx)$/)) icon = '📘';
                    if (file.name.match(/\.(jpg|jpeg|png)$/)) icon = '🖼️';

                    const div = document.createElement('div');
                    // 样式：极简行内样式，鼠标悬停变色
                    div.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px;";
                    
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; overflow: hidden;">
                            <span style="margin-right: 8px; font-size: 16px;">${icon}</span>
                            <a href="${file.url}" target="_blank" style="text-decoration: none; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;" title="${file.name}">${file.name}</a>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <span class="delete-attachment-icon" data-index="${index}" style="cursor: pointer; color: #dc3545; font-weight: bold; font-size: 16px;" title="删除">×</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                // 绑定删除事件
                container.querySelectorAll('.delete-attachment-icon').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if(confirm('确定删除这个附件吗？')) {
                            const idx = e.target.getAttribute('data-index');
                            this.currentPeriod.attachments.splice(idx, 1);
                            this.renderAttachments(this.currentPeriod);
                            this.autoSavePeriodInfo(); // 自动保存
                        }
                    });
                });
            },

            // === 新增：执行 Cloudinary 上传 ===
            async uploadToCloudinary(file) {
                const status = document.getElementById('uploadStatus');
                status.textContent = '⏳ 正在上传...';
                
                // ============ 配置区 (请填入你的 Cloudinary 信息) ============
                const CLOUD_NAME = 'dtqjeak7u';
                const UPLOAD_PRESET = 'customer_files';
                // ===========================================================

                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);
                formData.append('resource_type', 'auto'); // 自动识别 PDF/Word/图片

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('上传云端失败');

                    const data = await response.json();
                    
                    // 初始化附件数组
                    if (!this.currentPeriod.attachments) {
                        this.currentPeriod.attachments = [];
                    }
                    
                    // 存入数据
                    this.currentPeriod.attachments.push({
                        name: file.name,
                        url: data.secure_url, // 永久链接
                        uploadDate: new Date().toISOString()
                    });

                    status.textContent = '✅';
                    setTimeout(() => status.textContent = '', 2000);
                    
                    // 刷新列表并保存
                    this.renderAttachments(this.currentPeriod);
                    this.autoSavePeriodInfo();

                } catch (error) {
                    console.error(error);
                    status.textContent = '❌ 失败';
                    status.title = error.message;
                    status.style.color = 'red';
                }
            },
            
            // 渲染企微沟通记录
            renderCommunicationRecords(records) {
                if (records.length === 0) {
                    return '';
                }
                
                let html = '<table class="followup-table"><thead><tr><th>日期</th><th>关键词</th><th>客诉内容</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="date" value="${record.date || ''}" data-index="${index}" data-field="date"></td>
                            <td><input type="text" value="${record.keyword || ''}" data-index="${index}" data-field="keyword"></td>
                            <td><textarea data-index="${index}" data-field="content" rows="2">${record.content || ''}</textarea></td>
                            <td><button type="button" class="btn btn-secondary remove-communication" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定删除事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-communication').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeCommunicationRecord(index);
                        });
                    });
                    
                    // 绑定输入变化事件
                    document.querySelectorAll('#communicationRecordsContainer input, #communicationRecordsContainer textarea').forEach(input => {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateCommunicationRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },
            
            // 渲染回访记录
            renderFollowUpRecords(records) {
                if (records.length === 0) {
                    return '';
                }
                
                let html = '<table class="followup-table"><thead><tr><th>日期</th><th>项目名称</th><th>回访内容</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="date" value="${record.date || ''}" data-index="${index}" data-field="date"></td>
                            <td><input type="text" value="${record.project || ''}" data-index="${index}" data-field="project"></td>
                            <td><textarea data-index="${index}" data-field="reason" rows="2">${record.reason || ''}</textarea></td>
                            <td><button type="button" class="btn btn-secondary remove-followup" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定删除事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-followup').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeFollowUpRecord(index);
                        });
                    });
                    
                    // 绑定输入变化事件
                    document.querySelectorAll('#followUpRecordsContainer input, #followUpRecordsContainer textarea').forEach(input => {
                        input.addEventListener('input', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateFollowUpRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },
            
            // 添加异常检测指标
            addAbnormalIndicator() {
                if (!this.currentPeriod.abnormalIndicators) {
                    this.currentPeriod.abnormalIndicators = [];
                }
                
                this.currentPeriod.abnormalIndicators.push({
                    name: '',
                    value: '',
                    unit: '',
                    reference: '',
                    measurementDate: new Date().toISOString().split('T')[0],
                    testingInstitution: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // 删除异常检测指标
            removeAbnormalIndicator(index) {
                this.currentPeriod.abnormalIndicators.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // 更新异常检测指标
            updateAbnormalIndicator(index, field, value) {
                if (!this.currentPeriod.abnormalIndicators) {
                    this.currentPeriod.abnormalIndicators = [];
                }
                this.currentPeriod.abnormalIndicators[index][field] = value;
                this.autoSavePeriodInfo();
            },
            
            // 添加沟通记录
            addCommunicationRecord() {
                if (!this.currentPeriod.communicationRecords) {
                    this.currentPeriod.communicationRecords = [];
                }
                
                this.currentPeriod.communicationRecords.push({
                    date: new Date().toISOString().split('T')[0],
                    keyword: '',
                    content: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // 删除沟通记录
            removeCommunicationRecord(index) {
                this.currentPeriod.communicationRecords.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // 更新沟通记录
            updateCommunicationRecord(index, field, value) {
                if (!this.currentPeriod.communicationRecords) {
                    this.currentPeriod.communicationRecords = [];
                }
                this.currentPeriod.communicationRecords[index][field] = value;
                this.autoSavePeriodInfo();
            },
            
            // 添加回访记录
            addFollowUpRecord() {
                if (!this.currentPeriod.followUpRecords) {
                    this.currentPeriod.followUpRecords = [];
                }
                
                this.currentPeriod.followUpRecords.push({
                    date: new Date().toISOString().split('T')[0],
                    project: '',
                    reason: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // 删除回访记录
            removeFollowUpRecord(index) {
                this.currentPeriod.followUpRecords.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },
            
            // 更新回访记录
            updateFollowUpRecord(index, field, value) {
                if (!this.currentPeriod.followUpRecords) {
                    this.currentPeriod.followUpRecords = [];
                }
                this.currentPeriod.followUpRecords[index][field] = value;
                this.autoSavePeriodInfo();
            },
            
            // 绑定账期自动保存事件
            bindPeriodAutoSaveEvents() {
                // 为所有输入元素绑定自动保存
                const inputs = document.querySelectorAll('#periodForm input, #periodForm select, #periodForm textarea');
                inputs.forEach(input => {
                    // 输入框失焦时保存
                    input.addEventListener('blur', () => {
                        this.autoSavePeriodInfo();
                    });
                    
                    // 文本区域使用防抖保存
                    if (input.tagName === 'TEXTAREA') {
                        input.addEventListener('input', () => {
                            clearTimeout(this.autoSaveTimeout);
                            this.autoSaveTimeout = setTimeout(() => {
                                this.autoSavePeriodInfo();
                            }, 2000);
                        });
                    }
                });
            },
            
            // 自动保存账期信息
            async autoSavePeriodInfo() {
                await this.savePeriodInfo(false);
            },
            
            // 渲染财务图表 - 修改：添加订单总额背景点击功能
            renderFinanceChart(customer) {
                const chartElement = document.getElementById('financeChart');
                chartElement.innerHTML = '';
                
                // 计算订单记录总额
                let orderTotal = 0;
                if (customer.periods) {
                    customer.periods.forEach(period => {
                        if (period.financialStats) {
                            period.financialStats.forEach(record => {
                                if (record.mainCategory === '订单记录') {
                                    orderTotal += record.amount;
                                }
                            });
                        }
                    });
                }
                
                // 计算成本记录分类
                const costCategories = {};
                if (customer.periods) {
                    customer.periods.forEach(period => {
                        if (period.financialStats) {
                            period.financialStats.forEach(record => {
                                if (record.mainCategory === '成本记录') {
                                    if (!costCategories[record.subCategory]) {
                                        costCategories[record.subCategory] = 0;
                                    }
                                    costCategories[record.subCategory] += record.amount;
                                }
                            });
                        }
                    });
                }
                
                if (orderTotal === 0) {
                    chartElement.innerHTML = '<div style="padding: 10px; text-align: center;">暂无财务数据</div>';
                    // 清空统计表格
                    this.renderFinanceSummaryTable({}, 0);
                    return;
                }
                
                // 生成图表HTML
                let chartHTML = '';
                
                // 先添加订单记录部分（灰色背景）- 修改：添加类名和点击事件
                chartHTML += `<div class="chart-segment order-total-background" style="width: 100%; background-color: #EFE8E0; cursor: pointer;" data-category="订单记录"></div>`;
                
                // 然后添加成本记录部分（覆盖在订单记录上）
                let left = 0;
                Object.keys(costCategories).forEach(category => {
                    const width = (costCategories[category] / orderTotal) * 100;
                    const color = this.getCategoryColor(category);
                    
                    chartHTML += `
                        <div class="chart-segment" 
                             style="width: ${width}%; background-color: ${color}; position: absolute; left: ${left}%" 
                             data-category="${category}" 
                             data-amount="${costCategories[category]}">
                        </div>
                    `;
                    
                    left += width;
                });
                
                chartElement.innerHTML = chartHTML;
                
                // 添加总额显示
                const totalElement = document.createElement('div');
                totalElement.style.position = 'absolute';
                totalElement.style.top = '50%';
                totalElement.style.left = '50%';
                totalElement.style.transform = 'translate(-50%, -50%)';
                totalElement.style.color = '#333';
                totalElement.style.fontWeight = 'bold';
                totalElement.textContent = `订单总额: ${orderTotal}`;
                
                chartElement.style.position = 'relative';
                chartElement.appendChild(totalElement);
                
                // 渲染财务统计表格
                this.renderFinanceSummaryTable(costCategories, orderTotal);
            },
            
            // 渲染财务统计表格 - 修改：为所有分类行添加点击事件
            renderFinanceSummaryTable(categories, orderTotal) {
                const tableBody = document.querySelector('#financeSummaryTable tbody');
                tableBody.innerHTML = '';
                
                // 添加订单记录行 - 修改：添加点击事件
                const orderRow = document.createElement('tr');
                orderRow.innerHTML = `
                    <td>订单记录</td>
                    <td>${orderTotal}</td>
                `;
                orderRow.style.cursor = 'pointer';
                orderRow.addEventListener('click', () => {
                    this.showFinanceModal('订单记录');
                });
                tableBody.appendChild(orderRow);
                
                // 添加成本记录行 - 修改：为所有成本分类行添加点击事件
                Object.keys(categories).forEach(category => {
                    const row = document.createElement('tr');
                    const percentage = orderTotal > 0 ? ((categories[category] / orderTotal) * 100).toFixed(2) : 0;
                    row.innerHTML = `
                        <td>${category}</td>
                        <td>${categories[category]} (${percentage}%)</td>
                    `;
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', () => {
                        this.showFinanceModal(category);
                    });
                    tableBody.appendChild(row);
                });
            },
            
            // 获取类别颜色（使用新的配色方案）
            getCategoryColor(category) {
                const colors = {
                    '提成类': '#203F9A',
                    '方案费用类': '#94C2DA',
                    '工本费': '#E84797',
                    '其他费用': '#E7A0CC'
                };
                
                return colors[category] || '#4E7CB2';
            },
            
            // 渲染指标对比
            renderIndicatorsCompare() {
                if (!this.currentCustomer) return;
                
                // 获取所有指标名称
                let indicatorNames = CustomerModel.getAllIndicatorNames(this.currentCustomer);
                
                // 根据搜索条件过滤指标名称
                if (this.indicatorSearchTerm) {
                    indicatorNames = indicatorNames.filter(name => 
                        name.toLowerCase().includes(this.indicatorSearchTerm)
                    );
                }
                
                if (indicatorNames.length === 0) {
                    document.getElementById('indicatorsTableContainer').innerHTML = '<p>暂无指标数据</p>';
                    return;
                }
                
                // 收集指标数据
                const indicatorData = {};
                const datePeriodMap = {}; // 存储日期到账期编号的映射
                const indicatorRecords = {}; // 存储指标记录详情
                const referenceRanges = {}; // 存储指标的参考范围
                
                indicatorNames.forEach(indicator => {
                    indicatorData[indicator] = [];
                });
                
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.abnormalIndicators) {
                            period.abnormalIndicators.forEach(indicator => {
                                if (indicatorNames.includes(indicator.name)) {
                                    indicatorData[indicator.name].push({
                                        period: period.periodName,
                                        value: indicator.value,
                                        measurementDate: indicator.measurementDate
                                    });
                                    
                                    // 提取账期编号（从"01-20251011"中提取"01"）
                                    const periodNumber = period.periodName.split('-')[0];
                                    datePeriodMap[indicator.measurementDate] = periodNumber;
                                    
                                    // 存储指标记录详情
                                    const key = `${indicator.name}_${indicator.measurementDate}`;
                                    indicatorRecords[key] = {
                                        ...indicator,
                                        periodId: period.periodId,
                                        periodName: period.periodName
                                    };
                                    
                                    // 存储第一个出现的参考范围
                                    if (indicator.reference && !referenceRanges[indicator.name]) {
                                        referenceRanges[indicator.name] = indicator.reference;
                                    }
                                }
                            });
                        }
                    });
                }
                
                // 渲染表格
                this.renderIndicatorsTable(indicatorData, datePeriodMap, indicatorRecords, referenceRanges);
            },
            
            // 渲染指标表格 - 修改：在日期后面加上账期编号，并添加点击事件
            renderIndicatorsTable(indicatorData, datePeriodMap, indicatorRecords, referenceRanges) {
                const container = document.getElementById('indicatorsTableContainer');
                
                // 收集所有测量日期
                const allDates = [];
                Object.keys(indicatorData).forEach(indicator => {
                    indicatorData[indicator].forEach(item => {
                        if (!allDates.includes(item.measurementDate)) {
                            allDates.push(item.measurementDate);
                        }
                    });
                });
                
                allDates.sort();
                
                // 收集所有指标名称并排序
                const indicators = Object.keys(indicatorData).sort();
                
                let html = '<table class="indicators-table"><thead><tr><th>指标名称</th><th>参考范围</th>';
                
                allDates.forEach(date => {
                    // 在日期后面加上账期编号
                    const periodNumber = datePeriodMap[date] || '';
                    const headerText = periodNumber ? `${date} (${periodNumber})` : date;
                    html += `<th>${headerText}</th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                indicators.forEach(indicator => {
                    html += `<tr><td>${indicator}</td><td>${referenceRanges[indicator] || '-'}</td>`;
                    
                    allDates.forEach(date => {
                        const item = indicatorData[indicator].find(d => d.measurementDate === date);
                        const value = item ? item.value : '-';
                        const key = `${indicator}_${date}`;
                        const hasRecord = indicatorRecords[key] !== undefined;
                        
                        // 检查数值是否在正常范围内
                        let isNormal = false;
                        if (item && referenceRanges[indicator]) {
                            isNormal = this.isValueInNormalRange(item.value, referenceRanges[indicator]);
                        }
                        
                        // 添加可点击样式和正常值样式
                        const cellClass = hasRecord ? 'clickable-cell' : '';
                        const valueClass = isNormal ? 'normal-value' : '';
                        html += `<td class="${cellClass} ${valueClass}" data-indicator="${indicator}" data-date="${date}">${value}</td>`;
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                
                container.innerHTML = html;
                
                // 绑定单元格点击事件
                document.querySelectorAll('.clickable-cell').forEach(cell => {
                    cell.addEventListener('click', (e) => {
                        const indicator = e.target.getAttribute('data-indicator');
                        const date = e.target.getAttribute('data-date');
                        const key = `${indicator}_${date}`;
                        
                        if (indicatorRecords[key]) {
                            this.showIndicatorEditModal(indicatorRecords[key]);
                        }
                    });
                });
            },
            
            // 检查数值是否在正常范围内 - 支持三种连接符
            isValueInNormalRange(value, referenceRange) {
                if (!value || !referenceRange) return false;
                
                try {
                    // 解析数值
                    const numValue = parseFloat(value);
                    if (isNaN(numValue)) return false;
                    
                    // 解析参考范围，支持三种连接符：" - "、"～"、"~"
                    let rangeParts = [];
                    if (referenceRange.includes(' - ')) {
                        rangeParts = referenceRange.split(' - ');
                    } else if (referenceRange.includes('～')) {
                        rangeParts = referenceRange.split('～');
                    } else if (referenceRange.includes('~')) {
                        rangeParts = referenceRange.split('~');
                    } else {
                        return false;
                    }
                    
                    if (rangeParts.length !== 2) return false;
                    
                    const min = parseFloat(rangeParts[0]);
                    const max = parseFloat(rangeParts[1]);
                    
                    if (isNaN(min) || isNaN(max)) return false;
                    
                    return numValue >= min && numValue <= max;
                } catch (error) {
                    console.error('检查数值范围时出错:', error);
                    return false;
                }
            },
            
            // 显示指标编辑模态框 - 修复：保存原始数据用于查找
            showIndicatorEditModal(indicator) {
                // 保存原始数据，用于在保存时定位原始记录
                this.editingIndicator = {
                    ...indicator,
                    originalName: indicator.name, // 保存原始名称
                    originalMeasurementDate: indicator.measurementDate // 保存原始测量日期
                };
                
                document.getElementById('editIndicatorName').value = indicator.name || '';
                document.getElementById('editIndicatorValue').value = indicator.value || '';
                document.getElementById('editIndicatorUnit').value = indicator.unit || '';
                document.getElementById('editIndicatorReference').value = indicator.reference || '';
                document.getElementById('editIndicatorDate').value = indicator.measurementDate || '';
                document.getElementById('editIndicatorInstitution').value = indicator.testingInstitution || '';
                
                document.getElementById('indicatorEditModal').classList.add('active');
            },
            
            // 保存指标记录 - 修复：通过原始名称和测量日期找到原始记录并更新
            async saveIndicatorRecord() {
                if (!this.editingIndicator) return;
                
                const name = document.getElementById('editIndicatorName').value;
                const value = document.getElementById('editIndicatorValue').value;
                const unit = document.getElementById('editIndicatorUnit').value;
                const reference = document.getElementById('editIndicatorReference').value;
                const measurementDate = document.getElementById('editIndicatorDate').value;
                const testingInstitution = document.getElementById('editIndicatorInstitution').value;
                
                // 找到对应的账期
                const period = this.currentCustomer.periods.find(p => p.periodId === this.editingIndicator.periodId);
                if (period && period.abnormalIndicators) {
                    // 使用原始名称和原始测量日期来查找记录
                    const index = period.abnormalIndicators.findIndex(i => 
                        i.name === this.editingIndicator.originalName && 
                        i.measurementDate === this.editingIndicator.originalMeasurementDate
                    );
                    
                    if (index !== -1) {
                        // 更新记录
                        period.abnormalIndicators[index] = {
                            ...period.abnormalIndicators[index],
                            name: name,
                            value: value,
                            unit: unit,
                            reference: reference,
                            measurementDate: measurementDate,
                            testingInstitution: testingInstitution
                        };
                        
                        // 保存数据
                        await this.saveCustomerData();
                        
                        // 刷新指标对比表格
                        this.renderIndicatorsCompare();
                        
                        this.closeModal(document.getElementById('indicatorEditModal'));
                        this.showSaveNotification();
                    }
                }
            },
            
            // 删除指标记录
            async deleteIndicatorRecord() {
                if (!this.editingIndicator) return;
                
                // 找到对应的账期和指标记录
                const period = this.currentCustomer.periods.find(p => p.periodId === this.editingIndicator.periodId);
                if (period && period.abnormalIndicators) {
                    const index = period.abnormalIndicators.findIndex(i => 
                        i.name === this.editingIndicator.name && 
                        i.measurementDate === this.editingIndicator.measurementDate
                    );
                    
                    if (index !== -1) {
                        period.abnormalIndicators.splice(index, 1);
                        
                        // 保存数据
                        await this.saveCustomerData();
                        
                        // 刷新指标对比表格
                        this.renderIndicatorsCompare();
                        
                        this.closeModal(document.getElementById('indicatorEditModal'));
                        this.showSaveNotification();
                    }
                }
            },
            
            // 切换标签页 - 修改：添加延迟渲染以避免抖动
            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                // 使用setTimeout延迟渲染，避免抖动
                if (tabName === 'finance-info') {
                    setTimeout(() => {
                        this.renderFinanceChart(this.currentCustomer);
                    }, 10);
                } else if (tabName === 'indicators-compare') {
                    setTimeout(() => {
                        this.renderIndicatorsCompare();
                    }, 10);
                }
            },
            
            // 刷新账期
            async refreshPeriod() {
                const periodSelect = document.getElementById('periodSelect');
                const periodId = periodSelect.value;
                
                if (!this.currentCustomer || !periodId) {
                    console.error('无法刷新：当前客户或账期ID为空');
                    return;
                }
                
                // 先保存当前账期的数据
                await this.savePeriodInfo(false);
                
                // 从数据中重新加载账期信息，确保数据一致性
                const data = await CustomerModel.loadData();
                const customer = data.customers.find(c => c.id === this.currentCustomer.id);
                
                if (!customer) {
                    console.error('客户不存在');
                    return;
                }
                
                this.currentCustomer = customer;
                this.currentPeriod = customer.periods.find(p => p.periodId === periodId);
                
                if (!this.currentPeriod) {
                    console.error('账期不存在');
                    return;
                }
                
                this.renderPeriodForm(this.currentPeriod);
                console.log('已切换到账期:', this.currentPeriod.periodName);
            },
            
            // 显示添加账期模态框
            showAddPeriodModal() {
                document.getElementById('addPeriodModal').classList.add('active');
            },
            
            // 显示修改账期模态框
            showEditPeriodModal() {
                if (!this.currentPeriod) {
                    alert('请先选择一个账期');
                    return;
                }
                
                // 解析当前账期名称，获取编号和日期
                const periodName = this.currentPeriod.periodName;
                const match = periodName.match(/^(\d{2})-(\d{4})(\d{2})(\d{2})$/);
                
                if (!match) {
                    alert('账期格式不正确');
                    return;
                }
                
                const periodNumber = match[1];
                const year = match[2];
                const month = match[3];
                const day = match[4];
                const dateStr = `${year}-${month}-${day}`;
                
                document.getElementById('editPeriodNumber').value = periodNumber;
                document.getElementById('editPeriodDate').value = dateStr;
                
                document.getElementById('editPeriodModal').classList.add('active');
            },
            
            // 添加账期
            async addPeriod() {
                const periodDate = document.getElementById('newPeriodDate').value;
                
                if (!periodDate) {
                    alert('请选择账期日期');
                    return;
                }
                
                try {
                    // 先保存当前账期的数据（如果有）
                    if (this.currentPeriod) {
                        await this.savePeriodInfo(false);
                    }
                    
                    const periodName = CustomerModel.generatePeriodName(periodDate, this.currentCustomer);
                    
                    if (!this.currentCustomer.periods) {
                        this.currentCustomer.periods = [];
                    }
                    
                    // 检查是否已存在相同账期
                    const existingPeriod = this.currentCustomer.periods.find(p => p.periodName === periodName);
                    if (existingPeriod) {
                        alert('该账期已存在');
                        return;
                    }
                    
                    const newPeriod = {
                        periodId: `P${Date.now()}`,
                        periodName: periodName,
                        periodDate: periodDate,
                        abnormalIndicators: [],
                        communicationRecords: [],
                        dietaryHabits: [],
                        physicalActivity: [],
                        sleepPattern: [],
                        stressMentalHealth: '',
                        environmentOccupational: '',
                        subjectiveHealth: '',
                        followUpRecords: [],
                        financialStats: []
                    };
                    
                    this.currentCustomer.periods.push(newPeriod);
                    
                    // 立即保存客户数据
                    await this.saveCustomerData();
                    
                    // 更新下次交付时间（考虑剩余期数是否为0）
                    this.updateNextDeliveryDate();
                    
                    this.closeModal(document.getElementById('addPeriodModal'));
                    this.renderPeriodSelector(this.currentCustomer);
                    
                    // 自动选择新添加的账期
                    const periodSelect = document.getElementById('periodSelect');
                    periodSelect.value = newPeriod.periodId;
                    this.currentPeriod = newPeriod;
                    this.renderPeriodForm(this.currentPeriod);
                    
                    // 更新服务进度
                    this.updateServiceProgress();
                    
                    console.log('新账期已创建:', periodName);
                } catch (error) {
                    console.error('创建账期时出错:', error);
                    alert('创建账期失败');
                }
            },
            
            // 修改账期
            async editPeriod() {
                const periodDate = document.getElementById('editPeriodDate').value;
                const periodNumber = document.getElementById('editPeriodNumber').value;
                
                if (!periodDate) {
                    alert('请选择账期日期');
                    return;
                }
                
                try {
                    // 生成新的账期名称（保持编号不变，只修改日期部分）
                    const dateObj = new Date(periodDate);
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    const newPeriodName = `${periodNumber}-${dateStr}`;
                    
                    // 检查是否已存在相同账期
                    const existingPeriod = this.currentCustomer.periods.find(p => p.periodName === newPeriodName && p.periodId !== this.currentPeriod.periodId);
                    if (existingPeriod) {
                        alert('该账期已存在');
                        return;
                    }
                    
                    // 更新当前账期的名称和日期
                    this.currentPeriod.periodName = newPeriodName;
                    this.currentPeriod.periodDate = periodDate;
                    
                    // 保存数据
                    await this.saveCustomerData();
                    
                    // 刷新界面
                    this.renderPeriodSelector(this.currentCustomer);
                    this.renderPeriodForm(this.currentPeriod);
                    
                    this.closeModal(document.getElementById('editPeriodModal'));
                    this.showSaveNotification();
                    
                    console.log('账期已修改为:', newPeriodName);
                } catch (error) {
                    console.error('修改账期时出错:', error);
                    alert('修改账期失败');
                }
            },
            
            // 更新服务进度
            updateServiceProgress() {
                const latestPeriod = CustomerModel.getLatestPeriod(this.currentCustomer);
                const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                document.getElementById('serviceProgress').value = serviceProgress;
                
                // 更新客户数据中的服务进度
                this.currentCustomer.personalInfo.serviceProgress = serviceProgress;
                this.saveCustomerData();
            },
            
            // 更新下次交付时间
            updateNextDeliveryDate() {
                const nextDeliveryDate = CustomerModel.getNextDeliveryDate(this.currentCustomer);
                document.getElementById('nextDeliveryDate').value = nextDeliveryDate;
                
                // 更新客户数据中的下次交付时间
                this.currentCustomer.personalInfo.nextDeliveryDate = nextDeliveryDate;
                this.saveCustomerData();
            },
            
            // 显示财务记录模态框
            showFinanceRecordModal(record = null) {
                const modal = document.getElementById('financeRecordModal');
                const title = document.getElementById('financeRecordModalTitle');
                const form = document.getElementById('financeRecordForm');
                
                // 设置模态框标题
                if (record) {
                    title.textContent = '编辑财务记录';
                    this.editingFinanceRecord = record;
                } else {
                    title.textContent = '添加财务记录';
                    this.editingFinanceRecord = null;
                }
                
                // 填充账期选择器
                const periodSelect = document.getElementById('financePeriod');
                periodSelect.innerHTML = '';
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        const option = document.createElement('option');
                        option.value = period.periodId;
                        option.textContent = period.periodName;
                        periodSelect.appendChild(option);
                    });
                }
                
                // 更新子分类选项
                this.updateFinanceSubCategory('订单记录');
                
                // 如果正在编辑记录，填充表单数据
                if (record) {
                    document.getElementById('financePeriod').value = record.periodId;
                    document.getElementById('financeMainCategory').value = record.mainCategory;
                    this.updateFinanceSubCategory(record.mainCategory);
                    document.getElementById('financeSubCategory').value = record.subCategory;
                    document.getElementById('financeAmount').value = record.amount;
                    document.getElementById('financeDate').value = record.date;
                    document.getElementById('financeNotes').value = record.notes || '';
                } else {
                    // 重置表单
                    form.reset();
                    // 设置默认日期为今天
                    document.getElementById('financeDate').value = new Date().toISOString().split('T')[0];
                }
                
                modal.classList.add('active');
            },
            
            // 更新财务子分类选项
            updateFinanceSubCategory(mainCategory) {
                const subCategorySelect = document.getElementById('financeSubCategory');
                subCategorySelect.innerHTML = '';
                
                let options = [];
                if (mainCategory === '订单记录') {
                    options = ['4w', '8w', '16w'];
                } else if (mainCategory === '成本记录') {
                    options = ['提成类', '方案费用类', '工本费', '其他费用'];
                }
                
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    subCategorySelect.appendChild(opt);
                });
            },
            
            // 保存财务记录
            async saveFinanceRecord() {
                const periodId = document.getElementById('financePeriod').value;
                const mainCategory = document.getElementById('financeMainCategory').value;
                const subCategory = document.getElementById('financeSubCategory').value;
                const amount = parseFloat(document.getElementById('financeAmount').value);
                const date = document.getElementById('financeDate').value;
                const notes = document.getElementById('financeNotes').value;
                
                if (!this.currentCustomer.periods || this.currentCustomer.periods.length === 0) {
                    alert('请先添加账期');
                    return;
                }
                
                // 找到对应的账期
                const period = this.currentCustomer.periods.find(p => p.periodId === periodId);
                
                if (!period.financialStats) {
                    period.financialStats = [];
                }
                
                if (this.editingFinanceRecord) {
                    // 更新现有记录
                    const recordIndex = period.financialStats.findIndex(r => r.recordId === this.editingFinanceRecord.recordId);
                    if (recordIndex !== -1) {
                        period.financialStats[recordIndex] = {
                            ...this.editingFinanceRecord,
                            periodId: periodId,
                            mainCategory: mainCategory,
                            subCategory: subCategory,
                            amount: amount,
                            date: date,
                            notes: notes
                        };
                    }
                } else {
                    // 添加新记录
                    const newRecord = {
                        recordId: `R${Date.now()}`,
                        periodId: periodId,
                        mainCategory: mainCategory,
                        subCategory: subCategory,
                        amount: amount,
                        date: date,
                        notes: notes
                    };
                    
                    period.financialStats.push(newRecord);
                }
                
                // 保存数据
                await this.saveCustomerData();
                
                // 重新渲染财务图表
                this.renderFinanceChart(this.currentCustomer);
                
                this.closeModal(document.getElementById('financeRecordModal'));
                this.showSaveNotification();
            },
            
            // 显示财务模态框 - 修改：支持显示订单记录详情
            showFinanceModal(category) {
                const modalBody = document.querySelector('#financeModal .modal-body');
                const modalTitle = document.getElementById('financeModalTitle');
                
                // 修改：根据category设置不同的标题
                if (category === '订单记录') {
                    modalTitle.textContent = '订单记录详情';
                } else {
                    modalTitle.textContent = `${category} 财务记录详情`;
                }
                
                // 收集当前客户所有账期的该分类财务记录
                let financialStats = [];
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.financialStats) {
                            period.financialStats.forEach(record => {
                                // 修改：如果是订单记录，显示所有订单记录；否则显示指定子分类的记录
                                if ((category === '订单记录' && record.mainCategory === '订单记录') || 
                                    record.subCategory === category) {
                                    financialStats.push({
                                        ...record,
                                        periodName: period.periodName
                                    });
                                }
                            });
                        }
                    });
                }
                
                if (financialStats.length === 0) {
                    modalBody.innerHTML = `<p>暂无${category}记录</p>`;
                } else {
                    modalBody.innerHTML = `
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>账期</th>
                                    <th>${category === '订单记录' ? '子分类' : '子分类'}</th>
                                    <th>金额</th>
                                    <th>日期</th>
                                    <th>备注</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${financialStats.map(record => `
                                    <tr>
                                        <td>${record.periodName}</td>
                                        <td>${record.subCategory}</td>
                                        <td>${record.amount}</td>
                                        <td>${record.date}</td>
                                        <td>${record.notes || ''}</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm edit-finance-record" data-record-id="${record.recordId}">编辑</button>
                                            <button class="btn btn-danger btn-sm delete-finance-record" data-record-id="${record.recordId}">删除</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    // 绑定编辑和删除事件
                    setTimeout(() => {
                        document.querySelectorAll('.edit-finance-record').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const recordId = e.target.getAttribute('data-record-id');
                                this.editFinanceRecord(recordId);
                            });
                        });
                        
                        document.querySelectorAll('.delete-finance-record').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const recordId = e.target.getAttribute('data-record-id');
                                this.showDeleteConfirmModal(recordId);
                            });
                        });
                    }, 0);
                }
                
                document.getElementById('financeModal').classList.add('active');
            },
            
            // 编辑财务记录
            editFinanceRecord(recordId) {
                // 在所有账期中查找记录
                let targetRecord = null;
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.financialStats) {
                            period.financialStats.forEach(record => {
                                if (record.recordId === recordId) {
                                    targetRecord = {
                                        ...record,
                                        periodId: period.periodId
                                    };
                                }
                            });
                        }
                    });
                }
                
                if (targetRecord) {
                    this.showFinanceRecordModal(targetRecord);
                    this.closeModal(document.getElementById('financeModal'));
                }
            },
            
            // 显示删除确认模态框
            showDeleteConfirmModal(recordId) {
                this.recordToDelete = recordId;
                document.getElementById('deleteConfirmModal').classList.add('active');
            },
            
            // 删除财务记录
            async deleteFinanceRecord() {
                if (!this.recordToDelete) return;
                
                // 在所有账期中查找并删除记录
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.financialStats) {
                            const recordIndex = period.financialStats.findIndex(r => r.recordId === this.recordToDelete);
                            if (recordIndex !== -1) {
                                period.financialStats.splice(recordIndex, 1);
                            }
                        }
                    });
                }
                
                // 保存数据
                await this.saveCustomerData();
                
                // 重新渲染财务图表
                this.renderFinanceChart(this.currentCustomer);
                
                this.closeModal(document.getElementById('deleteConfirmModal'));
                this.showSaveNotification();
                
                // 如果财务模态框是打开的，刷新它
                if (document.getElementById('financeModal').classList.contains('active')) {
                    this.closeModal(document.getElementById('financeModal'));
                }
            },
            
            // 显示导入指标模态框
            showImportIndicatorsModal() {
                document.getElementById('importIndicatorsModal').classList.add('active');
            },
            
            // 新增：下载Excel模板 - 改进模板格式
            downloadExcelTemplate() {
                const templateContent = "指标名称\t数值\t单位\t参考范围\t测量时间\t检测机构\n血糖\t5.5\tmmol/L\t3.9-6.1\t2023-10-01\tXX检测中心\n血压\t120/80\tmmHg\t90/60-140/90\t2023-10-01\tXX检测中心\n胆固醇\t4.5\tmmol/L\t0-5.2\t2023-10-01\tXX检测中心";
                
                const blob = new Blob([templateContent], {type: 'text/plain;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '指标导入模板.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('模板已下载！请用Excel打开此文件，填写数据后复制所有内容（包括标题行）粘贴到系统中。');
            },
            
            // 导入指标 - 修复解析逻辑
            async importIndicators() {
                const measurementDate = document.getElementById('measurementDate').value;
                const testingInstitution = document.getElementById('testingInstitution').value;
                const pastedData = document.getElementById('pastedExcelData').value;
                
                if (!pastedData) {
                    alert('请先粘贴Excel数据');
                    return;
                }
                
                try {
                    // 解析粘贴的数据
                    const lines = pastedData.trim().split('\n');
                    const indicators = [];
                    
                    // 查找标题行，确定列的顺序
                    let nameIndex = -1, valueIndex = -1, unitIndex = -1, 
                        referenceIndex = -1, dateIndex = -1, institutionIndex = -1;
                    
                    if (lines.length > 0) {
                        const headerLine = lines[0].toLowerCase();
                        const headers = this.parseLine(headerLine);
                        
                        // 查找各列的索引位置
                        nameIndex = headers.findIndex(h => h.includes('指标') || h.includes('名称'));
                        valueIndex = headers.findIndex(h => h.includes('数值') || h.includes('值'));
                        unitIndex = headers.findIndex(h => h.includes('单位'));
                        referenceIndex = headers.findIndex(h => h.includes('参考') || h.includes('范围'));
                        dateIndex = headers.findIndex(h => h.includes('测量') || h.includes('时间') || h.includes('日期'));
                        institutionIndex = headers.findIndex(h => h.includes('检测') || h.includes('机构'));
                    }
                    
                    // 从第二行开始解析数据（跳过标题行）
                    const startIndex = (nameIndex >= 0 && valueIndex >= 0) ? 1 : 0;
                    
                    for (let i = startIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const parts = this.parseLine(line);
                        
                        if (parts.length < 2) continue; // 至少需要指标名称和数值
                        
                        // 根据列索引获取数据，如果没有标题行则按顺序
                        const indicator = {
                            name: nameIndex >= 0 ? parts[nameIndex] || '' : parts[0] || '',
                            value: valueIndex >= 0 ? parts[valueIndex] || '' : parts[1] || '',
                            unit: unitIndex >= 0 ? (parts[unitIndex] || '') : (parts[2] || ''),
                            reference: referenceIndex >= 0 ? (parts[referenceIndex] || '') : (parts[3] || ''),
                            measurementDate: dateIndex >= 0 ? (parts[dateIndex] || '') : (parts[4] || ''),
                            testingInstitution: institutionIndex >= 0 ? (parts[institutionIndex] || '') : (parts[5] || '')
                        };
                        
                        // 验证必要字段
                        if (!indicator.name || !indicator.value) {
                            console.warn('跳过无效数据行:', line);
                            continue;
                        }
                        
                        // 如果表单中有填写测量日期和检测机构，则覆盖
                        if (measurementDate) {
                            indicator.measurementDate = measurementDate;
                        }
                        if (testingInstitution) {
                            indicator.testingInstitution = testingInstitution;
                        }
                        
                        // 如果没有测量日期，使用今天
                        if (!indicator.measurementDate) {
                            indicator.measurementDate = new Date().toISOString().split('T')[0];
                        }
                        
                        indicators.push(indicator);
                    }
                    
                    if (indicators.length === 0) {
                        alert('未找到有效的指标数据，请检查粘贴格式。确保包含指标名称和数值列。');
                        return;
                    }
                    
                    // 添加到当前账期
                    if (!this.currentPeriod.abnormalIndicators) {
                        this.currentPeriod.abnormalIndicators = [];
                    }
                    
                    this.currentPeriod.abnormalIndicators.push(...indicators);
                    
                    // 保存数据
                    await this.saveCustomerData();
                    
                    // 刷新界面
                    this.renderPeriodForm(this.currentPeriod);
                    
                    this.closeModal(document.getElementById('importIndicatorsModal'));
                    this.showSaveNotification();
                    
                    alert(`成功导入 ${indicators.length} 个指标`);
                    
                } catch (error) {
                    console.error('导入失败:', error);
                    alert('导入失败: ' + error.message + '\n\n请确保粘贴的数据包含指标名称和数值，并用制表符或逗号分隔。');
                }
            },
            
            // 新增：从JSON文件导入指标
            async importIndicatorsFromJSON(file) {
                if (!file) {
                    alert('请选择JSON文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        let indicators = [];
                        
                        // 支持两种格式：指标数组或包含indicators字段的对象
                        if (Array.isArray(importedData)) {
                            indicators = importedData;
                        } else if (importedData.indicators && Array.isArray(importedData.indicators)) {
                            indicators = importedData.indicators;
                        } else {
                            throw new Error('JSON格式不正确，应为指标数组或包含indicators字段的对象');
                        }
                        
                        if (indicators.length === 0) {
                            alert('JSON文件中没有找到指标数据');
                            return;
                        }
                        
                        const measurementDate = document.getElementById('measurementDate').value;
                        const testingInstitution = document.getElementById('testingInstitution').value;
                        
                        // 处理每个指标，应用表单中的测量日期和检测机构
                        indicators.forEach(indicator => {
                            if (measurementDate) {
                                indicator.measurementDate = measurementDate;
                            }
                            if (testingInstitution) {
                                indicator.testingInstitution = testingInstitution;
                            }
                            // 如果没有测量日期，使用今天
                            if (!indicator.measurementDate) {
                                indicator.measurementDate = new Date().toISOString().split('T')[0];
                            }
                        });
                        
                        // 添加到当前账期
                        if (!this.currentPeriod.abnormalIndicators) {
                            this.currentPeriod.abnormalIndicators = [];
                        }
                        
                        this.currentPeriod.abnormalIndicators.push(...indicators);
                        
                        // 保存数据
                        await this.saveCustomerData();
                        
                        // 刷新界面
                        this.renderPeriodForm(this.currentPeriod);
                        
                        this.closeModal(document.getElementById('importIndicatorsModal'));
                        this.showSaveNotification();
                        
                        alert(`成功导入 ${indicators.length} 个指标`);
                        
                    } catch (error) {
                        alert('导入失败: ' + error.message);
                    }
                };
                reader.readAsText(file);
            },
            
            // 新增：解析行数据，支持制表符和逗号分隔
            parseLine(line) {
                // 先尝试制表符分隔（Excel复制的内容通常是制表符）
                if (line.includes('\t')) {
                    return line.split('\t').map(cell => cell.trim());
                }
                // 然后尝试逗号分隔
                else if (line.includes(',')) {
                    return line.split(',').map(cell => cell.trim());
                }
                // 最后尝试空格分隔
                else {
                    return line.split(/\s+/).map(cell => cell.trim());
                }
            },
            
            // 新增：导出客户列表Excel
            async exportCustomerListExcel() {
                const data = await CustomerModel.loadData();
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const customerServiceSearch = document.getElementById('customerServiceSearch').value.toLowerCase();
                const startPeriod = document.getElementById('startPeriod').value;
                const endPeriod = document.getElementById('endPeriod').value;
                
                // 过滤客户（与客户列表相同的过滤条件）
                let filteredCustomers = data.customers.filter(customer => {
                    const matchesSearch = customer.personalInfo.name.toLowerCase().includes(searchTerm);
                    
                    // 修复顾问过滤条件：当顾问搜索框为空时，不过滤任何客户
                    const matchesCustomerService = !customerServiceSearch || 
                        (customer.personalInfo.customerService && 
                         customer.personalInfo.customerService.toLowerCase().includes(customerServiceSearch));
                    
                    // 检查下次交付时间区间
                    let matchesPeriod = true;
                    if (startPeriod && endPeriod) {
                        const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                        if (!nextDeliveryDate) {
                            matchesPeriod = false;
                        } else {
                            matchesPeriod = nextDeliveryDate >= startPeriod && nextDeliveryDate <= endPeriod;
                        }
                    }
                    
                    return matchesSearch && matchesCustomerService && matchesPeriod;
                });

                // 生成CSV内容（添加BOM头解决中文乱码问题）
                let csvContent = "\uFEFF客户姓名,性别,年龄,服务进度,销售,顾问,下次交付时间,剩余期数\n";
                
                filteredCustomers.forEach(customer => {
                    const latestPeriod = CustomerModel.getLatestPeriod(customer);
                    const serviceProgress = latestPeriod ? latestPeriod.periodName : '';
                    const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                    const remainingPeriods = CustomerModel.getRemainingPeriods(customer);
                    
                    csvContent += `"${customer.personalInfo.name}","${customer.personalInfo.gender}",${customer.personalInfo.age},"${serviceProgress}","${customer.personalInfo.sales}","${customer.personalInfo.customerService}","${nextDeliveryDate}",${remainingPeriods}\n`;
                });
                
                // 创建Blob并下载
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `客户列表_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // 新增：导出服务账期列表Excel
            async exportPeriodListExcel() {
                const data = await CustomerModel.loadData();
                
                // 收集所有账期数据
                let periodData = [];
                
                data.customers.forEach(customer => {
                    if (customer.periods && customer.periods.length > 0) {
                        customer.periods.forEach(period => {
                            const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                            const remainingPeriods = CustomerModel.getRemainingPeriods(customer);
                            
                            periodData.push({
                                periodDate: period.periodDate,
                                customerName: customer.personalInfo.name,
                                gender: customer.personalInfo.gender,
                                age: customer.personalInfo.age,
                                sales: customer.personalInfo.sales,
                                customerService: customer.personalInfo.customerService,
                                nextDeliveryDate: nextDeliveryDate,
                                remainingPeriods: remainingPeriods
                            });
                        });
                    }
                });
                
                // 按账期日期倒序排序
                periodData.sort((a, b) => new Date(b.periodDate) - new Date(a.periodDate));
                
                // 生成CSV内容（添加BOM头解决中文乱码问题）
                let csvContent = "\uFEFF账期日期,客户名,性别,年龄,销售,顾问,下次交付时间,剩余期数\n";
                
                periodData.forEach(item => {
                    csvContent += `"${item.periodDate}","${item.customerName}","${item.gender}",${item.age},"${item.sales}","${item.customerService}","${item.nextDeliveryDate}",${item.remainingPeriods}\n`;
                });
                
                // 创建Blob并下载
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `服务账期列表_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // 添加新客户 - 修复：确保新客户能正确保存并在列表中显示
            async addNewCustomer() {
                const data = await CustomerModel.loadData();
                const newCustomerId = CustomerModel.generateCustomerId(data);
                
                const newCustomer = {
                    id: newCustomerId,
                    personalInfo: {
                        name: '新客户',
                        gender: '男',
                        birthDate: '',
                        age: 0,
                        residence: '',
                        maritalStatus: '未婚',
                        height: '',
                        weight: '',
                        bmi: '',
                        serviceProgress: '',
                        sales: '',
                        customerService: '',
                        nextDeliveryDate: '',
                        totalServicePeriods: 0, // 新增：默认服务总期数为0
                        customerPortrait: '',
                        notes: ''
                    },
                    allergyHistory: [],
                    medicationHistory: [],
                    pastMedicalHistory: [],
                    surgeryHospitalizationHistory: [],
                    vaccinationHistory: [],
                    familyHistory: [],
                    periods: [],
                    lastUpdated: new Date().toISOString()
                };
                
                data.customers.push(newCustomer);
                
                // 修复：确保数据正确保存
                const success = await CustomerModel.saveData(data);
                
                if (success) {
                    // 清空搜索条件，确保新客户在列表中显示
                    document.getElementById('searchInput').value = '';
                    document.getElementById('customerServiceSearch').value = '';
                    
                    // 重置分页到第一页
                    this.currentPageIndex = 0;
                    
                    // 刷新客户列表
                    this.renderCustomerList();
                    
                    // 显示新客户的详情
                    this.showCustomerDetail(newCustomerId);
                    
                    this.showSaveNotification();
                } else {
                    alert('创建客户失败，请重试');
                }
            },
            
            // 保存个人信息 - 修复：保存后刷新客户列表并更新当前客户引用
            async savePersonalInfo(showNotification = true) {
                if (!this.currentCustomer) return;
                
                const data = await CustomerModel.loadData();
                const customerIndex = data.customers.findIndex(c => c.id === this.currentCustomer.id);
                
                if (customerIndex === -1) return;
                
                // 更新个人信息
                data.customers[customerIndex].personalInfo.name = document.getElementById('customerName').value;
                data.customers[customerIndex].personalInfo.gender = document.getElementById('customerGender').value;
                data.customers[customerIndex].personalInfo.birthDate = document.getElementById('birthDate').value;
                data.customers[customerIndex].personalInfo.age = document.getElementById('age').value;
                data.customers[customerIndex].personalInfo.residence = document.getElementById('residence').value;
                data.customers[customerIndex].personalInfo.maritalStatus = document.getElementById('maritalStatus').value;
                data.customers[customerIndex].personalInfo.height = document.getElementById('height').value;
                data.customers[customerIndex].personalInfo.weight = document.getElementById('weight').value;
                data.customers[customerIndex].personalInfo.bmi = document.getElementById('bmi').value;
                data.customers[customerIndex].personalInfo.sales = document.getElementById('sales').value;
                data.customers[customerIndex].personalInfo.customerService = document.getElementById('customerService').value;
                data.customers[customerIndex].personalInfo.totalServicePeriods = parseInt(document.getElementById('totalServicePeriods').value) || 0; // 新增：保存服务总期数
                data.customers[customerIndex].personalInfo.customerPortrait = document.getElementById('customerPortrait').value;
                data.customers[customerIndex].personalInfo.notes = document.getElementById('notes').value;
                
                // 更新表格数据
                data.customers[customerIndex].allergyHistory = this.currentCustomer.allergyHistory || [];
                data.customers[customerIndex].medicationHistory = this.currentCustomer.medicationHistory || [];
                data.customers[customerIndex].pastMedicalHistory = this.currentCustomer.pastMedicalHistory || [];
                data.customers[customerIndex].surgeryHospitalizationHistory = this.currentCustomer.surgeryHospitalizationHistory || [];
                data.customers[customerIndex].vaccinationHistory = this.currentCustomer.vaccinationHistory || [];
                data.customers[customerIndex].familyHistory = this.currentCustomer.familyHistory || [];
                
                data.customers[customerIndex].lastUpdated = new Date().toISOString();
                
                await CustomerModel.saveData(data);
                
                // 保存后更新当前客户引用
                const updatedData = await CustomerModel.loadData();
                const updatedCustomer = updatedData.customers.find(c => c.id === this.currentCustomer.id);
                if (updatedCustomer) {
                    this.currentCustomer = updatedCustomer;
                }
                
                // 更新下次交付时间（考虑剩余期数是否为0）
                this.updateNextDeliveryDate();
                
                // 刷新客户列表，确保列表显示最新数据
                this.renderCustomerList();
                
                if (showNotification) {
                    this.showSaveNotification();
                }
            },
            
            // 保存账期信息 - 修复：保存后刷新客户列表
            async savePeriodInfo(showNotification = true) {
                if (!this.currentCustomer || !this.currentPeriod) {
                    console.error('无法保存：当前客户或账期为空');
                    return;
                }
                
                try {
                    const data = await CustomerModel.loadData();
                    const customerIndex = data.customers.findIndex(c => c.id === this.currentCustomer.id);
                    
                    if (customerIndex === -1) {
                        console.error('客户不存在于数据中');
                        return;
                    }
                    
                    // 找到当前账期在数据中的索引
                    const periodIndex = data.customers[customerIndex].periods.findIndex(p => p.periodId === this.currentPeriod.periodId);
                    
                    if (periodIndex === -1) {
                        console.error('账期不存在于客户数据中');
                        return;
                    }
                    
                    // 更新账期信息
                    const updatedPeriod = {
                        ...data.customers[customerIndex].periods[periodIndex],
                        stressMentalHealth: document.getElementById('stressMentalHealth')?.value || '',
                        environmentOccupational: document.getElementById('environmentOccupational')?.value || '',
                        subjectiveHealth: document.getElementById('subjectiveHealth')?.value || '',
                        // 保留表格数据
                        dietaryHabits: this.currentPeriod.dietaryHabits || [],
                        physicalActivity: this.currentPeriod.physicalActivity || [],
                        sleepPattern: this.currentPeriod.sleepPattern || [],
                        abnormalIndicators: this.currentPeriod.abnormalIndicators || [],
                        communicationRecords: this.currentPeriod.communicationRecords || [],
                        followUpRecords: this.currentPeriod.followUpRecords || [],
                        financialStats: this.currentPeriod.financialStats || [],
                        attachments: this.currentPeriod.attachments || []
                    };
                    
                    // 直接替换整个账期对象
                    data.customers[customerIndex].periods[periodIndex] = updatedPeriod;
                    data.customers[customerIndex].lastUpdated = new Date().toISOString();
                    
                    // 同步更新当前客户和当前账期的引用
                    this.currentCustomer = data.customers[customerIndex];
                    this.currentPeriod = updatedPeriod;
                    
                    await CustomerModel.saveData(data);
                    
                    // 更新下次交付时间（考虑剩余期数是否为0）
                    this.updateNextDeliveryDate();
                    
                    // 刷新客户列表
                    this.renderCustomerList();
                    
                    if (showNotification) {
                        this.showSaveNotification();
                    }
                    
                    console.log('账期信息已保存:', this.currentPeriod.periodName);
                } catch (error) {
                    console.error('保存账期信息时出错:', error);
                    alert('保存失败，请检查数据完整性');
                }
            },
            
            // 保存客户数据（通用方法）
            async saveCustomerData() {
                const data = await CustomerModel.loadData();
                const customerIndex = data.customers.findIndex(c => c.id === this.currentCustomer.id);
                
                if (customerIndex === -1) return;
                
                // 更新整个客户对象
                data.customers[customerIndex] = this.currentCustomer;
                data.customers[customerIndex].lastUpdated = new Date().toISOString();
                
                await CustomerModel.saveData(data);
            },
            
            // 显示保存通知
            showSaveNotification() {
                const notification = document.getElementById('saveNotification');
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
            },
            
            // 关闭模态框
            closeModal(modal) {
                modal.classList.remove('active');
            },
            
            // 显示导出数据模态框 - 修改：支持多选
            async showExportDataModal() {
                const modal = document.getElementById('exportDataModal');
                const customerCheckboxes = document.getElementById('customerCheckboxes');
                const customerSearchInput = document.getElementById('customerSearchInput');
                
                // 清空搜索框和选择框
                customerSearchInput.value = '';
                customerCheckboxes.innerHTML = '';
                this.selectedCustomerIds = [];
                
                // 加载所有客户
                const data = await CustomerModel.loadData();
                data.customers.forEach(customer => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'customer-checkbox-item';
                    checkboxItem.innerHTML = `
                        <input type="checkbox" value="${customer.id}" id="customer_${customer.id}">
                        <label for="customer_${customer.id}">${customer.personalInfo.name} (${customer.id})</label>
                    `;
                    customerCheckboxes.appendChild(checkboxItem);
                });
                
                // 绑定复选框变化事件
                setTimeout(() => {
                    document.querySelectorAll('#customerCheckboxes input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            const customerId = e.target.value;
                            if (e.target.checked) {
                                if (!this.selectedCustomerIds.includes(customerId)) {
                                    this.selectedCustomerIds.push(customerId);
                                }
                            } else {
                                const index = this.selectedCustomerIds.indexOf(customerId);
                                if (index > -1) {
                                    this.selectedCustomerIds.splice(index, 1);
                                }
                            }
                        });
                    });
                }, 0);
                
                modal.classList.add('active');
            },
            
            // 过滤导出客户
            filterExportCustomers(searchTerm) {
                const customerCheckboxes = document.getElementById('customerCheckboxes');
                const items = customerCheckboxes.getElementsByClassName('customer-checkbox-item');
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm.toLowerCase())) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                }
            },
            
            // 新增：导出选中客户数据 - 每个客户单独文件
            async exportSelectedData() {
                if (this.selectedCustomerIds.length === 0) {
                    alert('请先选择客户');
                    return;
                }
                
                const data = await CustomerModel.loadData();
                
                for (const customerId of this.selectedCustomerIds) {
                    const customer = data.customers.find(c => c.id === customerId);
                    
                    if (!customer) {
                        console.warn(`未找到客户数据: ${customerId}`);
                        continue;
                    }
                    
                    // 创建不包含id的客户副本
                    const customerWithoutId = {...customer};
                    delete customerWithoutId.id;
                    
                    // 导出单个客户数据（不包含id）
                    const customerData = {
                        customer: customerWithoutId
                    };
                    
                    const dataStr = JSON.stringify(customerData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `customer_${customer.personalInfo.name}_${customer.id}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                
                this.closeModal(document.getElementById('exportDataModal'));
                alert(`已导出 ${this.selectedCustomerIds.length} 个客户数据`);
            },
            
            // 新增：导出当前列表数据 - 每个客户单独文件
            async exportCurrentListData() {
                const data = await CustomerModel.loadData();
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const customerServiceSearch = document.getElementById('customerServiceSearch').value.toLowerCase();
                const startPeriod = document.getElementById('startPeriod').value;
                const endPeriod = document.getElementById('endPeriod').value;
                
                // 过滤客户（与客户列表相同的过滤条件）
                let filteredCustomers = data.customers.filter(customer => {
                    const matchesSearch = customer.personalInfo.name.toLowerCase().includes(searchTerm);
                    
                    // 修复顾问过滤条件：当顾问搜索框为空时，不过滤任何客户
                    const matchesCustomerService = !customerServiceSearch || 
                        (customer.personalInfo.customerService && 
                         customer.personalInfo.customerService.toLowerCase().includes(customerServiceSearch));
                    
                    // 检查下次交付时间区间
                    let matchesPeriod = true;
                    if (startPeriod && endPeriod) {
                        const nextDeliveryDate = CustomerModel.getNextDeliveryDate(customer);
                        if (!nextDeliveryDate) {
                            matchesPeriod = false;
                        } else {
                            matchesPeriod = nextDeliveryDate >= startPeriod && nextDeliveryDate <= endPeriod;
                        }
                    }
                    
                    return matchesSearch && matchesCustomerService && matchesPeriod;
                });
                
                if (filteredCustomers.length === 0) {
                    alert('当前列表没有客户数据');
                    return;
                }
                
                for (const customer of filteredCustomers) {
                    // 创建不包含id的客户副本
                    const customerWithoutId = {...customer};
                    delete customerWithoutId.id;
                    
                    // 导出单个客户数据（不包含id）
                    const customerData = {
                        customer: customerWithoutId
                    };
                    
                    const dataStr = JSON.stringify(customerData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `customer_${customer.personalInfo.name}_${customer.id}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                
                this.closeModal(document.getElementById('exportDataModal'));
                alert(`已导出 ${filteredCustomers.length} 个客户数据`);
            },
            
            // 导出全部数据 - 修改：导出时不包含客户编号字段
            async exportAllData() {
                const data = await CustomerModel.loadData();
                
                // 创建不包含id的客户数据副本
                const dataWithoutIds = {
                    customers: data.customers.map(customer => {
                        const customerWithoutId = {...customer};
                        delete customerWithoutId.id;
                        return customerWithoutId;
                    }),
                    nextCustomerId: data.nextCustomerId,
                    settings: data.settings
                };
                
                const dataStr = JSON.stringify(dataWithoutIds, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `customer_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.closeModal(document.getElementById('exportDataModal'));
            },
            
            // 显示导出Word模态框
            showExportWordModal() {
                if (!this.currentCustomer) {
                    alert('请先选择客户');
                    return;
                }
                
                const periodsCheckboxes = document.getElementById('periodsCheckboxes');
                periodsCheckboxes.innerHTML = '';
                
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        const checkbox = document.createElement('div');
                        checkbox.innerHTML = `
                            <label>
                                <input type="checkbox" value="${period.periodId}" checked>
                                ${period.periodName}
                            </label>
                        `;
                        periodsCheckboxes.appendChild(checkbox);
                    });
                }
                
                document.getElementById('exportWordModal').classList.add('active');
            },
            
            // 新增：显示导入数据模态框
            showImportDataModal() {
                const modal = document.getElementById('importDataModal');
                const fileList = document.getElementById('importFileList');
                
                // 清空文件列表
                fileList.innerHTML = '';
                this.importFiles = [];
                
                modal.classList.add('active');
            },
            
            // 新增：处理导入文件
            handleImportFiles(files) {
                if (!files || files.length === 0) return;
                
                const fileList = document.getElementById('importFileList');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // 检查文件类型
                    if (!file.name.toLowerCase().endsWith('.json')) {
                        alert(`文件 ${file.name} 不是JSON格式，已跳过`);
                        continue;
                    }
                    
                    // 检查是否已存在同名文件
                    if (this.importFiles.some(f => f.name === file.name)) {
                        alert(`文件 ${file.name} 已存在，已跳过`);
                        continue;
                    }
                    
                    this.importFiles.push(file);
                    
                    // 添加文件到列表
                    const fileItem = document.createElement('div');
                    fileItem.className = 'customer-checkbox-item';
                    fileItem.innerHTML = `
                        <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                        <button type="button" class="btn btn-danger btn-sm remove-file" data-index="${this.importFiles.length - 1}">删除</button>
                    `;
                    fileList.appendChild(fileItem);
                }
                
                // 绑定删除文件事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-file').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeImportFile(index);
                        });
                    });
                }, 0);
            },
            
            // 新增：删除导入文件
            removeImportFile(index) {
                if (index >= 0 && index < this.importFiles.length) {
                    this.importFiles.splice(index, 1);
                    this.updateImportFileList();
                }
            },
            
            // 新增：更新导入文件列表
            updateImportFileList() {
                const fileList = document.getElementById('importFileList');
                fileList.innerHTML = '';
                
                this.importFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'customer-checkbox-item';
                    fileItem.innerHTML = `
                        <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                        <button type="button" class="btn btn-danger btn-sm remove-file" data-index="${index}">删除</button>
                    `;
                    fileList.appendChild(fileItem);
                });
                
                // 重新绑定删除文件事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-file').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeImportFile(index);
                        });
                    });
                }, 0);
            },
            
            // 新增：导入选中的文件
            async importSelectedFiles() {
                if (this.importFiles.length === 0) {
                    alert('请先选择要导入的文件');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const file of this.importFiles) {
                    try {
                        const importedData = await this.readFileAsJSON(file);
                        const currentData = await CustomerModel.loadData();
                        
                        // 合并客户数据 - 修改：总是新增，不覆盖
                        if (importedData.customer) {
                            // 为导入的客户生成新的ID
                            const newCustomerId = CustomerModel.generateCustomerId(currentData);
                            const newCustomer = {
                                ...importedData.customer,
                                id: newCustomerId
                            };
                            
                            // 总是添加为新客户，不检查是否已存在
                            currentData.customers.push(newCustomer);
                            successCount++;
                        } else if (importedData.customers && Array.isArray(importedData.customers)) {
                            // 处理批量客户数据
                            importedData.customers.forEach(importedCustomer => {
                                const newCustomerId = CustomerModel.generateCustomerId(currentData);
                                const newCustomer = {
                                    ...importedCustomer,
                                    id: newCustomerId
                                };
                                currentData.customers.push(newCustomer);
                                successCount++;
                            });
                        } else {
                            errorCount++;
                            console.warn(`文件 ${file.name} 格式不正确，已跳过`);
                        }
                        
                        // 保存数据
                        await CustomerModel.saveData(currentData);
                        
                    } catch (error) {
                        errorCount++;
                        console.error(`导入文件 ${file.name} 失败:`, error);
                    }
                }
                
                // 刷新界面
                this.renderCustomerList();
                this.showSaveNotification();
                
                // 关闭模态框
                this.closeModal(document.getElementById('importDataModal'));
                
                // 显示导入结果
                alert(`导入完成！成功: ${successCount} 个，失败: ${errorCount} 个`);
            },
            
            // 新增：读取文件为JSON
            readFileAsJSON(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            resolve(importedData);
                        } catch (error) {
                            reject(new Error(`文件 ${file.name} 不是有效的JSON格式`));
                        }
                    };
                    reader.onerror = () => reject(new Error(`读取文件 ${file.name} 失败`));
                    reader.readAsText(file);
                });
            },
            
            // 导出Word文档 - 修改：添加指标对比内容
            exportWord() {
                if (!this.currentCustomer) return;
                
                const selectedPeriods = [];
                document.querySelectorAll('#periodsCheckboxes input:checked').forEach(checkbox => {
                    const periodId = checkbox.value;
                    const period = this.currentCustomer.periods.find(p => p.periodId === periodId);
                    if (period) {
                        selectedPeriods.push(period);
                    }
                });
                
                // 生成Word文档内容
                let content = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                          xmlns:w='urn:schemas-microsoft-com:office:word' 
                          xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset="utf-8">
                        <title>${this.currentCustomer.personalInfo.name}健康档案</title>
                        <style>
                            table { border-collapse: collapse; }
                            td, th { padding: 5px 10px; }
                        </style>
                    </head>
                    <body>
                        <h1>${this.currentCustomer.personalInfo.name}健康档案</h1>
                        <h2>个人信息</h2>
                        <table>
                            <tr><td>姓名</td><td>${this.currentCustomer.personalInfo.name}</td></tr>
                            <tr><td>性别</td><td>${this.currentCustomer.personalInfo.gender}</td></tr>
                            <tr><td>年龄</td><td>${this.currentCustomer.personalInfo.age}</td></tr>
                            <tr><td>常居地</td><td>${this.currentCustomer.personalInfo.residence}</td></tr>
                            <tr><td>婚姻状况</td><td>${this.currentCustomer.personalInfo.maritalStatus}</td></tr>
                            <tr><td>身高</td><td>${this.currentCustomer.personalInfo.height} cm</td></tr>
                            <tr><td>体重</td><td>${this.currentCustomer.personalInfo.weight} kg</td></tr>
                            <tr><td>BMI</td><td>${this.currentCustomer.personalInfo.bmi}</td></tr>
                            <tr><td>服务进度</td><td>${this.currentCustomer.personalInfo.serviceProgress}</td></tr>
                            <tr><td>销售</td><td>${this.currentCustomer.personalInfo.sales}</td></tr>
                            <tr><td>顾问</td><td>${this.currentCustomer.personalInfo.customerService}</td></tr>
                            <tr><td>下次交付时间</td><td>${this.currentCustomer.personalInfo.nextDeliveryDate}</td></tr>
                            <tr><td>服务总期数</td><td>${this.currentCustomer.personalInfo.totalServicePeriods || 0}</td></tr>
                            <tr><td>客户画像</td><td>${this.currentCustomer.personalInfo.customerPortrait ? this.currentCustomer.personalInfo.customerPortrait.replace(/\n/g, '<br>') : ''}</td></tr>
                            <tr><td>备注</td><td>${this.currentCustomer.personalInfo.notes ? this.currentCustomer.personalInfo.notes.replace(/\n/g, '<br>') : ''}</td></tr>
                        </table>
                `;
                
                // 添加个人信息表格
                content += this.exportPersonalInfoTables();
                
                // 添加账期信息
                selectedPeriods.forEach(period => {
                    content += `
                        <h2>${period.periodName} 账期信息</h2>
                        ${this.exportPeriodInfoTables(period)}
                        <h3>异常检测指标</h3>
                    `;
                    
                    if (period.abnormalIndicators && period.abnormalIndicators.length > 0) {
                        content += `<table border="1" cellpadding="5" cellspacing="0">
                            <tr><th>指标名称</th><th>数值</th><th>单位</th><th>参考范围</th><th>测量时间</th><th>检测机构</th></tr>`;
                        
                        period.abnormalIndicators.forEach(indicator => {
                            content += `<tr>
                                <td>${indicator.name}</td>
                                <td>${indicator.value}</td>
                                <td>${indicator.unit}</td>
                                <td>${indicator.reference}</td>
                                <td>${indicator.measurementDate}</td>
                                <td>${indicator.testingInstitution || ''}</td>
                            </tr>`;
                        });
                        
                        content += `</table>`;
                    } else {
                        content += `<p>无</p>`;
                    }
                    
                    content += `
                        <h3>企微沟通记录</h3>
                    `;
                    
                    if (period.communicationRecords && period.communicationRecords.length > 0) {
                        content += `<table border="1" cellpadding="5" cellspacing="0">
                            <tr><th>日期</th><th>关键词</th><th>客诉内容</th></tr>`;
                        
                        period.communicationRecords.forEach(record => {
                            content += `<tr>
                                <td>${record.date}</td>
                                <td>${record.keyword}</td>
                                <td>${record.content ? record.content.replace(/\n/g, '<br>') : ''}</td>
                            </tr>`;
                        });
                        
                        content += `</table>`;
                    } else {
                        content += `<p>无</p>`;
                    }
                    
                    content += `
                        <h3>回访记录</h3>
                    `;
                    
                    if (period.followUpRecords && period.followUpRecords.length > 0) {
                        content += `<table border="1" cellpadding="5" cellspacing="0">
                            <tr><th>日期</th><th>项目名称</th><th>回访内容</th></tr>`;
                        
                        period.followUpRecords.forEach(record => {
                            content += `<tr>
                                <td>${record.date}</td>
                                <td>${record.project}</td>
                                <td>${record.reason ? record.reason.replace(/\n/g, '<br>') : ''}</td>
                            </tr>`;
                        });
                        
                        content += `</table>`;
                    } else {
                        content += `<p>无</p>`;
                    }
                });
                
                // 添加指标对比内容
                content += this.exportIndicatorsCompare();
                
                content += `</body></html>`;
                
                // 创建Blob并下载
                const blob = new Blob([content], {type: 'application/msword'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.currentCustomer.personalInfo.name}健康档案.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.closeModal(document.getElementById('exportWordModal'));
            },
            
            // 导出个人信息表格
            exportPersonalInfoTables() {
                let content = '';
                
                // 过敏史
                content += '<h2>过敏史</h2>';
                if (this.currentCustomer.allergyHistory && this.currentCustomer.allergyHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>过敏原类别</th><th>具体过敏原</th><th>反应严重程度</th><th>过敏反应描述</th><th>首次发现日期</th></tr>';
                    this.currentCustomer.allergyHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.allergenType}</td>
                            <td>${record.allergen}</td>
                            <td>${record.severity}</td>
                            <td>${record.description}</td>
                            <td>${record.firstFoundDate}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                // 用药史
                content += '<h2>用药史</h2>';
                if (this.currentCustomer.medicationHistory && this.currentCustomer.medicationHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>药物名称</th><th>药物类型</th><th>用药原因/适应症</th><th>剂量</th><th>服用频率</th></tr>';
                    this.currentCustomer.medicationHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.medicationName}</td>
                            <td>${record.medicationType}</td>
                            <td>${record.reason}</td>
                            <td>${record.dosage}</td>
                            <td>${record.frequency}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                // 既往病史
                content += '<h2>既往病史</h2>';
                if (this.currentCustomer.pastMedicalHistory && this.currentCustomer.pastMedicalHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>疾病/状况名称</th><th>记录类型</th><th>详情</th><th>诊断/发生日期</th></tr>';
                    this.currentCustomer.pastMedicalHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.conditionName}</td>
                            <td>${record.recordType}</td>
                            <td>${record.currentStatus}</td>
                            <td>${record.diagnosisDate}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                // 手术与住院史
                content += '<h2>手术与住院史</h2>';
                if (this.currentCustomer.surgeryHospitalizationHistory && this.currentCustomer.surgeryHospitalizationHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>事件名称</th><th>事件类型</th><th>发生日期</th><th>结果与影响</th></tr>';
                    this.currentCustomer.surgeryHospitalizationHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.eventName}</td>
                            <td>${record.eventType}</td>
                            <td>${record.eventDate}</td>
                            <td>${record.result ? record.result.replace(/\n/g, '<br>') : ''}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                // 疫苗接种史
                content += '<h2>疫苗接种史</h2>';
                if (this.currentCustomer.vaccinationHistory && this.currentCustomer.vaccinationHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>疫苗名称</th><th>接种日期</th><th>备注</th></tr>';
                    this.currentCustomer.vaccinationHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.vaccineName}</td>
                            <td>${record.vaccinationDate}</td>
                            <td>${record.notes}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                // 家族病史
                content += '<h2>家族病史</h2>';
                if (this.currentCustomer.familyHistory && this.currentCustomer.familyHistory.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>亲属关系</th><th>疾病/状况名称</th><th>发病年龄</th></tr>';
                    this.currentCustomer.familyHistory.forEach(record => {
                        content += `<tr>
                            <td>${record.relationship}</td>
                            <td>${record.condition}</td>
                            <td>${record.onsetAge}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                return content;
            },
            
            // 导出账期信息表格
            exportPeriodInfoTables(period) {
                let content = '';
                
                // 膳食习惯
                content += '<h3>膳食习惯</h3>';
                if (period.dietaryHabits && period.dietaryHabits.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>主类型</th><th>子类型</th><th>备注</th></tr>';
                    period.dietaryHabits.forEach(record => {
                        content += `<tr>
                            <td>${record.mainType}</td>
                            <td>${record.subType}</td>
                            <td>${record.notes ? record.notes.replace(/\n/g, '<br>') : ''}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                // 身体活动
                content += '<h3>身体活动</h3>';
                if (period.physicalActivity && period.physicalActivity.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>运动类型</th><th>频率</th><th>时长和强度</th><th>日常活动水平与久坐时间</th></tr>';
                    period.physicalActivity.forEach(record => {
                        content += `<tr>
                            <td>${record.exerciseType}</td>
                            <td>${record.frequency}</td>
                            <td>${record.durationIntensity}</td>
                            <td>${record.dailyActivity}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                // 睡眠模式
                content += '<h3>睡眠模式</h3>';
                if (period.sleepPattern && period.sleepPattern.length > 0) {
                    content += '<table border="1" cellpadding="5" cellspacing="0"><tr><th>整体睡眠状况</th><th>主观睡眠问题</th></tr>';
                    period.sleepPattern.forEach(record => {
                        content += `<tr>
                            <td>${record.sleepStatus}</td>
                            <td>${record.subjectiveProblems ? record.subjectiveProblems.replace(/\n/g, '<br>') : ''}</td>
                        </tr>`;
                    });
                    content += '</table>';
                } else {
                    content += '<p>无</p>';
                }
                
                // 压力与心理健康
                content += '<h3>压力与心理健康</h3>';
                content += `<p>${period.stressMentalHealth ? period.stressMentalHealth.replace(/\n/g, '<br>') : '无'}</p>`;
                
                // 环境与职业因素
                content += '<h3>环境与职业因素</h3>';
                content += `<p>${period.environmentOccupational ? period.environmentOccupational.replace(/\n/g, '<br>') : '无'}</p>`;
                
                // 主观健康感受
                content += '<h3>主观健康感受</h3>';
                content += `<p>${period.subjectiveHealth ? period.subjectiveHealth.replace(/\n/g, '<br>') : '无'}</p>`;
                
                return content;
            },
            
            // 导出指标对比内容
            exportIndicatorsCompare() {
                if (!this.currentCustomer) return '';
                
                // 获取所有指标名称
                const indicatorNames = CustomerModel.getAllIndicatorNames(this.currentCustomer);
                
                if (indicatorNames.length === 0) {
                    return '<h2>指标对比</h2><p>暂无指标数据</p>';
                }
                
                // 收集指标数据
                const indicatorData = {};
                const datePeriodMap = {};
                
                indicatorNames.forEach(indicator => {
                    indicatorData[indicator] = [];
                });
                
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.abnormalIndicators) {
                            period.abnormalIndicators.forEach(indicator => {
                                if (indicatorNames.includes(indicator.name)) {
                                    indicatorData[indicator.name].push({
                                        period: period.periodName,
                                        value: indicator.value,
                                        measurementDate: indicator.measurementDate
                                    });
                                    
                                    // 提取账期编号
                                    const periodNumber = period.periodName.split('-')[0];
                                    datePeriodMap[indicator.measurementDate] = periodNumber;
                                }
                            });
                        }
                    });
                }
                
                // 收集所有测量日期
                const allDates = [];
                Object.keys(indicatorData).forEach(indicator => {
                    indicatorData[indicator].forEach(item => {
                        if (!allDates.includes(item.measurementDate)) {
                            allDates.push(item.measurementDate);
                        }
                    });
                });
                
                allDates.sort();
                
                // 收集所有指标名称并排序
                const indicators = Object.keys(indicatorData).sort();
                
                let content = '<h2>指标对比</h2>';
                
                if (indicators.length === 0) {
                    content += '<p>暂无指标数据</p>';
                    return content;
                }
                
                content += '<table border="1" cellpadding="5" cellspacing="0"><thead><tr><th>指标名称</th><th>参考范围</th>';
                
                allDates.forEach(date => {
                    const periodNumber = datePeriodMap[date] || '';
                    const headerText = periodNumber ? `${date} (${periodNumber})` : date;
                    content += `<th>${headerText}</th>`;
                });
                
                content += '</tr></thead><tbody>';
                
                indicators.forEach(indicator => {
                    content += `<tr><td>${indicator}</td><td>${this.getReferenceRange(indicator) || '-'}</td>`;
                    
                    allDates.forEach(date => {
                        const item = indicatorData[indicator].find(d => d.measurementDate === date);
                        content += `<td>${item ? item.value : '-'}</td>`;
                    });
                    
                    content += '</tr>';
                });
                
                content += '</tbody></table>';
                
                return content;
            },
            
            // 获取指标的参考范围
            getReferenceRange(indicatorName) {
                if (!this.currentCustomer || !this.currentCustomer.periods) return '';
                
                for (const period of this.currentCustomer.periods) {
                    if (period.abnormalIndicators) {
                        for (const indicator of period.abnormalIndicators) {
                            if (indicator.name === indicatorName && indicator.reference) {
                                return indicator.reference;
                            }
                        }
                    }
                }
                
                return '';
            },
            
            // 导出财务Excel
            async exportFinanceExcel() {
                const data = await CustomerModel.loadData();
                
                // 收集所有财务记录
                let allFinanceRecords = [];
                data.customers.forEach(customer => {
                    if (customer.periods) {
                        customer.periods.forEach(period => {
                            if (period.financialStats) {
                                period.financialStats.forEach(record => {
                                    allFinanceRecords.push({
                                        customerName: customer.personalInfo.name,
                                        date: record.date,
                                        mainCategory: record.mainCategory,
                                        subCategory: record.subCategory,
                                        amount: record.amount,
                                        notes: record.notes || ''
                                    });
                                });
                            }
                        });
                    }
                });
                
                // 按日期排序
                allFinanceRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // 生成CSV内容（添加BOM头解决中文乱码问题）
                let csvContent = "\uFEFF客户名,日期,主分类,子分类,金额,备注\n";
                
                allFinanceRecords.forEach(record => {
                    csvContent += `"${record.customerName}","${record.date}","${record.mainCategory}","${record.subCategory}",${record.amount},"${record.notes}"\n`;
                });
                
                // 创建Blob并下载
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `财务记录_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // 导出指标对比Excel
            async exportIndicatorsExcel() {
                if (!this.currentCustomer) {
                    alert('请先选择客户');
                    return;
                }
                
                // 获取所有指标名称
                const indicatorNames = CustomerModel.getAllIndicatorNames(this.currentCustomer);
                
                if (indicatorNames.length === 0) {
                    alert('该客户暂无指标数据');
                    return;
                }
                
                // 收集指标数据
                const indicatorData = {};
                const datePeriodMap = {};
                
                indicatorNames.forEach(indicator => {
                    indicatorData[indicator] = [];
                });
                
                if (this.currentCustomer.periods) {
                    this.currentCustomer.periods.forEach(period => {
                        if (period.abnormalIndicators) {
                            period.abnormalIndicators.forEach(indicator => {
                                if (indicatorNames.includes(indicator.name)) {
                                    indicatorData[indicator.name].push({
                                        period: period.periodName,
                                        value: indicator.value,
                                        measurementDate: indicator.measurementDate
                                    });
                                    
                                    // 提取账期编号
                                    const periodNumber = period.periodName.split('-')[0];
                                    datePeriodMap[indicator.measurementDate] = periodNumber;
                                }
                            });
                        }
                    });
                }
                
                // 收集所有测量日期
                const allDates = [];
                Object.keys(indicatorData).forEach(indicator => {
                    indicatorData[indicator].forEach(item => {
                        if (!allDates.includes(item.measurementDate)) {
                            allDates.push(item.measurementDate);
                        }
                    });
                });
                
                allDates.sort();
                
                // 收集所有指标名称并排序
                const indicators = Object.keys(indicatorData).sort();
                
                // 生成CSV内容（添加BOM头解决中文乱码问题）
                let csvContent = "\uFEFF指标名称,参考范围";
                
                allDates.forEach(date => {
                    const periodNumber = datePeriodMap[date] || '';
                    const headerText = periodNumber ? `${date} (${periodNumber})` : date;
                    csvContent += `,"${headerText}"`;
                });
                
                csvContent += "\n";
                
                indicators.forEach(indicator => {
                    csvContent += `"${indicator}","${this.getReferenceRange(indicator) || '-'}"`;
                    
                    allDates.forEach(date => {
                        const item = indicatorData[indicator].find(d => d.measurementDate === date);
                        csvContent += `,"${item ? item.value : '-'}"`;
                    });
                    
                    csvContent += "\n";
                });
                
                // 创建Blob并下载
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.currentCustomer.personalInfo.name}指标对比_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // 导入数据 - 修改：确保总是新增数据，不覆盖原有数据
            async importData(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        const currentData = await CustomerModel.loadData();
                        
                        // 合并客户数据 - 修改：总是新增，不覆盖
                        if (importedData.customers) {
                            importedData.customers.forEach(importedCustomer => {
                                // 为导入的客户生成新的ID
                                const newCustomerId = CustomerModel.generateCustomerId(currentData);
                                const newCustomer = {
                                    ...importedCustomer,
                                    id: newCustomerId
                                };
                                
                                // 总是添加为新客户，不检查是否已存在
                                currentData.customers.push(newCustomer);
                            });
                        }
                        
                        // 保存数据
                        await CustomerModel.saveData(currentData);
                        this.showSaveNotification();
                        this.renderCustomerList();
                        
                        alert(`成功导入 ${importedData.customers ? importedData.customers.length : 0} 个客户数据`);
                    } catch (error) {
                        alert('导入失败：文件格式不正确');
                    }
                };
                reader.readAsText(file);
            },
            
            // 显示重置确认模态框
            showResetConfirmModal() {
                document.getElementById('resetConfirmModal').classList.add('active');
            },
            
            // 重置所有数据
            async resetAllData() {
                const emptyData = {
                    customers: [],
                    nextCustomerId: 1,
                    settings: {
                        pageSize: 10
                    }
                };
                
                await CustomerModel.saveData(emptyData);
                this.closeModal(document.getElementById('resetConfirmModal'));
                this.showPage('customer-list');
                this.renderCustomerList();
                alert('所有数据已重置');
            },
            
            // 数据完整性检查
            validatePeriodData(period) {
                if (!period || !period.periodId || !period.periodName) {
                    console.error('账期数据不完整');
                    return false;
                }
                return true;
            },
            
            // ========== 个人信息表格相关方法 ==========
            
            // 渲染过敏史表格
            renderAllergyHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>过敏原类别</th><th>具体过敏原</th><th>反应严重程度</th><th>过敏反应描述</th><th>首次发现日期</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td>
                                <select data-index="${index}" data-field="allergenType">
                                    <option value="药物" ${record.allergenType === '药物' ? 'selected' : ''}>药物</option>
                                    <option value="食物" ${record.allergenType === '食物' ? 'selected' : ''}>食物</option>
                                    <option value="环境" ${record.allergenType === '环境' ? 'selected' : ''}>环境</option>
                                    <option value="其他" ${record.allergenType === '其他' ? 'selected' : ''}>其他</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.allergen || ''}" data-index="${index}" data-field="allergen"></td>
                            <td>
                                <select data-index="${index}" data-field="severity">
                                    <option value="轻度" ${record.severity === '轻度' ? 'selected' : ''}>轻度</option>
                                    <option value="中度" ${record.severity === '中度' ? 'selected' : ''}>中度</option>
                                    <option value="重度" ${record.severity === '重度' ? 'selected' : ''}>重度</option>
                                    <option value="危及生命" ${record.severity === '危及生命' ? 'selected' : ''}>危及生命</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.description || ''}" data-index="${index}" data-field="description"></td>
                            <td><input type="date" value="${record.firstFoundDate || ''}" data-index="${index}" data-field="firstFoundDate"></td>
                            <td><button type="button" class="btn btn-secondary remove-allergy" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-allergy').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeAllergyHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#allergyHistoryContainer select, #allergyHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateAllergyHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加过敏史记录
            addAllergyHistoryRecord() {
                if (!this.currentCustomer.allergyHistory) {
                    this.currentCustomer.allergyHistory = [];
                }
                
                this.currentCustomer.allergyHistory.push({
                    allergenType: '药物',
                    allergen: '',
                    severity: '轻度',
                    description: '',
                    firstFoundDate: new Date().toISOString().split('T')[0]
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 删除过敏史记录
            removeAllergyHistoryRecord(index) {
                this.currentCustomer.allergyHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 更新过敏史记录
            updateAllergyHistoryRecord(index, field, value) {
                if (!this.currentCustomer.allergyHistory) {
                    this.currentCustomer.allergyHistory = [];
                }
                this.currentCustomer.allergyHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // 渲染用药史表格
            renderMedicationHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>药物名称</th><th>药物类型</th><th>用药原因/适应症</th><th>剂量</th><th>服用频率</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.medicationName || ''}" data-index="${index}" data-field="medicationName"></td>
                            <td>
                                <select data-index="${index}" data-field="medicationType">
                                    <option value="处方药" ${record.medicationType === '处方药' ? 'selected' : ''}>处方药</option>
                                    <option value="非处方药" ${record.medicationType === '非处方药' ? 'selected' : ''}>非处方药</option>
                                    <option value="保健品/营养补剂" ${record.medicationType === '保健品/营养补剂' ? 'selected' : ''}>保健品/营养补剂</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.reason || ''}" data-index="${index}" data-field="reason"></td>
                            <td><input type="text" value="${record.dosage || ''}" data-index="${index}" data-field="dosage"></td>
                            <td><input type="text" value="${record.frequency || ''}" data-index="${index}" data-field="frequency"></td>
                            <td><button type="button" class="btn btn-secondary remove-medication" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-medication').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeMedicationHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#medicationHistoryContainer select, #medicationHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateMedicationHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加用药史记录
            addMedicationHistoryRecord() {
                if (!this.currentCustomer.medicationHistory) {
                    this.currentCustomer.medicationHistory = [];
                }
                
                this.currentCustomer.medicationHistory.push({
                    medicationName: '',
                    medicationType: '处方药',
                    reason: '',
                    dosage: '',
                    frequency: ''
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 删除用药史记录
            removeMedicationHistoryRecord(index) {
                this.currentCustomer.medicationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 更新用药史记录
            updateMedicationHistoryRecord(index, field, value) {
                if (!this.currentCustomer.medicationHistory) {
                    this.currentCustomer.medicationHistory = [];
                }
                this.currentCustomer.medicationHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // 渲染既往病史表格
            renderPastMedicalHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>疾病/状况名称</th><th>记录类型</th><th>详情</th><th>诊断/发生日期</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.conditionName || ''}" data-index="${index}" data-field="conditionName"></td>
                            <td>
                                <select data-index="${index}" data-field="recordType">
                                    <option value="慢性病" ${record.recordType === '慢性病' ? 'selected' : ''}>慢性病</option>
                                    <option value="急性病" ${record.recordType === '急性病' ? 'selected' : ''}>急性病</option>
                                    <option value="手术" ${record.recordType === '手术' ? 'selected' : ''}>手术</option>
                                    <option value="住院" ${record.recordType === '住院' ? 'selected' : ''}>住院</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.currentStatus || ''}" data-index="${index}" data-field="record.currentStatus"></td>
                            <td><input type="date" value="${record.diagnosisDate || ''}" data-index="${index}" data-field="diagnosisDate"></td>
                            <td><button type="button" class="btn btn-secondary remove-past-medical" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-past-medical').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removePastMedicalHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#pastMedicalHistoryContainer select, #pastMedicalHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updatePastMedicalHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加既往病史记录
            addPastMedicalHistoryRecord() {
                if (!this.currentCustomer.pastMedicalHistory) {
                    this.currentCustomer.pastMedicalHistory = [];
                }
                
                this.currentCustomer.pastMedicalHistory.push({
                    conditionName: '',
                    recordType: '慢性病',
                    currentStatus: '活动性',
                    diagnosisDate: new Date().toISOString().split('T')[0]
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 删除既往病史记录
            removePastMedicalHistoryRecord(index) {
                this.currentCustomer.pastMedicalHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 更新既往病史记录
            updatePastMedicalHistoryRecord(index, field, value) {
                if (!this.currentCustomer.pastMedicalHistory) {
                    this.currentCustomer.pastMedicalHistory = [];
                }
                this.currentCustomer.pastMedicalHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // 渲染手术与住院史表格
            renderSurgeryHospitalizationHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>事件名称</th><th>事件类型</th><th>发生日期</th><th>结果与影响</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.eventName || ''}" data-index="${index}" data-field="eventName"></td>
                            <td>
                                <select data-index="${index}" data-field="eventType">
                                    <option value="手术" ${record.eventType === '手术' ? 'selected' : ''}>手术</option>
                                    <option value="住院" ${record.eventType === '住院' ? 'selected' : ''}>住院</option>
                                    <option value="体检" ${record.eventType === '体检' ? 'selected' : ''}>体检</option>
                                </select>
                            </td>
                            <td><input type="date" value="${record.eventDate || ''}" data-index="${index}" data-field="eventDate"></td>
                            <td><textarea data-index="${index}" data-field="result" rows="2">${record.result || ''}</textarea></td>
                            <td><button type="button" class="btn btn-secondary remove-surgery" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-surgery').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeSurgeryHospitalizationHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#surgeryHospitalizationHistoryContainer select, #surgeryHospitalizationHistoryContainer input, #surgeryHospitalizationHistoryContainer textarea').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateSurgeryHospitalizationHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加手术与住院史记录
            addSurgeryHospitalizationHistoryRecord() {
                if (!this.currentCustomer.surgeryHospitalizationHistory) {
                    this.currentCustomer.surgeryHospitalizationHistory = [];
                }
                
                this.currentCustomer.surgeryHospitalizationHistory.push({
                    eventName: '',
                    eventType: '手术',
                    eventDate: new Date().toISOString().split('T')[0],
                    result: ''
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 删除手术与住院史记录
            removeSurgeryHospitalizationHistoryRecord(index) {
                this.currentCustomer.surgeryHospitalizationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 更新手术与住院史记录
            updateSurgeryHospitalizationHistoryRecord(index, field, value) {
                if (!this.currentCustomer.surgeryHospitalizationHistory) {
                    this.currentCustomer.surgeryHospitalizationHistory = [];
                }
                this.currentCustomer.surgeryHospitalizationHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // 渲染疫苗接种史表格
            renderVaccinationHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>疫苗名称</th><th>接种日期</th><th>备注</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.vaccineName || ''}" data-index="${index}" data-field="vaccineName"></td>
                            <td><input type="date" value="${record.vaccinationDate || ''}" data-index="${index}" data-field="vaccinationDate"></td>
                            <td><input type="text" value="${record.notes || ''}" data-index="${index}" data-field="notes"></td>
                            <td><button type="button" class="btn btn-secondary remove-vaccination" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-vaccination').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeVaccinationHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#vaccinationHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateVaccinationHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加疫苗接种史记录
            addVaccinationHistoryRecord() {
                if (!this.currentCustomer.vaccinationHistory) {
                    this.currentCustomer.vaccinationHistory = [];
                }
                
                this.currentCustomer.vaccinationHistory.push({
                    vaccineName: '',
                    vaccinationDate: new Date().toISOString().split('T')[0],
                    notes: ''
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 删除疫苗接种史记录
            removeVaccinationHistoryRecord(index) {
                this.currentCustomer.vaccinationHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 更新疫苗接种史记录
            updateVaccinationHistoryRecord(index, field, value) {
                if (!this.currentCustomer.vaccinationHistory) {
                    this.currentCustomer.vaccinationHistory = [];
                }
                this.currentCustomer.vaccinationHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // 渲染家族病史表格
            renderFamilyHistoryTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>亲属关系</th><th>疾病/状况名称</th><th>发病年龄</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td>
                                <select data-index="${index}" data-field="relationship">
                                    <option value="父母" ${record.relationship === '父母' ? 'selected' : ''}>父母</option>
                                    <option value="兄弟姐妹" ${record.relationship === '兄弟姐妹' ? 'selected' : ''}>兄弟姐妹</option>
                                    <option value="子女" ${record.relationship === '子女' ? 'selected' : ''}>子女</option>
                                    <option value="祖父母" ${record.relationship === '祖父母' ? 'selected' : ''}>祖父母</option>
                                    <option value="其他" ${record.relationship === '其他' ? 'selected' : ''}>其他</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.condition || ''}" data-index="${index}" data-field="condition"></td>
                            <td><input type="number" value="${record.onsetAge || ''}" data-index="${index}" data-field="onsetAge"></td>
                            <td><button type="button" class="btn btn-secondary remove-family" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-family').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeFamilyHistoryRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#familyHistoryContainer select, #familyHistoryContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateFamilyHistoryRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加家族病史记录
            addFamilyHistoryRecord() {
                if (!this.currentCustomer.familyHistory) {
                    this.currentCustomer.familyHistory = [];
                }
                
                this.currentCustomer.familyHistory.push({
                    relationship: '父母',
                    condition: '',
                    onsetAge: ''
                });
                
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 删除家族病史记录
            removeFamilyHistoryRecord(index) {
                this.currentCustomer.familyHistory.splice(index, 1);
                this.renderPersonalInfoForm(this.currentCustomer);
                this.autoSavePersonalInfo();
            },

            // 更新家族病史记录
            updateFamilyHistoryRecord(index, field, value) {
                if (!this.currentCustomer.familyHistory) {
                    this.currentCustomer.familyHistory = [];
                }
                this.currentCustomer.familyHistory[index][field] = value;
                this.autoSavePersonalInfo();
            },

            // ========== 账期信息表格相关方法 ==========

            // 渲染膳食习惯表格
            renderDietaryHabitsTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>主类型</th><th>子类型</th><th>备注</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td>
                                <select data-index="${index}" data-field="mainType">
                                    <option value="常规饮食" ${record.mainType === '常规饮食' ? 'selected' : ''}>常规饮食</option>
                                    <option value="特殊饮食" ${record.mainType === '特殊饮食' ? 'selected' : ''}>特殊饮食</option>
                                    <option value="饮食偏好" ${record.mainType === '饮食偏好' ? 'selected' : ''}>饮食偏好</option>
                                    <option value="饮食限制" ${record.mainType === '饮食限制' ? 'selected' : ''}>饮食限制</option>
                                </select>
                            </td>
                            <td><input type="text" value="${record.subType || ''}" data-index="${index}" data-field="subType"></td>
                            <td><textarea data-index="${index}" data-field="notes" rows="2">${record.notes || ''}</textarea></td>
                            <td><button type="button" class="btn btn-secondary remove-dietary" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-dietary').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeDietaryHabitsRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#dietaryHabitsContainer select, #dietaryHabitsContainer input, #dietaryHabitsContainer textarea').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateDietaryHabitsRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加膳食习惯记录
            addDietaryHabitsRecord() {
                if (!this.currentPeriod.dietaryHabits) {
                    this.currentPeriod.dietaryHabits = [];
                }
                
                this.currentPeriod.dietaryHabits.push({
                    mainType: '常规饮食',
                    subType: '',
                    notes: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // 删除膳食习惯记录
            removeDietaryHabitsRecord(index) {
                this.currentPeriod.dietaryHabits.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // 更新膳食习惯记录
            updateDietaryHabitsRecord(index, field, value) {
                if (!this.currentPeriod.dietaryHabits) {
                    this.currentPeriod.dietaryHabits = [];
                }
                this.currentPeriod.dietaryHabits[index][field] = value;
                this.autoSavePeriodInfo();
            },

            // 渲染身体活动表格
            renderPhysicalActivityTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>运动类型</th><th>频率</th><th>时长和强度</th><th>日常活动水平与久坐时间</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.exerciseType || ''}" data-index="${index}" data-field="exerciseType"></td>
                            <td><input type="text" value="${record.frequency || ''}" data-index="${index}" data-field="frequency"></td>
                            <td><input type="text" value="${record.durationIntensity || ''}" data-index="${index}" data-field="durationIntensity"></td>
                            <td><input type="text" value="${record.dailyActivity || ''}" data-index="${index}" data-field="dailyActivity"></td>
                            <td><button type="button" class="btn btn-secondary remove-physical" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-physical').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removePhysicalActivityRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#physicalActivityContainer input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updatePhysicalActivityRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加身体活动记录
            addPhysicalActivityRecord() {
                if (!this.currentPeriod.physicalActivity) {
                    this.currentPeriod.physicalActivity = [];
                }
                
                this.currentPeriod.physicalActivity.push({
                    exerciseType: '',
                    frequency: '',
                    durationIntensity: '',
                    dailyActivity: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // 删除身体活动记录
            removePhysicalActivityRecord(index) {
                this.currentPeriod.physicalActivity.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // 更新身体活动记录
            updatePhysicalActivityRecord(index, field, value) {
                if (!this.currentPeriod.physicalActivity) {
                    this.currentPeriod.physicalActivity = [];
                }
                this.currentPeriod.physicalActivity[index][field] = value;
                this.autoSavePeriodInfo();
            },

            // 渲染睡眠模式表格
            renderSleepPatternTable(records) {
                if (records.length === 0) {
                    return '';
                }

                let html = '<table style="width: 100%; margin-bottom: 10px;"><thead><tr><th>整体睡眠状况</th><th>主观睡眠问题</th><th>操作</th></tr></thead><tbody>';
                
                records.forEach((record, index) => {
                    html += `
                        <tr>
                            <td><input type="text" value="${record.sleepStatus || ''}" data-index="${index}" data-field="sleepStatus"></td>
                            <td><textarea data-index="${index}" data-field="subjectiveProblems" rows="2">${record.subjectiveProblems || ''}</textarea></td>
                            <td><button type="button" class="btn btn-secondary remove-sleep" data-index="${index}">删除</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                
                // 绑定事件
                setTimeout(() => {
                    document.querySelectorAll('.remove-sleep').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            this.removeSleepPatternRecord(index);
                        });
                    });
                    
                    document.querySelectorAll('#sleepPatternContainer input, #sleepPatternContainer textarea').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'));
                            const field = e.target.getAttribute('data-field');
                            this.updateSleepPatternRecord(index, field, e.target.value);
                        });
                    });
                }, 0);
                
                return html;
            },

            // 添加睡眠模式记录
            addSleepPatternRecord() {
                if (!this.currentPeriod.sleepPattern) {
                    this.currentPeriod.sleepPattern = [];
                }
                
                this.currentPeriod.sleepPattern.push({
                    sleepStatus: '',
                    subjectiveProblems: ''
                });
                
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // 删除睡眠模式记录
            removeSleepPatternRecord(index) {
                this.currentPeriod.sleepPattern.splice(index, 1);
                this.renderPeriodForm(this.currentPeriod);
                this.autoSavePeriodInfo();
            },

            // 更新睡眠模式记录
            updateSleepPatternRecord(index, field, value) {
                if (!this.currentPeriod.sleepPattern) {
                    this.currentPeriod.sleepPattern = [];
                }
                this.currentPeriod.sleepPattern[index][field] = value;
                this.autoSavePeriodInfo();
            }
        };

        // ================= 全局自动缩放引擎 =================
        function autoScalePage() {
            const designWidth = 1400; // 设计基准宽度
            const windowWidth = window.innerWidth;
            
            // 核心修改：只有当窗口比设计宽度“小”的时候，才进行缩放
            // 如果窗口很大，就保持原样 (zoom = 1)，让 CSS 布局自然铺满
            if (windowWidth < designWidth) {
                let scale = windowWidth / designWidth;
                document.body.style.zoom = scale;
            } else {
                document.body.style.zoom = 1; // 大屏不缩放
            }
        }

        window.addEventListener('resize', autoScalePage);
        window.addEventListener('load', autoScalePage);
        // ==========================================================
        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            ViewController.init();
        });
    // ================= 权限控制模块 =================
        const AuthController = {
            currentUser: null,

            async checkPermission() {
                try {
                    // 询问后端：我是谁？
                    const response = await fetch('/api/me');
                    if (response.ok) {
                        this.currentUser = await response.json();
                        console.log('当前用户:', this.currentUser.username, '角色:', this.currentUser.role);
                        
                        // 如果是仅阅读(reader)角色，执行“阉割”操作
                        if (this.currentUser.role === 'reader') {
                            this.disableEditingFeatures();
                        }
                    }
                } catch (error) {
                    console.error('权限检查失败:', error);
                }
            },

            disableEditingFeatures() {
                // 1. 注入一段CSS，把所有“危险按钮”隐藏掉
                const style = document.createElement('style');
                style.innerHTML = `
                    /* 隐藏所有添加、保存、删除、编辑按钮 */
                    button.btn-primary, 
                    button.btn-success, 
                    button.btn-danger, 
                    button.btn-warning,
                    .add-record-btn,
                    .add-icon,
                    .remove-indicator,
                    .remove-communication,
                    .remove-followup,
                    .remove-allergy,
                    .remove-medication,
                    .remove-past-medical,
                    .remove-surgery,
                    .remove-vaccination,
                    .remove-family,
                    .remove-dietary,
                    .remove-physical,
                    .remove-sleep,
                    .save-icon,
                    #importBtn,
                    #resetBtn {
                        display: none !important;
                    }
                    
                    /* 恢复必要的导航和搜索按钮 */
                    #searchConfirmBtn, 
                    #exportDataBtn,
                    #exportWordBtn,
                    #exportExcelBtn,
                    .nav-tab,
                    .page-btn {
                        display: inline-block !important;
                    }
                    
                    /* 让输入框变成只读 (视觉上) */
                    input, textarea, select {
                        pointer-events: none;
                        background-color: #f9f9f9;
                    }
                    /* 恢复搜索框的可编辑性 */
                    .search-filter input {
                        pointer-events: auto;
                        background-color: white;
                    }
                `;
                document.head.appendChild(style);
                
                // 2. 额外的提示
                const header = document.querySelector('header .header-content');
                const badge = document.createElement('div');
                badge.style.cssText = "background: #ffc107; color: #333; padding: 5px 10px; border-radius: 4px; font-weight: bold; margin-left: 10px;";
                badge.innerText = "👀 访客模式 (仅阅读)";
                header.appendChild(badge);
            }
        };

        // 修改初始化逻辑，先检查权限
        const originalInit = ViewController.init;
        ViewController.init = async function() {
            await originalInit.call(this); // 先执行原有的初始化
            await AuthController.checkPermission(); // 再执行权限检查
        };
        // ================= 权限模块结束 =================
    </script>
</body>
</html>